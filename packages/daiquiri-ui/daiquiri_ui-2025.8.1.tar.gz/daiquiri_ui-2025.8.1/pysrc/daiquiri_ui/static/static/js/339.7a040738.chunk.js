"use strict";(self.webpackChunkdaiquiri_ui=self.webpackChunkdaiquiri_ui||[]).push([[339],{42506:(e,t,n)=>{n.d(t,{H:()=>u,P:()=>d});var r=n(20837),a=n(70775),i=n(15568),o=n(26799),s=n(69521);const c={sx:0,sy:0,centerX:0,centerY:0,matrix:(new i.Matrix4).identity()},l=(0,r.createContext)(null);function d(){const e=(0,r.useContext)(l);if(!e)throw new Error("No LinearVisGroup context are avaialble");return e.current}function u(e){const t=(0,r.useRef)(c),{children:n}=e,{abscissaConfig:i,ordinateConfig:d,visSize:u}=(0,a.ki)(),{width:p,height:m}=u,{scaleType:h=a.N3.Linear}=i,{scaleType:f=a.N3.Linear}=d;if(h!==a.N3.Linear||f!==a.N3.Linear)throw new Error("VisGroup supports only linear axes");(0,o.C)((e=>{let{camera:n}=e;const r=(i.flip?-1:1)*p/(i.visDomain[1]-i.visDomain[0]),a=(d.flip?-1:1)*m/(d.visDomain[1]-d.visDomain[0]),o=.5*(i.visDomain[0]+i.visDomain[1]),s=.5*(d.visDomain[0]+d.visDomain[1]);t.current.sx=r,t.current.sy=a,t.current.centerX=o,t.current.centerY=s,t.current.matrix=t.current.matrix.makeScale(r,a,0)}),-100);const v=(i.flip?-1:1)*p/(i.visDomain[1]-i.visDomain[0]),g=(d.flip?-1:1)*m/(d.visDomain[1]-d.visDomain[0]),x=.5*(i.visDomain[0]+i.visDomain[1]),y=.5*(d.visDomain[0]+d.visDomain[1]);return t.current.sx=v,t.current.sy=g,t.current.centerX=x,t.current.centerY=y,t.current.matrix=t.current.matrix.makeScale(v,g,0),(0,s.jsx)(l.Provider,{value:t,children:(0,s.jsx)("group",{position:[-x*v,-y*g,0],scale:[v,g,1],children:n})})}},25263:(e,t,n)=>{function r(e){const t=(31744&e)>>10,n=1023&e;return(e>>15?-1:1)*(t?31===t?n?Number.NaN:1/0:2**(t-15)*(1+n/1024):n/1024*6103515625e-14)}n.d(t,{S:()=>a,m:()=>r});class a{constructor(e,t){if(this.shape=void 0,this.dimension=void 0,this.data=void 0,this.dtype=void 0,2!==t.length)throw new Error(`Unsupported dimension ${t.length} with NdFloat16Array`);this.data=e,this.shape=t,this.dimension=t.length,this.dtype="float16"}index(){if(arguments.length!==this.dimension)throw new Error(`Expected ${this.dimension} for indexing`);return(arguments.length<=1?void 0:arguments[1])+(arguments.length<=0?void 0:arguments[0])*this.shape[1]}getRaw(){const e=this.index(...arguments);return this.data[e]}get(){return r(this.getRaw(...arguments))}}},43674:(e,t,n)=>{n.d(t,{G:()=>a});var r=n(70775);class a{constructor(e,t,n){if(this.shape=void 0,this.dimension=void 0,this.data=void 0,this.dtype=void 0,this.transfer=void 0,2!==t.length)throw new Error(`Unsupported dimension ${t.length} with NdNormalizedUint8Array`);this.data=e,this.transfer=n,this.shape=t,this.dimension=t.length,this.dtype="uint8"}index(){if(arguments.length!==this.dimension)throw new Error(`Expected ${this.dimension} for indexing`);return(arguments.length<=1?void 0:arguments[1])+(arguments.length<=0?void 0:arguments[0])*this.shape[1]}getRaw(){const e=this.index(...arguments);return this.data[e]}get(){const e=this.getRaw(...arguments),{min:t,max:n,normalization:a}=this.transfer,i=e*(n-t)/255+t;switch(a){case r.N3.Linear:return i;case r.N3.Log:return Math.exp(i);case r.N3.Sqrt:return i**2;default:return Number.NaN}}}},18680:(e,t,n)=>{n.d(t,{Z:()=>i});var r=n(70775),a=n(20837);const i=function(e){const{onClick:t,threshold:n=4}=e,{worldToData:i}=(0,r.ki)(),[o,s]=(0,a.useState)(null),c=(0,a.useCallback)((e=>{const{htmlPt:t}=e;s(t)}),[s]),l=(0,a.useCallback)((e=>{if(!o)return!1;const{htmlPt:t}=e;return Math.max(Math.abs(t.x-o.x),Math.abs(t.y-o.y))<=n}),[o,n]),d=(0,a.useCallback)((e=>{l(e)||s(null)}),[l,s]),u=(0,a.useCallback)((e=>{l(e)&&t(e)}),[l,t,t,i]);return(0,r.iq)("pointerdown",c),(0,r.iq)("pointermove",d),(0,r.iq)("pointerup",u),null}},30852:(e,t,n)=>{n.d(t,{Z:()=>s});var r=n(60882),a=n(19097),i=n(26799),o=n(48542);const s=function(e){const{viewpoint:t,setViewpoint:n}=e,s=(0,i.A)((e=>e.camera)),c=(0,i.A)((e=>e.invalidate)),l=(0,o.oA)(),d=(0,o.Hl)();return(0,r.n)((()=>{if(!t)return;const{position:e,scale:n}=d(t);s.position.copy(e),s.scale.copy(n),s.updateMatrixWorld(),c()})),(0,a.z)((()=>{n(l())})),null}},94117:(e,t,n)=>{n.d(t,{V:()=>a});n(20837);var r=n(15568);function a(e,t){if("string"===typeof e){if(""===e)return new r.Vector4(0,0,0,0);if("transparent"===e)return new r.Vector4(0,0,0,0);if(e.startsWith("#")&&9===e.length){const n=Number(`0x${e.slice(1,3)}`)/255,a=Number(`0x${e.slice(3,5)}`)/255,i=Number(`0x${e.slice(5,7)}`)/255,o=Number(`0x${e.slice(7,9)}`)/255;return new r.Vector4(n,a,i,o*(null!==t&&void 0!==t?t:1))}}const n=new r.Color(e);return new r.Vector4(n.r,n.g,n.b,null!==t&&void 0!==t?t:1)}},48542:(e,t,n)=>{n.d(t,{Hl:()=>u,I5:()=>d,oA:()=>p,rB:()=>m});var r=n(70775),a=n(96956),i=n(20837),o=n(26799),s=n(15568),c=n(43285),l=n(84009);function d(e){return(0,i.useMemo)((()=>(0,l.Rj)(e)),[e])}function u(){const e=(0,o.A)((e=>e.camera)),{dataToWorld:t,abscissaConfig:n,ordinateConfig:a,visSize:c}=(0,r.ki)(),{width:l,height:d}=c;return(0,i.useCallback)((r=>{const{center:i,scale:o}=r,c=t(i),u=o.x*l/Math.abs(n.visDomain[1]-n.visDomain[0]),p=o.y*d/Math.abs(a.visDomain[1]-a.visDomain[0]);return{position:new s.Vector3(c.x,c.y,e.position.z),scale:new s.Vector3(u,p,e.scale.z)}}),[e,t,n,a,l,d])}function p(){const{width:e,height:t}=(0,o.A)((e=>e.size)),n=(0,o.A)((e=>e.camera)),{getVisibleDomains:i}=(0,r.ki)();return()=>{const{xVisibleDomain:r,yVisibleDomain:o}=i(n);return{center:new s.Vector3((0,a.sum)(r),(0,a.sum)(o)).multiplyScalar(.5),scale:new s.Vector3(Math.abs(r[1]-r[0])/e,Math.abs(o[1]-o[0])/t,1)}}}function m(){return(0,c.Z)(void 0,{behavior:"destroyFuture",historyLimit:50,ignoreIdenticalMutations:!0})}},17332:(e,t,n)=>{n.d(t,{Z:()=>c});var r=n(70775),a=n(84009),i=n(20837),o=n(69521);function s(e){const t=function(e){const t=/^#([\da-f]{2})([\da-f]{2})([\da-f]{2})$/gis.exec(e);return null===t?null:[Number.parseInt(t[1],16),Number.parseInt(t[2],16),Number.parseInt(t[3],16)]}(e);if(null===t)return;return.299*t[0]+.587*t[1]+.114*t[2]>128?"#00000080":"#FFFFFF80"}function c(e){const{vmargin:t=5,hmargin:n=5,anchor:c="text-right",color:l="black"}=e,d=(0,i.useMemo)((()=>{var t;return null!==(t=e.outline)&&void 0!==t?t:s(l)}),[e.outline]),u=(0,a.d4)(e.datapos);const p=function(){switch(c){case"bottom":return{top:"50%",left:"50%",position:"relative",transform:"translate(-100%, -100%)"};case"top":return{top:"50%",left:"50%",position:"relative",transform:"translate(-100%, 0%)"};case"top-right":return{marginLeft:n,marginTop:t};case"text-right":return{top:"50%",position:"relative",transform:"translate(0%, -100%)",marginLeft:n,marginTop:t};case"center":return{top:"50%",left:"50%",position:"relative",transform:"translate(-100%, -50%)"}}return{}}();return(0,o.jsx)(r.q6,{x:u.x,y:u.y,style:{color:l},children:(0,o.jsx)("div",{style:{...p,borderRadius:5,paddingLeft:5,paddingRight:5,backgroundColor:d,fontWeight:"bold",fontSize:"100%",zIndex:100},children:e.text})})}},30:(e,t,n)=>{n.d(t,{z:()=>l});var r=n(20837),a=n(40714),i=n(70775),o=n(37185),s=n(21681);var c=n(69521);function l(e){const[t,n]=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const[r,a]=(0,s.F)(e);return[r,(0,o.y)(a,[],t,n)]}({loading:e.loading,info:e.info,warning:e.warning,danger:e.danger},500);return(0,r.useEffect)((()=>{n({loading:e.loading,warning:e.warning,danger:e.danger,info:e.info})}),[e.loading,e.info,e.warning,e.danger]),t.loading||t.danger||t.warning||t.info?(0,c.jsx)(i.aV,{style:{zIndex:200},children:(0,c.jsxs)("div",{style:{textAlign:"center"},children:[t.loading&&(0,c.jsxs)(a.Z,{variant:"warning",style:{marginLeft:"auto",marginRight:"auto",marginTop:"2em",display:"inline-block"},children:[(0,c.jsx)("i",{className:"fa fa-spinner fa-solid fa-pulse"})," Loading"]}),!t.loading&&t.danger&&(0,c.jsx)(a.Z,{variant:"danger",style:{marginLeft:"auto",marginRight:"auto",marginTop:"2em",display:"inline-block"},children:t.danger}),!t.loading&&!t.danger&&t.warning&&(0,c.jsx)(a.Z,{variant:"warning",style:{marginLeft:"auto",marginRight:"auto",marginTop:"2em",display:"inline-block"},children:t.warning}),t.info&&(0,c.jsx)(a.Z,{variant:"info",style:{marginLeft:"auto",marginRight:"auto",marginTop:"2em",display:"inline-block"},children:t.info})]})}):(0,c.jsx)(c.Fragment,{})}},94443:(e,t,n)=>{n.d(t,{b:()=>s});var r=n(20837),a=n(26799),i=n(42506),o=n(69521);const s=r.forwardRef(((e,t)=>{const{scaleX:n=!0,scaleY:s=!0,screenDirection:c=!0,children:l}=e,d=r.useRef(null);r.useImperativeHandle(t,(()=>d.current),[]);const u=(0,i.P)();return(0,a.C)((e=>{let{camera:t}=e;const r=d.current;if(!r)return;const a=t.scale.x/u.sx,i=t.scale.y/u.sy;n&&(r.scale.x=c?a:Math.abs(a)),s&&(r.scale.y=c?-i:Math.abs(i))})),(0,o.jsx)("group",{ref:d,children:l})}))},45874:(e,t,n)=>{n.d(t,{i:()=>d});var r=n(26799),a=n(20837),i=n(15568),o=n(94117),s=n(94443),c=n(69521);class l extends i.ShaderMaterial{constructor(){super({uniforms:{color:{value:new i.Vector4},lineWidth:{value:0},sizeInScreen:{value:0}},vertexShader:"\nout vec2 pixelCoord;\n\nvoid main() {\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    pixelCoord = vec2(position.x, position.y);\n}\n      ",fragmentShader:"\nuniform vec4 color;\nuniform float lineWidth;\nuniform float sizeInScreen;\nin vec2 pixelCoord;\n\n/**\n * Exact signed distance function to compute an\n * orthogonal rectangle.\n *\n * @param pos: Pixel position\n * @param center: Center of the rectangle\n * @param size: Size of the rectangle\n */\nfloat sdf_rect(vec2 pos, vec2 center, vec2 size) {\n    vec2 d = abs(pos - center) - size * 0.5;\n    return length(max(d, 0.0)) + min(max(d.x, d.y), 0.0);\n}\n\nvoid main() {\n  float d1 = sdf_rect(\n    pixelCoord,\n    vec2(0.0, 0.0),\n    vec2(abs(sizeInScreen), lineWidth)\n  );\n  float d2 = sdf_rect(\n    pixelCoord,\n    vec2(0.0, 0.0),\n    vec2(lineWidth, abs(sizeInScreen))\n  );\n  float d = min(d1, d2);\n\n  if (d > 0.2) {\n    discard;\n  }\n\n  float alpha;\n  if (lineWidth >= 1.0) {\n    alpha = smoothstep(0.2, 0.0, d);\n  } else {\n    // simulate line thiner than 1px with alpha\n    alpha = lineWidth;\n  }\n\n  gl_FragColor = vec4(color.r, color.g, color.b, alpha * color.a);\n}\n      "})}}function d(e){const{x:t,y:n,color:i="black",opacity:l,sizeInScreen:d,lineWidth:u=1,zIndex:p=0}=e,m=(0,a.useRef)(null);return(0,a.useEffect)((()=>{const e=(0,o.V)(i,l);if(m.current){const t=m.current.uniforms;t.color.value=e,t.lineWidth.value=u,t.sizeInScreen.value=d,(0,r.l)()}}),[i,l,u,d]),(0,c.jsx)("group",{position:[t,n,p],children:(0,c.jsx)(s.b,{children:(0,c.jsxs)("mesh",{children:[(0,c.jsx)("ambientLight",{}),(0,c.jsx)("planeGeometry",{attach:"geometry",args:[d+u,d+u,1,1]}),(0,c.jsx)("crossMarkerMaterial",{attach:"material",transparent:!0,ref:m})]})})})}(0,r.e)({CrossMarkerMaterial:l})},84009:(e,t,n)=>{n.d(t,{RC:()=>p,Rj:()=>l,Us:()=>c,d4:()=>d,pi:()=>m});var r=n(70775),a=n(96956),i=n(15568),o=n(25263),s=n(43674);function c(e){return"string"===typeof(t=e)&&Object.values(r.N3).includes(t)?e:e[0];var t}function l(e){const{values:t,bins:n}=e,r=t.findIndex((e=>0!==e));if(-1===r)return{...e,values:new Float64Array,bins:new Float64Array};const i=(0,a.findLastIndex)(t,(e=>0!==e))+1;return 0===r&&i===t.length?e:{...e,values:t.slice(r,i),bins:n.slice(r,i+1)}}function d(e){return(t=e)instanceof Object&&"y"in t?e:new i.Vector2(e[0],e[1]);var t}function u(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-5,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e-8;return Math.abs(e-t)<=r+n*Math.abs(t)}function p(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-5,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e-8;return u(e.x,t.x,n,r)&&u(e.y,t.y,n,r)&&u(e.z,t.z,n,r)}function m(e){if(void 0!==e){if(2!==e.dimension)throw new Error("A 2d array is expected");e instanceof s.G||e instanceof o.S||function(e){if(e.constructore===Float32Array)throw new Error("A Float32Array is expected")}(e.data)}}},62294:(e,t,n)=>{n.d(t,{Z:()=>i,m:()=>o});var r=n(70775),a=n(71980);const i=(0,a.Ue)((e=>({selectedSampleActionId:void 0,setSelectedSampleActionId:t=>e({selectedSampleActionId:t}),selectedSampleActionHasResult:!1,setSelectedSampleActionHasResult:t=>e({selectedSampleActionHasResult:t}),cameraViewport:void 0,setCameraViewport:t=>e({cameraViewport:t})}))),o=(0,a.Ue)((e=>({currentAction:"pan",setCurrentAction:t=>e({currentAction:t}),customDomain:[0,254],setCustomDomain:t=>e({customDomain:t}),scaleType:r.N3.Linear,setScaleType:t=>e({scaleType:t}),colorMap:"Viridis",setColorMap:t=>e({colorMap:t}),invertColorMap:!1,setInvertColorMap:t=>e({invertColorMap:t}),doMove:!0,setDoMove:t=>e({doMove:t}),visibleDomain:{xVisibleDomain:[0,0],yVisibleDomain:[0,0]},setVisibleDomain:t=>e({visibleDomain:t})})))},7339:(e,t,n)=>{n.r(t),n.d(t,{default:()=>be});var r=n(52799),a=n(57209),i=n(45425),o=n(94937),s=n(67619),c=n(20837),l=n(89572),d=n(52547),u=n(51299),p=n(87095),m=n(98844),h=n(75886),f=n(62294),v=n(69521);function g(e){let{sampleactionpositionid:t}=e;const{fetch:n}=(0,d.Z)();return(0,v.jsx)(h.Z,{id:t,onClick:()=>{n(p.p.delete,{sampleactionpositionid:t})},confirm:!0,show:!0})}function x(e,t){return t.sampleactionpositionid&&(0,v.jsx)(g,{sampleactionpositionid:t.sampleactionpositionid})}function y(){const{selectedSampleActionId:e}=(0,f.Z)(),t=(0,u.Z)(p.p.getList,e?{sampleactionid:e}:null),n=[{dataField:"id",text:"#"},{dataField:"type",text:"Type"},{dataField:"posx",text:"X"},{dataField:"posy",text:"Y"},{dataField:"",text:"",formatter:x,classes:"text-end"}];return(0,v.jsx)(v.Fragment,{children:(0,v.jsx)(m.Z,{keyField:"sampleactionpositionid",data:t.rows||[],columns:n,noDataIndication:"No reference positions",overlay:!0})})}var w=n(18578),b=n(73809),j=n(81542);class S extends b.Z{constructor(){super(...arguments),this.sampleactionid=void 0,this.has_result=!1}pk(){var e;return null===(e=this.sampleactionid)||void 0===e?void 0:e.toString()}static get key(){return"SampleAction"}}const C=(0,j.Z)({path:"/metadata/samples/actions/:sampleactionid",schema:S});var A=n(48822),k=n(51366);function D(e){let{path:t,schema:n}=e;return(0,A.Z)({path:t,schema:n,Endpoint:k.T})}class M extends b.Z{constructor(){super(...arguments),this.matrixid=void 0,this.sampleactionid=0}pk(){var e;return null===(e=this.matrixid)||void 0===e?void 0:e.toString()}static get key(){return"SetReferenceMatrix"}}const F=D({path:"/imageviewer/move/reference/matrix/:matrixid",schema:M});class N extends b.Z{constructor(){super(...arguments),this.exportid=void 0,this.sampleactionid=0,this.crop={}}pk(){var e;return null===(e=this.exportid)||void 0===e?void 0:e.toString()}static get key(){return"ExportToSampleImage"}}const Z=D({path:"/imageviewer/reference/export/:exportid",schema:N});var I=n(95086),z=n(15959);let E=function(e){return e.error="error",e.warning="warning",e.success="success",e.info="info",e}({});function T(e){let{sampleactionid:t,addToast:n}=e;const{visibleDomain:r}=(0,f.m)(),{fetch:a}=(0,d.Z)(),[i,o]=(0,c.useState)(!1),[s,l]=(0,c.useState)(!1),u=(0,c.useCallback)((async()=>{o(!0);try{await a(F.create,{sampleactionid:t}),n({type:E.success,title:"Matrix calculated",text:"Transformation matrix successfully calculated"})}catch(e){const t=await e.response.json();n({type:E.error,title:"Couldn't calculate matrix",text:t.error})}o(!1)}),[t]),p=(0,c.useCallback)((async()=>{l(!0);try{await a(Z.create,{sampleactionid:t,crop:{x:r.xVisibleDomain.map((e=>Math.max(0,Math.round(e)))),y:r.yVisibleDomain.map((e=>Math.max(0,Math.round(e))))}}),n({type:E.success,title:"Reference Exported",text:"Exported reference to sample image"})}catch(e){const t=await e.response.json();n({type:E.error,title:"Couldn't export reference to sample image",text:t.error})}l(!1)}),[t]);return(0,v.jsxs)(v.Fragment,{children:[(0,v.jsx)(z.Z,{tooltip:"Select this reference for coordinate transform",children:(0,v.jsxs)(w.Z,{size:"sm",onClick:()=>{u()},disabled:i,children:[i&&(0,v.jsx)("i",{className:"fa fa-spinner fa-spin"}),!i&&(0,v.jsx)("i",{className:"fa fa-th"})]})}),(0,v.jsx)(z.Z,{tooltip:"Export this image transform to the 2d view",children:(0,v.jsxs)(w.Z,{size:"sm",onClick:()=>{p()},className:"ms-1",disabled:s,children:[s&&(0,v.jsx)("i",{className:"fa fa-spinner fa-spin"}),!s&&(0,v.jsx)("i",{className:"fa fa-file-export"})]})})]})}function R(e,t,n,r){return(0,v.jsx)(v.Fragment,{children:t.has_result&&(0,v.jsx)(T,{...t,...r})})}function V(e){let{sampleid:t,addToast:n}=e;const{selectedSampleActionId:r,setSelectedSampleActionId:a,setSelectedSampleActionHasResult:i}=(0,f.Z)(),o=(0,u.Z)(C.getList,{actiontype:"reference",...t?{sampleid:t}:null}),s=[{dataField:"sampleactionid",text:"Id"},{dataField:"status",text:"Status"},{dataField:"message",text:"Message",classes:"text-break"},{dataField:"has_result",text:"Image",formatter:(e,t)=>t.has_result?"Yes":"No"},{text:"",dataField:"",formatter:R,classes:"text-end text-nowrap",formatExtraData:{addToast:n}}];return(0,v.jsx)(v.Fragment,{children:(0,v.jsx)(I.Z,{keyField:"sampleactionid",data:o.rows||[],columns:s,noDataIndication:"No reference images",selectedItems:void 0!==r?[r]:[],actions:{addSelection:e=>{const{sampleactionid:t}=e;a(t);const n=o.rows.filter((e=>e.sampleactionid===t));n.length>0&&i(n[0].has_result)},removeSelection:e=>{},resetSelection:()=>{}}})})}var L=n(15568),P=n(70775),$=n(18680),U=n(42506);const W=function(e){const{abscissaConfig:t,ordinateConfig:n,title:r,showAxes:a,children:i}=e;return(0,v.jsx)(P.Ic,{abscissaConfig:t,ordinateConfig:n,aspect:"equal",title:r,showAxes:a,children:(0,v.jsx)(U.H,{children:i})})};class _ extends b.Z{constructor(){super(...arguments),this.moveid=void 0,this.x=0,this.y=0,this.execute=!0,this.positions={}}pk(){var e;return null===(e=this.moveid)||void 0===e?void 0:e.toString()}static get key(){return"MoveToReference"}}const O=D({path:"/imageviewer/move/reference/:moveid",schema:_});var B=n(45874),H=n(17332),q=n(25775),Y=n(51208),G=n.n(Y),X=n(96931),J=n(85083),Q=n(74307),K=n(95959);const ee={values:new Float32Array([0]),bins:new Float32Array([0,255])};var te=n(31029),ne=n(18941),re=n(33856),ae=n(66460),ie=n(3208),oe=n(79008);function se(e){const{currentAction:t,setCurrentAction:n,colorMap:r,setColorMap:a,scaleType:i,setScaleType:o,invertColorMap:s,setInvertColorMap:c,setCustomDomain:l,customDomain:d,doMove:u,setDoMove:p}=(0,f.m)(),m=(0,oe.pC)(),h=(0,oe.t9)(),{dataDomain:g,histogram:x,currentSample:y}=e;return(0,v.jsxs)(te.Z,{bg:"cyan",className:"p-2",style:{zIndex:99},children:[(0,v.jsx)(ne.Z,{children:(0,v.jsx)(re.Z,{children:(0,v.jsxs)(ae.Z,{type:"radio",name:"action",value:t,onChange:e=>n(e),className:"me-1",children:[(0,v.jsxs)(ie.Z,{id:"reference",value:"reference",size:"sm",disabled:!y,children:[(0,v.jsx)("i",{className:"fa fa-map-marker me-1"}),"Reference"]}),(0,v.jsxs)(ie.Z,{id:"poi",value:"poi",size:"sm",disabled:!y,children:[(0,v.jsx)("i",{className:"fa fa-map-pin me-1"}),"POI"]}),(0,v.jsxs)(ie.Z,{id:"pan",value:"pan",size:"sm",children:[(0,v.jsx)("i",{className:"fa fa-arrows me-1"}),"Pan"]}),(0,v.jsxs)(ie.Z,{id:"move",value:"move",size:"sm",disabled:!m||!!h,children:[(0,v.jsx)("i",{className:"fa fa-map-marker me-1"}),"Move",(0,v.jsx)(z.Z,{tooltip:"Enable Move",children:(0,v.jsx)(ne.Z.Check,{className:"d-inline ms-1",type:"checkbox",checked:u,value:"1",onChange:()=>p(!u)})})]})]})})}),(0,v.jsx)(P.CS,{dataDomain:g,customDomain:d,scaleType:i,onCustomDomainChange:e=>l(e),histogram:x}),(0,v.jsx)(P.gm,{value:i,onScaleChange:o,options:[P.N3.Linear,P.N3.SymLog,P.N3.Sqrt]}),(0,v.jsx)(P.rB,{value:r,onValueChange:a,invert:s,onInversionChange:()=>c(!s)})]})}var ce=n(2054),le=n.n(ce),de=n(26799),ue=n(30852),pe=n(30);function me(){return(0,v.jsx)(B.i,{x:1e3,y:1e3,color:q.Z.primary,sizeInScreen:20,lineWidth:1})}function he(e){let{beam:t}=e;return(0,v.jsx)(v.Fragment,{children:t&&(0,v.jsx)(B.i,{x:t[0],y:t[1],color:q.Z.warning,sizeInScreen:20,lineWidth:1})})}function fe(e){let{positions:t}=e;return(0,v.jsx)(v.Fragment,{children:null===t||void 0===t?void 0:t.filter((e=>"reference"===e.type)).map((e=>(0,v.jsxs)(v.Fragment,{children:[(0,v.jsx)(B.i,{x:e.posx,y:e.posy,color:"magenta",sizeInScreen:20,lineWidth:1},e.sampleactionpositionid),(0,v.jsx)(H.Z,{color:"magenta",datapos:[e.posx,e.posy],text:`${e.id}`})]})))})}function ve(e){let{currentAction:t,setReference:n,move:r}=e;return(0,v.jsxs)(v.Fragment,{children:["reference"===t&&(0,v.jsx)($.Z,{onClick:e=>{n(Math.round(e.dataPt.x),Math.round(e.dataPt.y))}}),"pan"===t&&(0,v.jsxs)(v.Fragment,{children:[(0,v.jsx)(P.Ce,{button:P.tc.Left}),(0,v.jsx)(P.LG,{})]}),"move"===t&&(0,v.jsx)($.Z,{onClick:e=>r(Math.round(e.dataPt.x),Math.round(e.dataPt.y))})]})}function ge(){const{getVisibleDomains:e}=(0,P.ki)(),t=(0,de.A)((e=>e.camera)),{setVisibleDomain:n}=(0,f.m)();return(0,c.useCallback)(le()((function(e){n(e)}),200),[])(e(t)),null}function xe(e){const{api:t,tilingBox:n,dataDomain:r,sampleactionid:a,referenceBeam:i,addToast:o}=e,{fetch:s,invalidateAll:l}=(0,d.Z)(),m=n.getSize(new L.Vector2),h=n.getCenter(new L.Vector2),{colorMap:g,scaleType:x,invertColorMap:y,customDomain:w,currentAction:b,setCurrentAction:j,doMove:S}=(0,f.m)(),[C,A]=(0,c.useState)(0);(0,c.useEffect)((()=>{const e=setInterval((()=>{const e=t.getPendingTilesCount();e!==C&&A(e)}),1e3);return()=>{clearTimeout(e)}}),[t,C]);const{cameraViewport:k,setCameraViewport:D}=(0,f.Z)(),M=(0,P.Ns)(w,r),[F]=(0,P.NY)(M,r,x),N={sampleactionid:a,type:"reference"},Z=(0,u.Z)(p.p.getList,N),I=(0,c.useCallback)((async(e,t)=>{const n=Z.rows.length>0?Math.max(...Z.rows.map((e=>e.id))):0;await s(p.p.create,{posx:e,posy:t,sampleactionid:a,type:"reference",id:n+1}),l(p.p.getList),j("pan")}),[Z]),z=(0,c.useCallback)((async(e,t)=>{try{const n=await s(O.create,{x:e,y:t,execute:S});o({type:E.info,title:"Move To Poisiton",text:`${n.positions.x.motor}: ${n.positions.x.destination}, ${n.positions.y.motor}: ${n.positions.y.destination}`})}catch(n){const e=await n.response.json();o({type:E.error,title:"Couldn't move to position",text:e.error})}}),[a,S]);return(0,v.jsx)("div",{style:{flex:"1",display:"flex",flexDirection:"column"},children:(0,v.jsxs)(W,{abscissaConfig:{visDomain:[0,m.x]},ordinateConfig:{visDomain:[0,m.y],flip:!0},children:[(0,v.jsx)(pe.z,{info:C>0?`Waiting for ${C} tiles`:""}),(0,v.jsx)(ue.Z,{viewpoint:k,setViewpoint:D}),(0,v.jsx)("group",{position:[h.x,h.y,0],children:(0,v.jsx)(P.AC,{size:{width:m.x,height:m.y},api:t,colorMap:g,invertColorMap:y,domain:F,scaleType:x,displayLowerResolutions:!1,qualityFactor:0})}),(0,v.jsx)(ge,{}),(0,v.jsx)(he,{beam:null===i||void 0===i?void 0:i.beam}),(0,v.jsx)(fe,{positions:Z.rows}),(0,v.jsx)(me,{}),(0,v.jsx)(ve,{currentAction:b,setReference:I,move:function(){z(...arguments)}})]})})}function ye(e){var t,n;const{selectedSampleActionId:r,selectedSampleActionHasResult:a}=(0,f.Z)(),i=function(e){let{sampleactionid:t}=e;const[n,r]=(0,c.useState)(void 0);return(0,c.useEffect)((()=>{r((()=>G().create({baseURL:(0,X.Z)(),params:{sampleactionid:t},...J.Z.getOptions()})))}),[J.Z.token,t]),n}({sampleactionid:r}),{api:o,tilingBox:s,histogram:l}=function(e){const t={width:256,height:256},[n,r]=(0,c.useState)(void 0),[a,i]=(0,c.useState)(new L.Box2(new L.Vector2,new L.Vector2(1,1))),[o,s]=(0,c.useState)(ee);return(0,c.useEffect)((()=>{!async function(){if(!e)return;const n=await(0,K.i)(e,"sample_registration","sample_registration"),{histogram:a,layers:o,yDomain:c,zDomain:l}=n,d=new Q.Bx(t,o);r(d),s(a),i(new L.Box2(new L.Vector2(c[0],l[0]),new L.Vector2(c[1],l[1])))}()}),[e]),{api:n,histogram:o,tilingBox:a}}(i),d=[0,254];return r?a?o?(0,v.jsxs)(v.Fragment,{children:[(0,v.jsx)(se,{dataDomain:d,histogram:l,...e}),r&&a&&(0,v.jsx)(xe,{sampleactionid:r,dataDomain:d,api:o,tilingBox:s,referenceBeam:null===(t=e.sources)||void 0===t||null===(n=t[1])||void 0===n?void 0:n.reference,addToast:e.addToast})]}):null:(0,v.jsx)("p",{style:{padding:"10px"},children:"Selected reference does not have an image"}):(0,v.jsx)("p",{style:{padding:"10px"},children:"Please select a reference image"})}const we=(0,i.Qg)({metadata:o.Z,twod:s.Z})((0,a.$j)(((e,t)=>{const{samples:n}=t.providers.metadata,{sources:r}=t.providers.twod;return{currentSample:o.Z.selector("currentSample",e),sample:n.selector("results",e)[o.Z.selector("currentSample",e)],sources:r.selector("results",e)}}),((e,t)=>({})))((function(e){const t=(0,l.p)();return(0,v.jsxs)("div",{className:"h-100",style:{display:"flex",flexDirection:"row"},children:[(0,v.jsx)("div",{style:{flex:"1 1 70%",display:"flex",flexDirection:"column",backgroundColor:"#efefef",borderRadius:"3px"},children:(0,v.jsx)(ye,{...e,addToast:t})}),(0,v.jsxs)("div",{style:{flex:"1 1 30%",padding:"0.5rem"},children:[(0,v.jsx)(c.Suspense,{fallback:(0,v.jsx)("p",{children:"..."}),children:(0,v.jsx)(V,{sampleid:e.currentSample,addToast:t})}),(0,v.jsx)(c.Suspense,{fallback:(0,v.jsx)("p",{children:"..."}),children:(0,v.jsx)(y,{})})]})]})})));function be(e){const{providers:t,yamlNode:n,datacollectionid:a,fileName:i,...o}=e;return r.ol(n,o),(0,v.jsx)(we,{})}},60687:(e,t,n)=>{n.d(t,{AA:()=>d,Os:()=>c,UZ:()=>h,WU:()=>m,Yk:()=>f,cy:()=>v,hO:()=>s,pm:()=>l,x7:()=>p});var r=n(97133),a=n.n(r),i=n(20837),o=n(25263);function s(e){var t;const n=`<${e.slice(1)}`;return null!==(t={"<f1":"<f4","<f2":"<f4","<i8":"<i4","<u8":"<u4"}[n])&&void 0!==t?t:n}function c(e,t){const n={"<f4":Float32Array,"<f8":Float64Array,"<i1":Int8Array,"|i1":Int8Array,i1:Int8Array,"<i2":Int16Array,"<i4":Int32Array,"<u1":Uint8Array,"|u1":Uint8Array,u1:Uint8Array,"<u2":Uint16Array,"<u4":Uint32Array}[t];if(!n)throw new Error(`Unsupported dtype: ${t}`);if(e instanceof Uint8Array){const t=n.BYTES_PER_ELEMENT;try{return new n(e.buffer,e.byteOffset,e.byteLength/t)}catch{return console.warn(`toTypedArray is using a memory copy for a '${n}'. Probably because the buffer is not properly aligned.`),new n(e)}}return new n(e)}function l(e,t,n){const r=t.reduce(((e,t)=>e*t));let i;switch(n){case"<f2":i=2*r===e.byteLength?Uint16Array:Float32Array;break;case"<f4":i=Float32Array;break;case"<f8":i=Float64Array;break;case"<i1":case"|i1":case"i1":i=Int8Array;break;case"<i2":i=Int16Array;break;case"<i4":case"<i8":i=Int32Array;break;case"<u1":case"|u1":case"u1":i=Uint8Array;break;case"<u2":i=Uint16Array;break;case"<u4":case"<u8":i=Uint32Array;break;default:throw new Error(`Unsupported dtype: ${n}`)}return a()(new i(e),t)}function d(e){return"float32"===e.dtype?e:a()(Float32Array.from(e.data),e.shape)}function u(e){return e instanceof Object&&"data"in e&&"stride"in e&&"shape"in e}function p(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Expected NdArray<TypedArray>";if(!u(e))throw new Error(t)}function m(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Expected NdArray<TypedArray> or NdFloat16Array";if(!u(e)&&!(e instanceof o.S))throw new Error(t)}function h(e){if(3!==e.length)throw new Error(`Unsupported dtype format ${e}`);return{byteorder:e[0],type:e[1],itemsize:Number.parseInt(e[2]),numpy:e}}function f(e,t,n){return(0,i.useMemo)((()=>function(e,t,n){if(1!==e.dimension)throw new Error("Slicing only supported for 1dim array");const r=e.data.subarray(t,n);return a()(r,[n-t])}(e,t,n)),[e,t,n])}function v(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Expected number[]";if(!function(e){if(!Array.isArray(e))return!1;for(const t of e)if("number"!==typeof t)return!1;return!0}(e))throw new Error(t)}},87095:(e,t,n)=>{n.d(t,{p:()=>o});var r=n(73809),a=n(81542);class i extends r.Z{constructor(){super(...arguments),this.sampleactionpositionid=void 0,this.posx=0,this.posy=0,this.sampleactionid=0,this.type="",this.id=0}pk(){var e;return null===(e=this.sampleactionpositionid)||void 0===e?void 0:e.toString()}static get key(){return"SampleActionPosition"}}const o=(0,a.Z)({path:"/metadata/samples/actions/positions/:sampleactionpositionid",schema:i})},81542:(e,t,n)=>{n.d(t,{Z:()=>i});var r=n(48822),a=n(51366);function i(e){let{path:t,schema:n}=e;const i=(0,r.Z)({path:t,schema:n,Endpoint:a.T});return{...i,getList:i.getList.extend({schema:{rows:[n],total:0}})}}},95959:(e,t,n)=>{n.d(t,{e:()=>o,i:()=>c});var r=n(96956),a=n(74307),i=n(60687);async function o(e,t,n){const r=await e.get("/h5grove/meta/",{params:{file:t,path:n}}).then((e=>e.data));if("dataset"!==r.type)throw new Error("Not a dataset");const{shape:a,dtype:o}=r,s=await e.get("/h5grove/data/",{params:{file:t,path:n,format:"bin",dtype:"safe"},responseType:"arraybuffer"}).then((e=>e.data));return(0,i.pm)(s,a,o)}function s(e,t){return e.startsWith("/")?e:`${(0,r.trimEnd)(t,"/")}/${e}`}async function c(e,t,n){const r=await o(e,t,s("histogram/count",n)),i=await o(e,t,s("histogram/bin_edges",n)),c=await o(e,t,s("y",n)),l=[c.data[0],c.data[1]],d=await o(e,t,s("z",n)),u=[d.data[0],d.data[1]],p=await e.get("/h5grove/data/",{params:{file:t,path:s("layers",n)}}).then((e=>e.data)),m=await Promise.all(p.map((async r=>{const i=s(r,n),o=await e.get("/h5grove/meta/",{params:{file:t,path:i}}).then((e=>e.data));if("dataset"!==o.type)throw new Error("Not a dataset");const{shape:c,dtype:l}=o;if(2!==c.length)throw new Error("dataset is not 2D");const[d,u]=c;if("<f2"!==l&&"<f4"!==l&&"|u1"!==l)throw new Error(`Unsupported dtype: ${l}`);const p="<f2"===l?a.o0.Float16:"<f4"===l?a.o0.Float32:a.o0.UInt8;return{file:t,path:i,tomovisRestService:e,size:{width:u,height:d},dtype:p}})));return{histogram:{values:r.data,bins:i.data},layers:m,yDomain:l,zDomain:u}}},74307:(e,t,n)=>{n.d(t,{Bx:()=>d,o0:()=>l,wi:()=>c});var r=n(70775),a=n(96956),i=n(97133),o=n.n(i),s=n(4987);class c extends r.IH{constructor(e,t){super(t,(0,r.an)(e,t)),this.layerDType=void 0,this.layerDType=l.Float32}get(e,t){const n=this.layerSizes[e],r=(0,a.clamp)(n.width-t.x,0,this.tileSize.width),i=(0,a.clamp)(n.height-t.y,0,this.tileSize.height),s=(t.x/r+t.y/i)%2;return o()(new Float32Array(r*i).fill(s),[i,r])}getPendingTilesCount(){return 0}}var l=function(e){return e.UInt8="uint8",e.Float16="float16",e.Float32="float32",e}(l||{});class d extends r.IH{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};super(e,t.map((e=>e.size))),this.store=void 0,this.layerDType=void 0,this.layers=void 0,this.layerDType=t[0].dtype,this.layers=[...t],this.store=(0,s.createSuspenseFetch)(0,n)}get(e,t){const{x:n,y:r}=t,i=`${e}|${n}|${r}`;return this.store.fetch(i,(async()=>{const{file:t,path:i,tomovisRestService:s,size:c,dtype:d}=this.layers[e],u=(0,a.clamp)(c.width-n,0,this.tileSize.width),p=(0,a.clamp)(c.height-r,0,this.tileSize.height),m=`${r}:${r+p},${n}:${n+u}`,h=await s.get("/h5grove/data/",{params:{file:t,path:i,selection:m,format:"bin"},responseType:"arraybuffer"}).then((e=>e.data)),f=d===l.Float16?Uint16Array:d===l.Float32?Float32Array:Uint8Array;return o()(new f(h),[p,u])}))}getPendingTilesCount(){return this.store.getCache().values().filter((e=>!e.error&&!e.response)).length}}},21681:(e,t,n)=>{n.d(t,{F:()=>a});var r=n(20837);function a(e){const[t,n]=(0,r.useState)(e),a=function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=(0,r.useRef)(e),n=(0,r.useCallback)((()=>t.current),[]);return(0,r.useEffect)((()=>(t.current=!0,()=>{t.current=!1})),[]),n}(!0);return[t,(0,r.useCallback)((e=>{a()&&n(e)}),[])]}},43285:(e,t,n)=>{n.d(t,{Z:()=>d});var r=n(20837);function a(){return a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},a.apply(this,arguments)}var i=function(e){return new Error("NoPayloadError: "+e+" requires a payload.")},o=function(e,t){var n=e.past,r=e.present,o=e.future,s=t.payload,c=t.behavior,l=t.historyLimit,d=t.ignoreIdenticalMutations,u=t.cloneState,p=t.ignoreAction;if(!s||void 0===s)throw i("mutate");if(p)return{past:n,present:s,future:o};var m=[].concat(n);"infinium"!==l&&"infinity"!==l&&(m=function(e,t){if(!e)return t;var n=[].concat(t);if(n.length<=e)return t;var r=n.length-e;return 1===r?n.shift():n.splice(0,r),n}(l,n));var h=JSON.stringify(s)===JSON.stringify(r);if(d&&h)return u?a({},e):e;var f=[].concat(o),v={mergePastReversed:{past:[].concat(m,f.reverse(),[r]),present:s,future:[]},mergePast:{past:[].concat(m,o,[r]),present:s,future:[]},destroyFuture:{past:[].concat(m,[r]),present:s,future:[]},keepFuture:{past:[].concat(m,[r]),present:s,future:o}};if("undefined"===typeof c)return v.mergePastReversed;if(!v.hasOwnProperty(c))throw function(e){return new Error("Mutation behavior must be one of: mergePastReversed, mergePast, keepFuture, or destroyFuture. Not: "+e)}(c);return v[c]},s=function(e,t){var n=e.past,r=e.present,a=e.future,s={undo:function(){if(0===n.length)return e;var t=n[n.length-1];return{past:n.slice(0,n.length-1),present:t,future:[r].concat(a)}},redo:function(){if(0===a.length)return e;var t=a[0],i=a.slice(1);return{past:[].concat(n,[r]),present:t,future:i}},update:function(){return o(e,function(e){return e.payload="function"===typeof e.payload?e.payload(r):e.payload,e}(t))},reset:function(){return{past:[],present:t.payload||e.present,future:[]}},resetInitialState:function(){var e=t.payload;if(!e)throw i("resetInitialState");var o=[].concat(n);return o[0]=e,{past:[].concat(o),present:r,future:[].concat(a)}}};return s[t.type]()},c={past:[],present:null,future:[]},l={behavior:"mergePastReversed",historyLimit:100,ignoreIdenticalMutations:!0,cloneState:!1};const d=function(e,t){void 0===t&&(t=l);var n=(0,r.useReducer)(s,a({},c,{present:e})),i=n[0],o=n[1],d=0!==i.past.length,u=0!==i.future.length,p=(0,r.useCallback)((function(){d&&o({type:"undo"})}),[d]),m=(0,r.useCallback)((function(){u&&o({type:"redo"})}),[u]),h=(0,r.useCallback)((function(t){return void 0===t&&(t=e),o({type:"reset",payload:t})}),[]),f=(0,r.useCallback)((function(e){return o({type:"resetInitialState",payload:e})}),[]),v=(0,r.useCallback)((function(e,n,r){return o(a({type:"update",payload:e,behavior:n,ignoreAction:r},function(e){return a({},l,e)}(t)))}),[]),g=(0,r.useCallback)((function(e,n,r){return void 0===n&&(n=t.behavior),void 0===r&&(r=!1),v(e,n,r)}),[i]);return[i.present,g,{past:i.past,future:i.future,undo:p,canUndo:d,redo:m,canRedo:u,reset:h,resetInitialState:f,static_setState:function(e,n,r){void 0===n&&(n=t.behavior),void 0===r&&(r=!1),v(e,n,r)}}]}}}]);
//# sourceMappingURL=339.7a040738.chunk.js.map