name: Publish docs
on:
  push:
    branches:
      - main
  workflow_run:
    workflows:
      - New release
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy dev or latest version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"

      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install the project
        run: |
          uv sync --group docs
          uv run async-kernel -a async-docs --shell.execute_request_timeout=0.1    # The 'async-docs' kernel is specified as the kernel for mkdocs-jupyter

      - name: Options
        id: mike
        run: |
          version=$(git tag --points-at HEAD)
          if [[ $version ]]; then
              echo "version=$version" >> $GITHUB_OUTPUT
              if [[ $version =~ .*[0-9].*[a-zA-Z] ]]; then
                  echo "alias=$version pre-release" >> $GITHUB_OUTPUT
              else
                  echo "alias=latest" >> $GITHUB_OUTPUT
              fi
            version=cut -d '.' -f 1,2 <<< $version
          else
            echo "version=dev" >> $GITHUB_OUTPUT
          fi

      - name: Deploy with mike ðŸš€
        run: |
          uv run mike deploy --push --update-aliases ${{steps.mike.outputs.version}} ${{steps.mike.outputs.alias}}
          echo "Docs has been updated for version ${{steps.mike.outputs.version}} [view here](https://fleming79.github.io/async-kernel/${{steps.mike.outputs.version}}/)." >> $GITHUB_STEP_SUMMARY
