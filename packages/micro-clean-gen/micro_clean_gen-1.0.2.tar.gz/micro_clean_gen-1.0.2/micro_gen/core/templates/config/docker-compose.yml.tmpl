version: '3.8'

services:
  # 应用服务
  app:
    build: .
    ports:
      - "8080:8080"
      - "50051:50051"
    environment:
      - NATS_URL=nats://nats:4222
      - NATS_STREAM=events
      - NATS_SNAPSHOT_STREAM=snapshots
      - SERVICE_NAME={{project_name}}
      - CONTAINER_ID=${CONTAINER_ID:-unknown}
    depends_on:
      - nats
    networks:
      - microservice-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        path: "/var/log/docker/{{project_name}}.log"
    volumes:
      - /var/log/docker:/var/log/docker

  # NATS消息代理
  nats:
    image: nats:latest
    ports:
      - "4222:4222"
      - "8222:8222"
    command: ["--js"]
    networks:
      - microservice-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        path: "/var/log/docker/nats.log"
    volumes:
      - /var/log/docker:/var/log/docker

  # Redis缓存
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    networks:
      - microservice-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        path: "/var/log/docker/redis.log"
    volumes:
      - /var/log/docker:/var/log/docker
      - redis_data:/data

networks:
  microservice-net:
    driver: bridge

volumes:
  redis_data: