groups:
  - name: continuous-image-gen
    interval: 30s
    rules:
      # High Error Rate
      - alert: ImageGenerationHighErrorRate
        expr: |
          (
            rate(image_generation_failures_total[5m]) / 
            rate(image_generation_total[5m])
          ) > 0.1
        for: 5m
        labels:
          severity: critical
          module: continuous-image-gen
          cso_tier: custom
        annotations:
          summary: "High image generation failure rate"
          description: "Image generation error rate is {{ $value | humanizePercentage }} over the last 5 minutes"
          runbook_url: "https://docs.agenticinsights.com/runbooks/image-gen-errors"

      # Slow Generation
      - alert: ImageGenerationSlow
        expr: |
          histogram_quantile(0.95, 
            rate(image_generation_duration_seconds_bucket[5m])
          ) > 60
        for: 10m
        labels:
          severity: warning
          module: continuous-image-gen
          cso_tier: custom
        annotations:
          summary: "Slow image generation detected"
          description: "95th percentile generation time is {{ $value }}s (threshold: 60s)"
          
      # Pod Memory Pressure
      - alert: ImageGenHighMemoryUsage
        expr: |
          (
            container_memory_usage_bytes{pod=~".*continuous-image-gen.*"} / 
            container_spec_memory_limit_bytes{pod=~".*continuous-image-gen.*"}
          ) > 0.9
        for: 5m
        labels:
          severity: warning
          module: continuous-image-gen
          cso_tier: custom
        annotations:
          summary: "High memory usage in {{ $labels.pod }}"
          description: "Pod {{ $labels.pod }} memory usage is {{ $value | humanizePercentage }}"
          
      # Pod Restart Loop
      - alert: ImageGenPodRestartLoop
        expr: |
          rate(kube_pod_container_status_restarts_total{pod=~".*continuous-image-gen.*"}[15m]) > 0.5
        for: 5m
        labels:
          severity: critical
          module: continuous-image-gen
          cso_tier: custom
        annotations:
          summary: "Pod {{ $labels.pod }} is in restart loop"
          description: "Pod {{ $labels.pod }} has restarted {{ $value }} times in the last 15 minutes"
          
      # Storage Nearly Full
      - alert: ImageGenStorageNearlyFull
        expr: |
          (
            kubelet_volume_stats_used_bytes{persistentvolumeclaim=~".*continuous-image-gen.*"} /
            kubelet_volume_stats_capacity_bytes{persistentvolumeclaim=~".*continuous-image-gen.*"}
          ) > 0.85
        for: 10m
        labels:
          severity: warning
          module: continuous-image-gen
          cso_tier: custom
        annotations:
          summary: "Storage volume {{ $labels.persistentvolumeclaim }} is nearly full"
          description: "PVC {{ $labels.persistentvolumeclaim }} is {{ $value | humanizePercentage }} full"
          
      # Backend Unavailable
      - alert: ImageGenBackendDown
        expr: |
          up{job=~".*continuous-image-gen-backend.*"} == 0
        for: 2m
        labels:
          severity: critical
          module: continuous-image-gen
          cso_tier: custom
        annotations:
          summary: "Image generation backend is down"
          description: "Backend service has been unavailable for more than 2 minutes"
          
      # Frontend Unavailable
      - alert: ImageGenFrontendDown
        expr: |
          up{job=~".*continuous-image-gen-frontend.*"} == 0
        for: 2m
        labels:
          severity: warning
          module: continuous-image-gen
          cso_tier: custom
        annotations:
          summary: "Image generation frontend is down"
          description: "Frontend service has been unavailable for more than 2 minutes"
          
      # High CPU Usage
      - alert: ImageGenHighCPU
        expr: |
          (
            rate(container_cpu_usage_seconds_total{pod=~".*continuous-image-gen.*"}[5m]) * 100
          ) > 80
        for: 10m
        labels:
          severity: warning
          module: continuous-image-gen
          cso_tier: custom
        annotations:
          summary: "High CPU usage in {{ $labels.pod }}"
          description: "Pod {{ $labels.pod }} CPU usage is {{ $value }}%"
          
      # No Images Generated Recently
      - alert: ImageGenNoRecentActivity
        expr: |
          increase(image_generation_total[1h]) == 0
        for: 2h
        labels:
          severity: info
          module: continuous-image-gen
          cso_tier: custom
        annotations:
          summary: "No images generated recently"
          description: "No images have been generated in the last 2 hours"
          
      # Ollama Connection Failed
      - alert: ImageGenOllamaUnavailable
        expr: |
          ollama_connection_failures_total > 10
        for: 5m
        labels:
          severity: warning
          module: continuous-image-gen
          cso_tier: custom
        annotations:
          summary: "Cannot connect to Ollama service"
          description: "Failed to connect to Ollama {{ $value }} times in the last 5 minutes"