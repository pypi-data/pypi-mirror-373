name: ğŸš€ Pipeline de Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, closed]

env:
  PYTHON_VERSION: '3.11'

jobs:
  qualidade:
    name: ğŸ§ª Testes e Qualidade
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
        
    steps:
    - name: ğŸ“¥ Fazer checkout do cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install hatchling build twine
        pip install -e ".[dev]"
    
    - name: ğŸ” Verificar formataÃ§Ã£o com Black
      run: |
        echo "ğŸ¨ Verificando formataÃ§Ã£o do cÃ³digo..."
        black --check mentorstec/ || (echo "âŒ CÃ³digo nÃ£o estÃ¡ formatado. Execute: black mentorstec/" && exit 1)
    
    - name: âš¡ AnÃ¡lise de cÃ³digo com Ruff
      run: |
        echo "ğŸ” Analisando qualidade do cÃ³digo..."
        ruff check mentorstec/
    
    - name: ğŸ·ï¸ VerificaÃ§Ã£o de tipos com MyPy
      run: |
        echo "ğŸ·ï¸ Verificando anotaÃ§Ãµes de tipo..."
        mypy mentorstec/ --ignore-missing-imports || echo "âš ï¸ Alguns tipos podem estar faltando"
    
    - name: ğŸ§ª Executar testes
      run: |
        echo "ğŸ§ª Executando suite de testes..."
        pytest tests/ -v --cov=mentorstec --cov-report=xml --cov-report=term
    
    - name: ğŸ“Š Upload de cobertura para Codecov
      if: matrix.python-version == '3.11'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: mentorstec-coverage

  construir:
    name: ğŸ“¦ Build do Pacote
    runs-on: ubuntu-latest
    needs: qualidade
    if: github.event.action != 'closed'
    
    steps:
    - name: ğŸ“¥ Fazer checkout do cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Instalar ferramentas de build
      run: |
        python -m pip install --upgrade pip
        pip install hatchling build twine
    
    - name: ğŸ—ï¸ Construir pacote
      run: |
        echo "ğŸ—ï¸ Construindo pacote Python..."
        python -m build
        echo "ğŸ“„ Arquivos criados:"
        ls -la dist/
    
    - name: âœ… Validar pacote
      run: |
        echo "âœ… Validando integridade do pacote..."
        twine check dist/*
    
    - name: ğŸ’¾ Salvar artefatos
      uses: actions/upload-artifact@v4
      with:
        name: python-package
        path: dist/
        retention-days: 30

  deploy-pypi:
    name: ğŸš€ Deploy para PyPI
    runs-on: ubuntu-latest
    needs: [qualidade, construir]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request' && 
       github.event.action == 'closed' && 
       github.event.pull_request.merged == true && 
       github.base_ref == 'main')
    
    environment:
      name: production
      url: https://pypi.org/project/mentorstec/
    
    steps:
    - name: ğŸ“¥ Fazer checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ Configurar Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Baixar artefatos
      uses: actions/download-artifact@v4
      with:
        name: python-package
        path: dist/
    
    - name: ğŸ“¦ Instalar twine
      run: |
        python -m pip install --upgrade pip twine
    
    - name: ğŸš€ Publicar no PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
      run: |
        echo "ğŸš€ Fazendo deploy para PyPI..."
        twine upload dist/*
        echo "âœ… Deploy realizado com sucesso!"
        echo "ğŸ“¦ Pacote disponÃ­vel em: https://pypi.org/project/mentorstec/"

  deploy-test-pypi:
    name: ğŸ§ª Deploy para TestPyPI
    runs-on: ubuntu-latest
    needs: [qualidade, construir]
    if: |
      github.event_name == 'pull_request' && 
      github.event.action != 'closed' &&
      github.base_ref == 'main'
    
    environment:
      name: test
      url: https://test.pypi.org/project/mentorstec/
    
    steps:
    - name: ğŸ“¥ Fazer checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ Configurar Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Baixar artefatos
      uses: actions/download-artifact@v4
      with:
        name: python-package
        path: dist/
    
    - name: ğŸ“¦ Instalar twine
      run: |
        python -m pip install --upgrade pip twine
    
    - name: ğŸ§ª Publicar no TestPyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_TEST_TOKEN }}
        TWINE_REPOSITORY_URL: https://test.pypi.org/legacy/
      run: |
        echo "ğŸ§ª Fazendo deploy para TestPyPI..."
        twine upload dist/*
        echo "âœ… Deploy de teste realizado com sucesso!"
        echo "ğŸ“¦ Pacote de teste disponÃ­vel em: https://test.pypi.org/project/mentorstec/"

  notificar:
    name: ğŸ“¢ NotificaÃ§Ãµes
    runs-on: ubuntu-latest
    needs: [deploy-pypi]
    if: always() && (needs.deploy-pypi.result == 'success' || needs.deploy-pypi.result == 'failure')
    
    steps:
    - name: ğŸ“¢ Notificar sucesso
      if: needs.deploy-pypi.result == 'success'
      run: |
        echo "ğŸ‰ Deploy realizado com sucesso!"
        echo "ğŸ“¦ Nova versÃ£o disponÃ­vel no PyPI"
        echo "ğŸ’¾ Instale com: pip install --upgrade mentorstec"
    
    - name: ğŸ“¢ Notificar falha
      if: needs.deploy-pypi.result == 'failure'
      run: |
        echo "âŒ Falha no deploy!"
        echo "ğŸ” Verifique os logs dos jobs anteriores"
        echo "ğŸ› ï¸ Corrija os problemas e tente novamente"