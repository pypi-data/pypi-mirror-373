# üèóÔ∏è Guia de Arquitetura - Mentorstec

Este documento detalha a arquitetura do **mentorstec**, explicando o Repository Pattern, modularidade opcional e decis√µes de design.

## üìã Vis√£o Geral

O **mentorstec** √© uma plataforma centralizada de dados e logging que implementa **Repository Pattern** com arquitetura modular e depend√™ncias opcionais.

### üéØ Objetivos de Design
- **Modularidade**: Core sempre dispon√≠vel, m√≥dulos opcionais carregados sob demanda
- **Repository Pattern**: Interfaces abstratas com implementa√ß√µes concretas
- **Backward Compatibility**: APIs antigas mantidas durante transi√ß√µes
- **Extensibilidade**: F√°cil adi√ß√£o de novos m√≥dulos e provedores
- **Production Ready**: Testes, CI/CD e distribui√ß√£o automatizada

## üèóÔ∏è Estrutura do Projeto

```
mentorstec/
‚îú‚îÄ‚îÄ üì¶ mentorstec/                   # Core Package
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                  #   üîë Entry point com optional imports
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üîÑ eventhub/                 #   CORE MODULE (sempre dispon√≠vel)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py              #     - Exports: setup_global_hub, send_event
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ event_hub.py             #     - Fun√ß√µes globais de conveni√™ncia
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ event_hub_client.py      #     - Cliente principal EventHubClient
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üóÑÔ∏è dremio/                   #   OPTIONAL MODULE (requer: requests)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py              #     - Export: Dremio
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dremio.py                #     - Cliente data virtualization
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìä powerbi/                  #   OPTIONAL MODULE (requer: adal+requests)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py              #     - Export: PowerBi
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ powerbi.py               #     - Cliente Power BI refresh
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üèõÔ∏è repository/               #   ABSTRACT INTERFACES
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py              #     - Exports: *Repository
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ eventhub_repository.py   #     - EventHubRepository (ABC)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dremio_repository.py     #     - DremioRepository (ABC)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ powerbi_repository.py    #     - PowerBiRepository (ABC)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ ‚òÅÔ∏è azure/                    #   AZURE IMPLEMENTATIONS
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py              #     - Export: AzureServiceBusRepository
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ azure_service_bus_repository.py  # - Concrete Azure impl
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ üè† lakehouse/                #   RESERVED FOR FUTURE
‚îÇ       ‚îî‚îÄ‚îÄ __init__.py              #     - Preparado para Data Lakehouse
‚îÇ
‚îú‚îÄ‚îÄ üß™ tests/                        # Testes unit√°rios
‚îú‚îÄ‚îÄ üìö examples/                     # Exemplos de uso
‚îú‚îÄ‚îÄ üìñ docs/                         # Documenta√ß√£o
‚îú‚îÄ‚îÄ ‚öôÔ∏è pyproject.toml               # Configura√ß√µes e depend√™ncias
‚îú‚îÄ‚îÄ üöÄ run_tests.sh                 # Script de testes automatizado
‚îî‚îÄ‚îÄ üîÑ .github/workflows/           # CI/CD pipeline
```

## üé® Repository Pattern Implementation

### Conceito

O **Repository Pattern** √© implementado de forma que cada m√≥dulo possui:
1. **Interface Abstrata** (`*Repository`) - Define contratos
2. **Implementa√ß√£o Concreta** (`Class`) - Executa funcionalidades
3. **Optional Loading** - Carregado apenas se depend√™ncias existem

### Fluxo de Carregamento

```python
# mentorstec/__init__.py - Smart Loading

# 1. Core sempre dispon√≠vel
from .eventhub import EventHubClient
from .repository.eventhub_repository import EventHubRepository

# 2. M√≥dulos opcionais com graceful fallback
try:
    from .dremio import Dremio  # noqa: F401
    from .repository.dremio_repository import DremioRepository  # noqa: F401
    __all__.extend(["Dremio", "DremioRepository"])
except ImportError:
    pass  # Requests n√£o dispon√≠vel - m√≥dulo n√£o carregado

try:
    from .powerbi import PowerBi  # noqa: F401
    from .repository.powerbi_repository import PowerBiRepository  # noqa: F401
    __all__.extend(["PowerBi", "PowerBiRepository"])
except ImportError:
    pass  # Adal n√£o dispon√≠vel - m√≥dulo n√£o carregado
```

## üîß Depend√™ncias e Modularidade

### Core Dependencies (Sempre Requeridas)
```toml
dependencies = [
    "azure-servicebus>=7.0.0",
]
```

### Optional Dependencies (Sob Demanda)
```toml
[project.optional-dependencies]
powerbi = [
    "adal>=1.2.0",       # Azure AD auth
    "requests>=2.25.0",  # HTTP client
]
dremio = [
    "requests>=2.25.0",  # HTTP client apenas
]
dev = [
    "pytest>=7.0",       # Testes
    "black",              # Formata√ß√£o
    "ruff",               # Linting
    "mypy",               # Type checking
    # ... outras deps de dev
]
```

### Cen√°rios de Instala√ß√£o

#### 1. **Instala√ß√£o M√≠nima** (Core)
```bash
pip install mentorstec
```
**Dispon√≠vel:**
- ‚úÖ `EventHubClient` - Azure Service Bus
- ‚úÖ `EventHubRepository` - Interface abstrata
- ‚úÖ `setup_global_hub`, `send_event`, `send_error` - Fun√ß√µes globais
- ‚ùå `Dremio` - N√£o dispon√≠vel (requests faltando)
- ‚ùå `PowerBi` - N√£o dispon√≠vel (adal faltando)

#### 2. **Com Power BI**
```bash
pip install mentorstec[powerbi]
```
**Dispon√≠vel:**
- ‚úÖ Tudo do core +
- ‚úÖ `PowerBi` - Power BI refresh client
- ‚úÖ `PowerBiRepository` - Interface Power BI
- ‚ùå `Dremio` - Ainda n√£o dispon√≠vel

#### 3. **Com Dremio**
```bash
pip install mentorstec[dremio]
```
**Dispon√≠vel:**
- ‚úÖ Tudo do core +
- ‚úÖ `Dremio` - Data virtualization client
- ‚úÖ `DremioRepository` - Interface Dremio
- ‚ùå `PowerBi` - Ainda n√£o dispon√≠vel

#### 4. **Instala√ß√£o Completa**
```bash
pip install mentorstec[powerbi,dremio]
```
**Dispon√≠vel:**
- ‚úÖ **Todos os m√≥dulos**

## üèõÔ∏è Abstract Repositories (Interfaces)

### EventHubRepository
```python
class EventHubRepository(ABC):
    """Interface para event logging systems"""
    
    @abstractmethod
    def event_handler(self, **kwargs: Any) -> None:
        """Processar evento"""
        pass
        
    @classmethod
    def build_payload(cls, **kwargs: Any) -> Dict[str, Any]:
        """Construir payload padr√£o"""
        return {
            "timestamp": datetime.utcnow().isoformat(),
            "project": kwargs.get("project"),
            "layer": kwargs.get("layer"),
            # ... campos padr√£o
        }
```

### DremioRepository
```python
class DremioRepository(ABC):
    """Interface para data virtualization systems"""
    
    @abstractmethod
    def execute_sql(self, query: str) -> Optional[Dict[str, Any]]:
        """M√©todo central - executa qualquer SQL"""
        pass
        
    @abstractmethod
    def get_tables(self, path: str) -> List[str]:
        """Listar tabelas (usa execute_sql internamente)"""
        pass
        
    @abstractmethod  
    def authenticate(self) -> bool:
        """Autenticar no sistema"""
        pass
```

### PowerBiRepository
```python
class PowerBiRepository(ABC):
    """Interface para Power BI operations"""
    
    @abstractmethod
    def get_token(self, project_config: List[Dict[str, Any]]) -> Optional[str]:
        """Obter token JWT"""
        pass
        
    @abstractmethod
    def refresh_resource(self, url: str, token: str, payload_json: Optional[Dict] = None) -> bool:
        """Refresh dataset/dataflow"""
        pass
        
    @abstractmethod
    def execute(self, url: str, token: str, payload_json: Optional[Dict] = None) -> bool:
        """Opera√ß√£o completa com wait"""
        pass
```

## üîÑ Concrete Implementations

### EventHubClient (Azure Service Bus)
```python
class EventHubClient:
    """Implementa√ß√£o concreta para Azure Service Bus"""
    
    def __init__(self, project: str, layer: str, repository: EventHubRepository):
        self.project = project
        self.layer = layer
        self.repository = repository
    
    @classmethod
    def create_azure_client(cls, project: str, queue_name: str, layer: str = "undefined"):
        """Factory method - cria client com Azure Service Bus"""
        connection_string = os.getenv('AZURE_SERVICE_BUS_CONNECTION_STRING')
        if not connection_string:
            raise ValueError("Azure Service Bus connection string √© obrigat√≥ria")
            
        # Usa implementa√ß√£o concreta Azure
        azure_repo = AzureServiceBusRepository(connection_string, queue_name)
        return cls(project, layer, azure_repo)
```

### Dremio (Data Virtualization)
```python
class Dremio(DremioRepository):
    """Implementa√ß√£o concreta para Dremio"""
    
    def __init__(self, host: str, port: int, username: str, password: str):
        self.host = host
        self.port = port
        self.username = username
        self.password = password
        
    def execute_sql(self, query: str) -> Optional[Dict[str, Any]]:
        """M√©todo central - todos os outros m√©todos usam este"""
        # Implementa√ß√£o com requests
        response = requests.post(
            url=f"http://{self.host}:{self.port}/apiv2/sql",
            json={"sql": query},
            headers=self.headers
        )
        return response.json() if response.ok else None
        
    def get_tables(self, path: str) -> List[str]:
        """Usa execute_sql() internamente"""
        result = self.execute_sql(f"SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = '{path}'")
        return [row['TABLE_NAME'] for row in result.get('rows', [])] if result else []
```

### PowerBi (Power BI Integration)
```python
class PowerBi(PowerBiRepository):
    """Implementa√ß√£o concreta para Power BI"""
    
    def __init__(self, airflow_variable: Optional[str] = None):
        self.airflow_variable = airflow_variable
        
    def get_token(self, project_config: List[Dict[str, Any]]) -> Optional[str]:
        """Autentica√ß√£o via ADAL"""
        context = adal.AuthenticationContext(authority=authority_url)
        token = context.acquire_token_with_username_password(...)
        return token.get('accessToken')
        
    def refresh_resource(self, url: str, token: str, payload_json: Optional[Dict] = None) -> bool:
        """Refresh via Power BI REST API"""
        response = requests.post(
            url=f'{url}/refreshes',
            headers={'Authorization': f'Bearer {token}'},
            json=payload_json
        )
        return response.status_code in [200, 202]
```

## üöÄ Factory Patterns e Entry Points

### Smart Entry Point
```python
# mentorstec/__init__.py

# 1. Core sempre exportado
__all__ = [
    "EventHubClient",
    "EventHubRepository", 
    "setup_global_hub",
    "send_event",
    "send_error",
    "capture_errors",
]

# 2. M√≥dulos opcionais adicionados dinamicamente
try:
    from .dremio import Dremio
    from .repository.dremio_repository import DremioRepository
    __all__.extend(["Dremio", "DremioRepository"])
except ImportError:
    pass

try:
    from .powerbi import PowerBi  
    from .repository.powerbi_repository import PowerBiRepository
    __all__.extend(["PowerBi", "PowerBiRepository"])
except ImportError:
    pass
```

### Factory Methods
```python
# EventHub Factory
EventHubClient.create_azure_client("project", "queue", "layer")

# Dremio Factory  
Dremio("host", 9047, "user", "pass")

# PowerBI Factory
PowerBi("airflow_variable_name")
```

## üéØ Usage Patterns

### 1. **Direct Usage** (Usu√°rios Finais)
```python
# Core sempre funciona
from mentorstec import EventHubClient
client = EventHubClient.create_azure_client("proj", "queue", "web")
client.send_event(event_type="LOGIN", message="User logged in")

# Opcionais carregados se dispon√≠veis
from mentorstec import Dremio, PowerBi
dremio = Dremio("host", 9047, "user", "pass")
powerbi = PowerBi("config_var")
```

### 2. **Repository Pattern** (Desenvolvedores Avan√ßados)
```python
# Usando interfaces para flexibilidade
from mentorstec import EventHubRepository, DremioRepository

def process_data(event_repo: EventHubRepository, data_repo: DremioRepository):
    """Fun√ß√£o gen√©rica que funciona com qualquer implementa√ß√£o"""
    data = data_repo.execute_sql("SELECT * FROM orders")
    
    for row in data.get('rows', []):
        event_repo.event_handler(
            event_type="DATA_PROCESSED",
            message="Row processed",
            row_id=row['id']
        )
```

### 3. **Pipeline Integration** (Data Engineers)
```python
from mentorstec import EventHubClient, Dremio, PowerBi

# Pipeline completo
event_client = EventHubClient.create_azure_client("pipeline", "events", "etl")
dremio = Dremio("dremio.company.com", 9047, "etl_user", "password")  
powerbi = PowerBi("powerbi_etl_config")

def daily_pipeline():
    # Log in√≠cio
    event_client.send_event(event_type="PIPELINE_START", message="Starting daily ETL")
    
    # Extrair dados
    data = dremio.execute_sql("SELECT * FROM daily_sales WHERE date = CURRENT_DATE")
    event_client.send_event(event_type="DATA_EXTRACTED", message=f"Extracted {len(data.get('rows', []))} rows")
    
    # Refresh Power BI
    projects = powerbi.get_power_bi_projects()
    results = powerbi.refresh_all_datasets(projects)
    
    # Log resultado
    if all(results.values()):
        event_client.send_event(event_type="PIPELINE_SUCCESS", message="Pipeline completed successfully")
    else:
        event_client.send_event(event_type="PIPELINE_PARTIAL", message="Some refreshes failed")
```

## üîß Extensibility Guide

### Adicionando Novo M√≥dulo (ex: Snowflake)

#### 1. Criar Interface Abstrata
```python
# mentorstec/repository/snowflake_repository.py
from abc import ABC, abstractmethod

class SnowflakeRepository(ABC):
    @abstractmethod
    def execute_query(self, query: str) -> Optional[Dict[str, Any]]:
        pass
        
    @abstractmethod
    def get_warehouses(self) -> List[str]:
        pass
```

#### 2. Implementa√ß√£o Concreta
```python
# mentorstec/snowflake/snowflake.py
import snowflake.connector
from ..repository.snowflake_repository import SnowflakeRepository

class Snowflake(SnowflakeRepository):
    def __init__(self, account: str, user: str, password: str):
        self.account = account
        self.user = user
        self.password = password
        
    def execute_query(self, query: str) -> Optional[Dict[str, Any]]:
        conn = snowflake.connector.connect(
            account=self.account,
            user=self.user,
            password=self.password
        )
        cursor = conn.cursor()
        cursor.execute(query)
        return cursor.fetchall()
```

#### 3. Adicionar Depend√™ncia Opcional
```toml
# pyproject.toml
[project.optional-dependencies]
snowflake = [
    "snowflake-connector-python>=3.0.0",
]
```

#### 4. Atualizar Entry Point
```python
# mentorstec/__init__.py
try:
    from .snowflake import Snowflake
    from .repository.snowflake_repository import SnowflakeRepository
    __all__.extend(["Snowflake", "SnowflakeRepository"])
except ImportError:
    pass
```

#### 5. Usage
```python
# Usu√°rio instala e usa
pip install mentorstec[snowflake]

from mentorstec import Snowflake
snowflake = Snowflake("account", "user", "pass")
data = snowflake.execute_query("SELECT * FROM orders")
```

## üß™ Testing Strategy

### Test Architecture
```python
# tests/test_integration.py
def test_optional_modules_graceful_import():
    """Test que m√≥dulos opcionais carregam graciosamente"""
    import mentorstec
    
    # Core sempre deve estar dispon√≠vel
    assert hasattr(mentorstec, 'EventHubClient')
    assert hasattr(mentorstec, 'EventHubRepository')
    
    # Opcionais dependem das depend√™ncias
    has_dremio = hasattr(mentorstec, 'Dremio')
    has_powerbi = hasattr(mentorstec, 'PowerBi')
    
    # Pelo menos core deve funcionar
    assert True  # Test passa se chegou at√© aqui
```

### Mock Testing para M√≥dulos Opcionais
```python
# tests/test_dremio.py
@pytest.mark.skipif(not HAS_REQUESTS, reason="requests not installed")
class TestDremio:
    @patch('requests.post')
    def test_execute_sql(self, mock_post):
        mock_post.return_value.ok = True
        mock_post.return_value.json.return_value = {"rows": []}
        
        dremio = Dremio("host", 9047, "user", "pass")
        result = dremio.execute_sql("SELECT 1")
        
        assert result is not None
```

## üìä Decision Log

### Why Repository Pattern?
1. **Testability**: F√°cil mock de depend√™ncias externas
2. **Flexibility**: Trocar implementa√ß√µes sem mudar c√≥digo cliente  
3. **Separation of Concerns**: Interface vs Implementa√ß√£o
4. **Future-proof**: Adicionar provedores sem quebrar c√≥digo existente

### Why Optional Dependencies?
1. **Lightweight Core**: Usu√°rios que s√≥ precisam de EventHub n√£o instalam depend√™ncias desnecess√°rias
2. **Graceful Degradation**: Pacote funciona mesmo com depend√™ncias faltantes
3. **Production Ready**: Deploy n√£o falha por depend√™ncia opcional faltante
4. **User Choice**: Instalam apenas o que precisam

### Why Modular Structure?
1. **Maintainability**: Cada m√≥dulo √© independente
2. **Team Development**: Diferentes equipes podem trabalhar em m√≥dulos diferentes
3. **Deployment**: M√≥dulos podem ter ciclos de release independentes
4. **Performance**: Import apenas do necess√°rio

## üîÆ Future Roadmap

### Planned Modules
```
mentorstec/
‚îú‚îÄ‚îÄ lakehouse/          # üè† Data Lakehouse (Delta Lake, Iceberg)
‚îú‚îÄ‚îÄ streaming/          # üåä Stream Processing (Kafka, EventHub Streams)  
‚îú‚îÄ‚îÄ ml/                 # ü§ñ ML Operations (MLflow, Kubeflow)
‚îú‚îÄ‚îÄ monitoring/         # üìä APM (DataDog, New Relic)
‚îî‚îÄ‚îÄ security/           # üîê Security (Vault, Key Management)
```

### Evolution Path
1. **v0.1.x**: Core + Dremio + PowerBI
2. **v0.2.x**: Add Lakehouse module
3. **v0.3.x**: Add Streaming module
4. **v0.4.x**: Add ML module
5. **v1.0.x**: Stable API, full ecosystem

---

üèóÔ∏è **Mentorstec v0.1.3** - Arquitetura robusta e extens√≠vel com Repository Pattern modular! üöÄ