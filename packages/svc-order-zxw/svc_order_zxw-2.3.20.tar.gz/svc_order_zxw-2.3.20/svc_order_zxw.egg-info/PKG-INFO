Metadata-Version: 2.4
Name: svc_order_zxw
Version: 2.3.20
Summary: è®¢å•ä¸æ”¯ä»˜æœåŠ¡: æ”¯æŒè‹¹æœå†…è´­è®¢é˜…
Home-page: https://github.com/sunshineinwater/
Author: è–›ä¼Ÿçš„å°å·¥å…·
Author-email: jingmu_app@foxmail.com
Classifier: Programming Language :: Python :: 3.10
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Description-Content-Type: text/markdown
Requires-Dist: fastapi<0.113,>=0.112.0
Requires-Dist: sqlalchemy==2.0.32
Requires-Dist: greenlet==3.0.3
Requires-Dist: asyncpg==0.29.0
Requires-Dist: psycopg2-binary>=2.9.10
Requires-Dist: uvicorn<0.31.0,>=0.30.0
Requires-Dist: app-tools-zxw>=2.2.4
Dynamic: author
Dynamic: author-email
Dynamic: classifier
Dynamic: description
Dynamic: description-content-type
Dynamic: home-page
Dynamic: requires-dist
Dynamic: summary

# svc_order_zxw - è®¢å•ä¸æ”¯ä»˜æœåŠ¡

ä¸€ä¸ªåŸºäºFastAPIçš„è®¢å•ä¸æ”¯ä»˜æœåŠ¡PythonåŒ…ï¼Œæä¾›å®Œæ•´çš„ç”µå•†è®¢å•ç®¡ç†ã€æ”¯ä»˜å¤„ç†ã€ç”¨æˆ·ç®¡ç†å’Œè¥é”€æ´»åŠ¨åŠŸèƒ½ã€‚

## ğŸ“ æ›´æ–°æ—¥å¿—

### v2.3.20

- **è‹¹æœå†…è´­éªŒè¯é€»è¾‘ä¼˜åŒ–**: api_IAPè®¢å•ç®¡ç†.py ï¼Œ è‹¹æœå†…è´­éªŒè¯é€»è¾‘ä¼˜åŒ–ï¼Œ ç”Ÿäº§ç¯å¢ƒéªŒè¯å¤±è´¥åï¼Œ å°è¯•æ²™ç›’ç¯å¢ƒéªŒè¯
- **é…ç½®æ–‡ä»¶ä¼˜åŒ–**: config.py ï¼Œ è‹¹æœå†…è´­é…ç½®æ–‡ä»¶ä¼˜åŒ–ï¼Œ å–æ¶ˆæ˜¯å¦æ²™ç›’ç¯å¢ƒé…ç½®ï¼Œ é»˜è®¤è‡ªåŠ¨åˆ‡æ¢ç¯å¢ƒ

### v2.3.19

- **æŸ¥è¯¢è¡Œä¸ºä¼˜åŒ–**: `crud4_payments.py` ä¸­çš„ `get_payment` å‡½æ•°ä¼˜åŒ–æŸ¥è¯¢é€»è¾‘ã€‚å°† `scalar_one_or_none()` æ›¿æ¢ä¸º `scalars().first()` é…åˆæ—¶é—´æ’åºï¼Œé¿å…å¤šæ¡è®°å½•æ—¶çš„å¼‚å¸¸ï¼Œç‰¹åˆ«é€‚ç”¨äºè‹¹æœå†…è´­ç­‰å¯èƒ½å­˜åœ¨å¤šæ¬¡æ”¯ä»˜çš„åœºæ™¯

### v2.3.18

- **æ–°å¢APIæ¥å£**: æ–°å¢è·å–æ˜¯å¦å¼€å¯è‹¹æœå†…è´­(IAP)çš„é…ç½®æ¥å£ `/apple_pay/config/enable_ios_iap`
- **æ–°å¢å®šæ—¶ä»»åŠ¡**: æ–°å¢å®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶è·å–åŠ¨æ€é…ç½®ï¼Œå¹¶æ›´æ–°åˆ°å†…å­˜ä¸­ï¼Œ æ”¯æŒçƒ­æ›´æ–°
- **ä½¿ç”¨æ³¨æ„**: éœ€è¦åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹configs/dynamic_config.json æ–‡ä»¶ä¸­é…ç½®æ˜¯å¦å¼€å¯è‹¹æœå†…è´­ï¼Œ é»˜è®¤å¼€å¯
- v2.3.15~v2.3.17 ç‰ˆæœ¬å­˜åœ¨bugï¼Œ å¯¼è‡´æ— æ³•è·å–åŠ¨æ€é…ç½®ï¼Œ è¯·å‡çº§åˆ°æ­¤ç‰ˆæœ¬

### v2.3.14

- è®¢å•æ›´æ–°å¢åŠ å®‰å…¨æ ¡éªŒï¼šappleå†…è´­ç›¸å…³å­—æ®µï¼Œå¦‚transaction_id, receiptï¼Œåªæœ‰æ•°æ®åº“ä¸­ä¸å­˜åœ¨æ—¶æ‰å¯ä»¥æ‰§è¡Œæ›´æ–°ã€‚



### v2.3.13

- å½»åº•é‡æ„è‹¹æœå†…è´­éªŒè¯é€»è¾‘ï¼š api_IAPè®¢å•ç®¡ç†.py ï¼Œ åˆ†ä¸ºä¸‰æ­¥ï¼š1ã€åˆ›å»ºè®¢å•ï¼›2ã€éªŒè¯æ”¶æ®å¹¶æ›´æ–°è®¢å•ï¼›3ã€æ¢å¤è´­ä¹°

### v2.3.12
- åŠ å¼º func_åˆ›å»ºè®¢å•.py åŠŸèƒ½æ€§ï¼ŒåŒæ—¶å‘åå…¼å®¹

### v2.3.11

- **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**: å°†æ‰€æœ‰ `db.get()` è¯­å¥æ›¿æ¢ä¸ºæ ‡å‡†çš„ `select` æŸ¥è¯¢è¯­å¥ï¼Œæå‡ä»£ç ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§
- **ä¿®æ”¹æ–‡ä»¶**: `svc_order_zxw/db/crud4_payments.py`, `svc_order_zxw/db/crudæ´»åŠ¨è¡¨2_æ”¯ä»˜è½¬æ¢æƒé™.py`, `svc_order_zxw/db/crudæ´»åŠ¨è¡¨5_ç”¨æˆ·ä¼˜æƒ åˆ¸.py`
- v2.3.10 ç‰ˆæœ¬å­˜åœ¨bugï¼Œ å¯¼è‡´æ— æ³•åˆ›å»ºè®¢å•ï¼Œ è¯·å‡çº§åˆ°æ­¤ç‰ˆæœ¬

### v2.3.10

- æ–°å¢func_åˆ›å»ºè®¢å•.py ï¼Œ æ”¯æŒåˆ›å»ºè®¢å•å¹¶åˆ›å»ºæ”¯ä»˜å•
- æ–°å¢é€šç”¨è®¢å•åˆ›å»ºå‡½æ•°ï¼Œ æ”¯ä»˜å®åˆ›å»ºè®¢å•æ¥å£ä½¿ç”¨æ­¤å‡½æ•°åˆ›å»º
- v2.3.9 ç‰ˆæœ¬å­˜åœ¨bugï¼Œ å¯¼è‡´æ— æ³•åˆ›å»ºè®¢å•ï¼Œ è¯·å‡çº§åˆ°æ­¤ç‰ˆæœ¬

### v2.3.8

- **æ”¯ä»˜æŸ¥è¯¢åŠŸèƒ½å¢å¼º**: `crud4_payments.py` ä¸­çš„ `get_payment` å‡½æ•°æ–°å¢å¯é€‰æŸ¥è¯¢å­—æ®µ `apple_transaction_id`ï¼Œæ”¯æŒé€šè¿‡è‹¹æœäº¤æ˜“IDç›´æ¥æŸ¥è¯¢æ”¯ä»˜è®°å½•ï¼Œæå‡è‹¹æœå†…è´­è®¢å•çš„æŸ¥è¯¢ä¾¿åˆ©æ€§ 

### v2.3.7

- æ–°å¢è‹¹æœå†…è´­çš„uniappå®Œæ•´æ¼”ç¤ºé¡µé¢ï¼ˆä¼˜æƒ åˆ¸æ”¯ä»˜æœ‰ç‚¹æœªçŸ¥é—®é¢˜æ— æ³•æˆåŠŸï¼Œå…¶ä»–æ­£å¸¸ï¼‰

### v 2.3.6

- **é‡è¦ä¿®å¤**: è§£å†³ SQLAlchemy å¼‚æ­¥æ“ä½œé”™è¯¯ `greenlet_spawn has not been called`
- æ•°æ®åº“å¼•æ“é…ç½®ä¼˜åŒ–ï¼šæ·»åŠ  `pool_pre_ping=True` æé«˜è¿æ¥ç¨³å®šæ€§ï¼Œä¿®å¤åŒæ­¥å¼•æ“URLè½¬æ¢é—®é¢˜
- æ”¯ä»˜ç®¡ç†æ¨¡å—å¼‚æ­¥æ“ä½œä¼˜åŒ–ï¼šå°† `await db.refresh()` æ›¿æ¢ä¸ºæ›´å®‰å…¨çš„ `await db.get()` æ“ä½œ
- æ•°æ®åº“ä¼šè¯ç®¡ç†å¢å¼ºï¼šæ”¹è¿›å¼‚æ­¥ä¼šè¯çš„é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶
- ä¿®å¤æ–‡ä»¶ï¼š`svc_order_zxw/db/get_db.py`, `svc_order_zxw/db/crud4_payments.py`


### v 2.3.5

- è‹¹æœå†…è´­è®¢å•åˆ›å»ºæµç¨‹ä¼˜åŒ–ï¼šæ”¹è¿›func0_æŸ¥è¯¢æˆ–åˆ›å»ºè®¢å•_ä»…é™IAPå‡½æ•°ï¼Œæ”¯æŒæ›´æ–°å·²å­˜åœ¨è®¢å•çš„è®¢é˜…ä¿¡æ¯å’Œè¿‡æœŸæ—¶é—´
- v2.3.3/v2.3.4 ç‰ˆæœ¬å­˜åœ¨bugï¼Œ å¯¼è‡´æ— æ³•æ¢å¤è´­ä¹°ï¼Œ è¯·å‡çº§åˆ°æ­¤ç‰ˆæœ¬

### v2.3.2

- bug fix: è‹¹æœå†…è´­è®¢å•, æ¶ˆè€—æ€§é¡¹ç›®åˆ›å»ºè®¢å•, è¿‡æœŸæ—¶é—´ä¸ºNoneçš„å¤„ç†

### v2.3.1

- bug fix:äº§å“è¡¨ ï¼Œ apple_product_id å­—æ®µç±»å‹åˆ é™¤äº†index=True, å› ä¸ºjsonç±»å‹æ— æ³•å»ºç«‹ç´¢å¼•

### v2.3.0

- äº§å“è¡¨ ï¼Œ apple_product_id å­—æ®µç±»å‹ç”± str æ”¹ä¸º list[str]

--------éå…¼å®¹æ€§æ›´æ–°-----------

### v2.2.11

- è‹¹æœå†…è´­è®¢å•ç®¡ç†æ¥å£ä¼˜åŒ–ï¼Œ æ”¯æŒè·å–ä¼˜æƒ åˆ¸ç­¾å
- v2.2.7,2.2.8 ç‰ˆæœ¬å­˜åœ¨bugï¼Œ å¯¼è‡´æ— æ³•è·å–ä¼˜æƒ åˆ¸ç­¾åï¼Œ è¯·å‡çº§åˆ°æ­¤ç‰ˆæœ¬
- v2.2.9 ç‰ˆæœ¬å­˜åœ¨bugï¼Œ å¯¼è‡´æ— æ³•éªŒè¯è‹¹æœå†…è´­ï¼Œ è¯·å‡çº§åˆ°æ­¤ç‰ˆæœ¬
- v2.2.10 ç‰ˆæœ¬å­˜åœ¨bugï¼Œ å¯¼è‡´æ— æ³•éªŒè¯è‹¹æœå†…è´­ï¼Œ è¯·å‡çº§åˆ°æ­¤ç‰ˆæœ¬

### v2.2.6

- å®šæ—¶ä»»åŠ¡task1_å®šæ—¶æ›´æ–°å•†å“è¡¨.py : å–æ¶ˆå®šæ—¶æ›´æ–°å•†å“è¡¨åŠŸèƒ½ï¼Œ æ”¹ä¸ºæ‰‹åŠ¨æ›´æ–°ï¼Œæˆ–åœ¨å¤–éƒ¨ç»´æŠ¤å•†å“è¡¨

### v2.2.5

- å®šæ—¶ä»»åŠ¡task1_å®šæ—¶æ›´æ–°å•†å“è¡¨.py é‡å¤§è°ƒæ•´ï¼Œ å¢åˆ æ”¹é…ç½®æ–‡ä»¶ä¸­çš„è‹¹æœäº§å“åˆ°æ•°æ®åº“

### v2.2.4

- è‹¹æœå†…è´­ä¼˜æƒ åˆ¸æ¥å£ä¼˜åŒ–

### v2.2.3

- è‹¹æœå†…è´­api é›†æˆè¿›ä¸»é¡¹ç›®ä¸­ï¼Œ æ— éœ€å†å•ç‹¬é…ç½®

### v2.2.1

- api_å•†å“æŸ¥è¯¢_ä½æƒé™.py æ–°å¢è·å–æ‰€æœ‰äº§å“æ¥å£ï¼Œ æ”¯æŒç­›é€‰è‹¹æœå†…è´­äº§å“
- å†…éƒ¨å®šæ—¶ä»»åŠ¡æ— éœ€å¤–éƒ¨å†é…ç½®ä¸å¯åŠ¨

### v2.2.0

- api_å•†å“ç®¡ç†.py æ–°å¢è·å–æ‰€æœ‰äº§å“æ¥å£ï¼Œ æ”¯æŒç­›é€‰è‹¹æœå†…è´­äº§å“
- api_æ”¯ä»˜_è‹¹æœå†…è´­ï¼šå°šæœªå…¨éƒ¨å®Œæˆ
- å®šæ—¶ä»»åŠ¡task1_å®šæ—¶æ›´æ–°å•†å“è¡¨.py æ–°å¢ï¼šè‹¹æœå†…è´­å•†å“è¡¨æ›´æ–°åŠŸèƒ½

### v2.1.0

- åº•å±‚æ–°å¢è‹¹æœå†…è´­è®¢é˜…ç›¸å…³åŠŸèƒ½ï¼Œ apiå±‚åŠŸèƒ½å°šæœªå®Œæˆ
- æ•°æ®åº“è¡¨ç»“æ„ä¼˜åŒ–ï¼š æ–°å¢è‹¹æœå†…è´­ç›¸å…³å­—æ®µ
- crudå±‚ä¼˜åŒ–ï¼š æ–°å¢è‹¹æœå†…è´­ç›¸å…³å­—æ®µ
- å°šæœªç»è¿‡æµ‹è¯•
- ç†è®ºä¸Šå…¼å®¹æ—§ç‰ˆæœ¬ï¼Œ ä½†æœªç»è¿‡æµ‹è¯•

### v2.0.17

- ä¿®å¤logger

### v2.0.16

- ç®¡ç†æ€§apiæ·»åŠ å®‰å…¨æ§åˆ¶ï¼š ä»…config.DEV_MODE==Trueæ—¶å¼€æ”¾å…¨éƒ¨ç®¡ç†æ¥å£ç”¨äºè°ƒè¯•

### v2.0.15

- æ›´æ–°READMEï¼š æ·»åŠ ç”¨æˆ·è¡¨åˆå§‹åŒ–è¯´æ˜

### v2.0.14

- æ›´æ–°app-tools-zxwå¼•ç”¨ç‰ˆæœ¬,æ—§ç‰ˆæœ¬å­˜åœ¨bug

### v2.0.13

- bug fix: TypeError: 'Logger' object is not callable

### v2.0.12

- bug fix: æ”¯ä»˜å®æ”¯ä»˜ - å›è°ƒåœ°å€é…ç½®ä¼˜åŒ–

### v0.2.11

- bug fix: æ”¯ä»˜å®æ”¯ä»˜ - å›è°ƒåœ°å€é…ç½®ä¼˜åŒ–

### v0.2.10

- bug fix

### v0.2.9

- app-tools-zxwä¾èµ–ç‰ˆæœ¬æ›´æ–°, æ”¯ä»˜å®æ”¯ä»˜å›è°ƒapi, æ›´æ–¹ä¾¿åœ¨å¤–éƒ¨å®šä¹‰

### v0.2.8

- æ”¯ä»˜å®æ”¯ä»˜ - å¢åŠ æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œç”¨æˆ·å¯ä»¥å¤–éƒ¨ä¼ å…¥ æ”¯ä»˜æˆåŠŸåçš„å›è°ƒå¤„ç†é€»è¾‘

### v0.2.7

- å¢åŠ UNIAPPå‰ç«¯ä»£ç ç¤ºä¾‹

### v0.2.6

- æŠ€æœ¯æ–‡æ¡£é”™è¯¯ä¿®æ­£

### v0.2.5ï¼ˆ2025.06.10ï¼‰

- æŠ€æœ¯æ–‡æ¡£å®Œå–„

### v0.2.4

- æ–°ç‰¹æ€§ï¼šcrudæ´»åŠ¨è¡¨2_æ”¯ä»˜è½¬æ¢æƒé™.py æ–°å¢æ ¹æ®order_numberæŸ¥è¯¢æ•°æ®
- Bugä¿®å¤å’Œæ€§èƒ½ä¼˜åŒ–

### v0.2.0

- å¢åŠ æ´»åŠ¨è¡¨ç›¸å…³åŠŸèƒ½
- å•å…ƒæµ‹è¯•è¦†ç›–ç‡100%

### v0.1.6

- å•å…ƒæµ‹è¯•è¦†ç›–100%
- æ€§èƒ½ä¼˜åŒ–ï¼šæŸ¥è¯¢å¤–é”®æ—¶å–æ¶ˆé¢å¤–çš„refreshæ“ä½œ

### v0.1.0 (é‡å¤§æ›´æ–°)

- è¡¨ç»“æ„3NFä¼˜åŒ–
- å¢åŠ CRUDå±‚
- é‡æ„interfaceå±‚ï¼Œä½¿ç”¨å‡½æ•°é©±åŠ¨
- æ”¯ä»˜å®æ‰‹æœºURLæ”¯ä»˜å®Œæˆ

### v0.0.6

- æ–°å¢æ”¯ä»˜å®äºŒç»´ç æ”¯ä»˜Vueé¡µé¢ç¤ºä¾‹
- configæ–°å¢è‡ªåŠ¨å¯¼å…¥

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

`svc_order_zxw` æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„è®¢å•ä¸æ”¯ä»˜å¾®æœåŠ¡åŒ…ï¼Œæ”¯æŒï¼š

- **æ”¯ä»˜é›†æˆ**ï¼šæ”¯ä»˜å®æ”¯ä»˜ã€å¾®ä¿¡æ”¯ä»˜
- **è®¢å•ç®¡ç†**ï¼šè®¢å•åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€çŠ¶æ€ç®¡ç†
- **å•†å“ç®¡ç†**ï¼šå•†å“CRUDæ“ä½œ
- **ç”¨æˆ·ç®¡ç†**ï¼šç”¨æˆ·ä¿¡æ¯ç®¡ç†
- **è¥é”€æ´»åŠ¨**ï¼šä¿ƒé”€æ´»åŠ¨ã€ä¼˜æƒ åˆ¸ç³»ç»Ÿ
- **æ•°æ®åº“**ï¼šåŸºäºSQLAlchemyçš„å¼‚æ­¥æ•°æ®åº“æ“ä½œ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…

```bash
pip install svc_order_zxw
```

### åŸºæœ¬ä½¿ç”¨

```python
from fastapi import FastAPI
from svc_order_zxw.main import router

app = FastAPI()
app.include_router(router, prefix="/api/v1")

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

## âš™ï¸ é…ç½®è¯´æ˜

### å¿…éœ€é…ç½®

- ï¼ˆä¸æ¨èï¼‰åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º `config.py` æ–‡ä»¶ï¼Œ
- ï¼ˆæ¨èï¼‰æˆ–åœ¨ `configs/config_payments.py`æ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹å‚æ•°ï¼š

#### æ•°æ®åº“é…ç½®

```python
# æ•°æ®åº“è¿æ¥URL
DATABASE_URL = "postgresql+asyncpg://user:password@localhost/dbname"
# æˆ–ä½¿ç”¨SQLiteï¼ˆå¼€å‘ç¯å¢ƒï¼‰
DATABASE_URL = "sqlite+aiosqlite:///./test_database.db"
```

#### æ”¯ä»˜å®é…ç½®

```python
class AliPayConfig:
    appid = "ä½ çš„æ”¯ä»˜å®åº”ç”¨ID"
    keyåº”ç”¨ç§é’¥ = Path("pems/åº”ç”¨ç§é’¥2048.txt")  # åº”ç”¨ç§é’¥æ–‡ä»¶è·¯å¾„
    keyæ”¯ä»˜å®å…¬é’¥ = Path("pems/æ”¯ä»˜å®å…¬é’¥.pem")  # æ”¯ä»˜å®å…¬é’¥æ–‡ä»¶è·¯å¾„
    # æ”¯ä»˜å®æ”¯ä»˜å›è°ƒåœ°å€é…ç½®
    å›è°ƒè·¯å¾„_root = "http://localhost:8000"
    å›è°ƒè·¯å¾„_prefix = "/alipay/pay_qr"
```

#### å¾®ä¿¡æ”¯ä»˜é…ç½®

```python
class WeChatPay:
    APP_ID = "ä½ çš„å¾®ä¿¡åº”ç”¨ID"
    MCH_ID = "ä½ çš„å•†æˆ·ID"
    SECRET = "ä½ çš„åº”ç”¨å¯†é’¥"
    KEY = "ä½ çš„å•†æˆ·å¯†é’¥"
    PAYMENT_NOTIFY_URL_å°ç¨‹åº = "http://localhost:8000/wxpay_callback"
    REFUND_NOTIFY_URL_å°ç¨‹åº = "http://localhost:8000/wxpay_refund_callback"
    CERT = "path/to/apiclient_cert.pem"
    CERT_KEY = "path/to/apiclient_key.pem"
```

### ç¯å¢ƒå˜é‡

```bash
export PAYMENT_DATABASE_URL="your_database_url"
```

### âš ï¸ é‡è¦æé†’ï¼šç”¨æˆ·åˆå§‹åŒ–é…ç½®

**åœ¨ä½¿ç”¨ä¿ƒé”€æ´»åŠ¨ç›¸å…³åŠŸèƒ½å‰ï¼Œå¿…é¡»å…ˆåˆå§‹åŒ–ç”¨æˆ·æ•°æ®ï¼**

æœ¬é¡¹ç›®çš„ä¿ƒé”€æ´»åŠ¨ç³»ç»Ÿï¼ˆä¼˜æƒ åˆ¸ã€æ”¯ä»˜è½¬æ¢æƒé™ç­‰ï¼‰ä½¿ç”¨ç‹¬ç«‹çš„ç”¨æˆ·æŠ½è±¡å±‚ã€‚åœ¨ç”¨æˆ·æ³¨å†Œåˆ°æ‚¨çš„ä¸»ç³»ç»Ÿåï¼Œ**å¿…é¡»**åŒæ­¥åˆ›å»ºä¿ƒé”€æ´»åŠ¨ç³»ç»Ÿçš„ç”¨æˆ·è®°å½•ï¼Œå¦åˆ™ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š

#### æŠ¥é”™æƒ…å†µ

- åˆ›å»ºä¼˜æƒ åˆ¸æ—¶ï¼š`ç”¨æˆ·ä¸å­˜åœ¨ (é”™è¯¯ä»£ç : 7501)`
- åˆ†é…æ”¯ä»˜æƒé™æ—¶ï¼š`ç”¨æˆ·ä¸å­˜åœ¨ (é”™è¯¯ä»£ç : 7501)`
- æ•°æ®åº“å¤–é”®çº¦æŸè¿åé”™è¯¯

#### è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ1ï¼šç”¨æˆ·æ³¨å†Œæ—¶åŒæ­¥åˆ›å»º**

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨1_ç”¨æˆ· import create_user
from svc_order_zxw.db.get_db import get_db

async def ç”¨æˆ·æ³¨å†Œæµç¨‹(external_user_id: int):
    """ç”¨æˆ·æ³¨å†Œåçš„å®Œæ•´æµç¨‹"""
    # 1. åœ¨æ‚¨çš„ä¸»ç³»ç»Ÿä¸­åˆ›å»ºç”¨æˆ·
    # your_main_system.create_user(user_data)

    # 2. åœ¨ä¿ƒé”€æ´»åŠ¨ç³»ç»Ÿä¸­åˆ›å»ºç”¨æˆ·è®°å½•
    async with get_db() as db:
        try:
            user = await create_user(db, external_user_id)
            print(f"ç”¨æˆ· {external_user_id} å·²åŒæ­¥åˆ°ä¿ƒé”€æ´»åŠ¨ç³»ç»Ÿ")
        except Exception as e:
            print(f"ä¿ƒé”€æ´»åŠ¨ç³»ç»Ÿç”¨æˆ·åˆ›å»ºå¤±è´¥: {e}")
```

**æ–¹æ¡ˆ2ï¼šä½¿ç”¨å‰æ£€æŸ¥å¹¶è‡ªåŠ¨åˆ›å»º**

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨1_ç”¨æˆ· import get_user, create_user

async def ç¡®ä¿ç”¨æˆ·å­˜åœ¨(user_id: int):
    """ç¡®ä¿ç”¨æˆ·åœ¨ä¿ƒé”€æ´»åŠ¨ç³»ç»Ÿä¸­å­˜åœ¨"""
    async with get_db() as db:
        user = await get_user(db, user_id)
        if not user:
            # ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»ºç”¨æˆ·è®°å½•
            user = await create_user(db, user_id)
            print(f"ç”¨æˆ· {user_id} å·²è‡ªåŠ¨åˆ›å»ºåˆ°ä¿ƒé”€æ´»åŠ¨ç³»ç»Ÿ")
        return user

# ä½¿ç”¨ç¤ºä¾‹ï¼šåœ¨åˆ†é…ä¼˜æƒ åˆ¸å‰æ£€æŸ¥
async def å®‰å…¨åˆ†é…ä¼˜æƒ åˆ¸(user_id: int, coupon_id: int):
    await ç¡®ä¿ç”¨æˆ·å­˜åœ¨(user_id)  # å…ˆç¡®ä¿ç”¨æˆ·å­˜åœ¨
    # ç„¶åå†åˆ†é…ä¼˜æƒ åˆ¸
    async with get_db() as db:
        user_coupon = await create_ç”¨æˆ·ä¼˜æƒ åˆ¸(db, user_id, coupon_id)
        return user_coupon
```

**æ–¹æ¡ˆ3ï¼šæ‰¹é‡åˆå§‹åŒ–ç°æœ‰ç”¨æˆ·**

```python
async def æ‰¹é‡åˆå§‹åŒ–ç°æœ‰ç”¨æˆ·(user_ids: list):
    """ä¸ºç°æœ‰ç”¨æˆ·æ‰¹é‡åˆ›å»ºä¿ƒé”€æ´»åŠ¨ç³»ç»Ÿè®°å½•"""
    async with get_db() as db:
        success_count = 0
        for user_id in user_ids:
            try:
                await create_user(db, user_id)
                success_count += 1
            except Exception as e:
                print(f"ç”¨æˆ· {user_id} åˆ›å»ºå¤±è´¥: {e}")
        print(f"æˆåŠŸåˆ›å»º {success_count} ä¸ªç”¨æˆ·è®°å½•")
```

#### æ•°æ®åº“å…³ç³»è¯´æ˜

- `Modelç”¨æˆ·è¡¨` â† 1:N â†’ `Modelæ”¯ä»˜è½¬æ¢æƒé™è¡¨`
- `Modelç”¨æˆ·è¡¨` â† 1:N â†’ `Modelç”¨æˆ·ä¼˜æƒ åˆ¸è¡¨`
- ä¸¤ä¸ªå­è¡¨éƒ½æœ‰å¤–é”®çº¦æŸæŒ‡å‘ç”¨æˆ·è¡¨ï¼Œå¿…é¡»å…ˆæœ‰ç”¨æˆ·è®°å½•

## ğŸ“š æ¨¡å—è¯´æ˜

### 1. æ•°æ®åº“å±‚ (db/)

#### CRUDæ“ä½œæ¨¡å—

- `crud1_applications.py` - åº”ç”¨ç¨‹åºç®¡ç†
- `crud2_products.py` - å•†å“ç®¡ç†
- `crud3_orders.py` - è®¢å•ç®¡ç†
- `crud4_payments.py` - æ”¯ä»˜ç®¡ç†
- `crudæ´»åŠ¨è¡¨1_ç”¨æˆ·.py` - ç”¨æˆ·ç®¡ç†
- `crudæ´»åŠ¨è¡¨2_æ”¯ä»˜è½¬æ¢æƒé™.py` - æ”¯ä»˜æƒé™ç®¡ç†
- `crudæ´»åŠ¨è¡¨3_ä¿ƒé”€æ´»åŠ¨.py` - ä¿ƒé”€æ´»åŠ¨ç®¡ç†
- `crudæ´»åŠ¨è¡¨4_ä¼˜æƒ åˆ¸.py` - ä¼˜æƒ åˆ¸ç®¡ç†
- `crudæ´»åŠ¨è¡¨5_ç”¨æˆ·ä¼˜æƒ åˆ¸.py` - ç”¨æˆ·ä¼˜æƒ åˆ¸ç®¡ç†

#### æ•°æ®æ¨¡å‹

- `models.py` - åŸºç¡€æ•°æ®æ¨¡å‹
- `models_æ´»åŠ¨è¡¨.py` - æ´»åŠ¨ç›¸å…³æ•°æ®æ¨¡å‹

### 2. APIå±‚ (apis/)

#### å•†å“ç®¡ç†API

```python
from svc_order_zxw.apis import api_å•†å“ç®¡ç†

# æä¾›å•†å“çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½
```

#### æ”¯ä»˜API

```python
from svc_order_zxw.apis.api_æ”¯ä»˜_æ”¯ä»˜å® import api_appä¸urlæ–¹å¼
from svc_order_zxw.apis.api_æ”¯ä»˜_å¾®ä¿¡ import api_äºŒç»´ç 
```

### 3. æ¥å£å±‚ (interface/)

#### æ”¯ä»˜å®æ”¯ä»˜æ¥å£

```python
from svc_order_zxw.interface.interface_æ”¯ä»˜å®æ”¯ä»˜ import åˆ›å»ºæ”¯ä»˜è®¢å•, éªŒè¯æ”¯ä»˜å›è°ƒ
```

## ğŸ“Š APIæ–‡æ¡£

å¯åŠ¨æœåŠ¡åè®¿é—®ä»¥ä¸‹åœ°å€æŸ¥çœ‹APIæ–‡æ¡£ï¼š

- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

### æ•°æ®ç±»å‹å®šä¹‰

#### è®¢å•çŠ¶æ€æšä¸¾ (OrderStatus)

```python
class OrderStatus(str, enum.Enum):
    PENDING = "pending"      # å¾…æ”¯ä»˜
    PAID = "paid"           # å·²æ”¯ä»˜
    FAILED = "failed"       # æ”¯ä»˜å¤±è´¥
    CANCELLED = "cancelled" # å·²å–æ¶ˆ
    FINISHED = "finished"   # äº¤æ˜“å®Œæˆï¼ˆä¸å¯é€€æ¬¾ï¼‰
```

#### æ”¯ä»˜æ–¹å¼æšä¸¾ (PaymentMethod)

```python
class PaymentMethod(str, enum.Enum):
    WECHAT_H5 = "wechat_h5"     # å¾®ä¿¡H5æ”¯ä»˜
    WECHAT_QR = "wechat_qr"     # å¾®ä¿¡äºŒç»´ç æ”¯ä»˜
    WECHAT_MINI = "wechat_mini" # å¾®ä¿¡å°ç¨‹åºæ”¯ä»˜
    WECHAT_APP = "wechat_app"   # å¾®ä¿¡APPæ”¯ä»˜
    ALIPAY_H5 = "alipay_h5"     # æ”¯ä»˜å®H5æ”¯ä»˜
    ALIPAY_QR = "alipay_qr"     # æ”¯ä»˜å®äºŒç»´ç æ”¯ä»˜
    ALIPAY_APP = "alipay_app"   # æ”¯ä»˜å®APPæ”¯ä»˜
    PAYPAL = "paypal"           # PayPalæ”¯ä»˜
    APPLE_PAY = "apple_pay"     # Apple Pay
    GOOGLE_PAY = "google_pay"   # Google Pay
```

## ğŸ”— APIæ¥å£è¯¦æƒ…

### 1. åº”ç”¨ç®¡ç† API

#### åˆ›å»ºåº”ç”¨

- **URL**: `POST /applications`
- **æè¿°**: åˆ›å»ºæ–°çš„åº”ç”¨
- **è¯·æ±‚ä½“**:

```json
{
    "name": "åº”ç”¨åç§°"
}
```

- **å“åº”**:

```json
{
    "id": 1,
    "name": "åº”ç”¨åç§°",
    "products": []
}
```

#### è·å–åº”ç”¨è¯¦æƒ…

- **URL**: `GET /applications/{application_id}`
- **æè¿°**: æ ¹æ®åº”ç”¨IDè·å–åº”ç”¨è¯¦æƒ…
- **è·¯å¾„å‚æ•°**:
  - `application_id`: åº”ç”¨ID (æ•´æ•°)
- **å“åº”**:

```json
{
    "id": 1,
    "name": "åº”ç”¨åç§°",
    "products": [
        {
            "id": 1,
            "name": "å•†å“åç§°",
            "app_name": "åº”ç”¨åç§°",
            "price": 99.99
        }
    ]
}
```

#### æ›´æ–°åº”ç”¨

- **URL**: `PUT /applications/{application_id}`
- **æè¿°**: æ›´æ–°åº”ç”¨ä¿¡æ¯
- **è·¯å¾„å‚æ•°**:
  - `application_id`: åº”ç”¨ID (æ•´æ•°)
- **è¯·æ±‚ä½“**:

```json
{
    "name": "æ–°çš„åº”ç”¨åç§°"
}
```

- **å“åº”**: åŒåˆ›å»ºåº”ç”¨å“åº”æ ¼å¼

#### åˆ é™¤åº”ç”¨

- **URL**: `DELETE /applications/{application_id}`
- **æè¿°**: åˆ é™¤æŒ‡å®šåº”ç”¨
- **è·¯å¾„å‚æ•°**:
  - `application_id`: åº”ç”¨ID (æ•´æ•°)
- **å“åº”**: HTTP 200 æˆåŠŸ

#### è·å–æ‰€æœ‰åº”ç”¨

- **URL**: `GET /applications`
- **æè¿°**: è·å–åº”ç”¨åˆ—è¡¨
- **æŸ¥è¯¢å‚æ•°**:
  - `skip`: è·³è¿‡è®°å½•æ•° (é»˜è®¤: 0)
  - `limit`: è¿”å›è®°å½•æ•° (é»˜è®¤: 100)
- **å“åº”**: åº”ç”¨åˆ—è¡¨æ•°ç»„

### 2. å•†å“ç®¡ç† API

#### åˆ›å»ºå•†å“

- **URL**: `POST /products`
- **æè¿°**: åˆ›å»ºæ–°å•†å“
- **è¯·æ±‚ä½“**:

```json
{
    "name": "å•†å“åç§°",
    "app_id": 1,
    "price": 99.99
}
```

- **å“åº”**:

```json
{
    "id": 1,
    "name": "å•†å“åç§°",
    "app_name": "åº”ç”¨åç§°",
    "price": 99.99
}
```

#### è·å–å•†å“è¯¦æƒ…

- **URL**: `GET /products/{product_id}`
- **æè¿°**: æ ¹æ®å•†å“IDè·å–å•†å“è¯¦æƒ…
- **è·¯å¾„å‚æ•°**:
  - `product_id`: å•†å“ID (æ•´æ•°)
- **å“åº”**: åŒåˆ›å»ºå•†å“å“åº”æ ¼å¼

#### æ›´æ–°å•†å“

- **URL**: `PUT /products/{product_id}`
- **æè¿°**: æ›´æ–°å•†å“ä¿¡æ¯
- **è·¯å¾„å‚æ•°**:
  - `product_id`: å•†å“ID (æ•´æ•°)
- **è¯·æ±‚ä½“**:

```json
{
    "name": "æ–°å•†å“åç§°",
    "app_id": 1,
    "price": 199.99
}
```

- **å“åº”**: åŒåˆ›å»ºå•†å“å“åº”æ ¼å¼

#### åˆ é™¤å•†å“

- **URL**: `DELETE /products/{product_id}`
- **æè¿°**: åˆ é™¤æŒ‡å®šå•†å“
- **è·¯å¾„å‚æ•°**:
  - `product_id`: å•†å“ID (æ•´æ•°)
- **å“åº”**: HTTP 200 æˆåŠŸ

#### è·å–æ‰€æœ‰å•†å“

- **URL**: `GET /products`
- **æè¿°**: è·å–å•†å“åˆ—è¡¨
- **æŸ¥è¯¢å‚æ•°**:
  - `skip`: è·³è¿‡è®°å½•æ•° (é»˜è®¤: 0)
  - `limit`: è¿”å›è®°å½•æ•° (é»˜è®¤: 100)
- **å“åº”**: å•†å“åˆ—è¡¨æ•°ç»„

### 3. è®¢å•ç®¡ç† API

#### åˆ›å»ºè®¢å•

- **URL**: `POST /orders`
- **æè¿°**: åˆ›å»ºæ–°è®¢å•ï¼ˆè‡ªåŠ¨ç”Ÿæˆè®¢å•å·ï¼‰
- **è¯·æ±‚ä½“**:

```json
{
    "user_id": "user123",
    "product_id": 1,
    "total_price": 99.99,
    "quantity": 2
}
```

- **å“åº”**:

```json
{
    "id": 1,
    "user_id": "user123",
    "total_price": 99.99,
    "quantity": 2,
    "order_number": "ORD20241201123456789",
    "created_at": "2024-12-01T10:00:00Z",
    "updated_at": "2024-12-01T10:00:00Z",
    "product_id": 1,
    "product": {
        "id": 1,
        "name": "å•†å“åç§°",
        "price": 49.99,
        "app_id": 1
    },
    "application": {
        "id": 1,
        "name": "åº”ç”¨åç§°"
    },
    "payment": null
}
```

#### è·å–è®¢å•è¯¦æƒ…

- **URL**: `GET /orders/{order_id}`
- **æè¿°**: æ ¹æ®è®¢å•IDè·å–è®¢å•è¯¦æƒ…ï¼ˆåŒ…å«å•†å“ã€åº”ç”¨ã€æ”¯ä»˜ä¿¡æ¯ï¼‰
- **è·¯å¾„å‚æ•°**:
  - `order_id`: è®¢å•ID (æ•´æ•°)
- **å“åº”**: åŒåˆ›å»ºè®¢å•å“åº”æ ¼å¼

#### æ›´æ–°è®¢å•

- **URL**: `PUT /orders/{order_id}`
- **æè¿°**: æ›´æ–°è®¢å•ä¿¡æ¯
- **è·¯å¾„å‚æ•°**:
  - `order_id`: è®¢å•ID (æ•´æ•°)
- **è¯·æ±‚ä½“**:

```json
{
    "total_price": 199.99,
    "quantity": 3
}
```

- **å“åº”**:

```json
{
    "id": 1,
    "user_id": "user123",
    "total_price": 199.99,
    "quantity": 3,
    "order_number": "ORD20241201123456789",
    "created_at": "2024-12-01T10:00:00Z",
    "updated_at": "2024-12-01T10:05:00Z",
    "product_id": 1
}
```

#### åˆ é™¤è®¢å•

- **URL**: `DELETE /orders/{order_id}`
- **æè¿°**: åˆ é™¤æŒ‡å®šè®¢å•
- **è·¯å¾„å‚æ•°**:
  - `order_id`: è®¢å•ID (æ•´æ•°)
- **å“åº”**: HTTP 200 æˆåŠŸ

#### è·å–è®¢å•åˆ—è¡¨

- **URL**: `GET /orders`
- **æè¿°**: è·å–è®¢å•åˆ—è¡¨ï¼ˆæ”¯æŒç­›é€‰ï¼‰
- **æŸ¥è¯¢å‚æ•°**:
  - `skip`: è·³è¿‡è®°å½•æ•° (é»˜è®¤: 0)
  - `limit`: è¿”å›è®°å½•æ•° (é»˜è®¤: 100)
  - `user_id`: ç”¨æˆ·IDç­›é€‰ (å¯é€‰)
  - `product_id`: å•†å“IDç­›é€‰ (å¯é€‰)
  - `application_id`: åº”ç”¨IDç­›é€‰ (å¯é€‰)
- **å“åº”**: è®¢å•åˆ—è¡¨æ•°ç»„

### 4. æ”¯ä»˜ç®¡ç† API

#### åˆ›å»ºæ”¯ä»˜è®°å½•

- **URL**: `POST /payments`
- **æè¿°**: åˆ›å»ºæ–°çš„æ”¯ä»˜è®°å½•
- **è¯·æ±‚ä½“**:

```json
{
    "order_id": 1,
    "payment_method": "alipay_qr",
    "payment_price": 99.99,
    "payment_status": "pending",
    "callback_url": "http://example.com/callback",
    "payment_url": "https://qr.alipay.com/xxx"
}
```

- **å“åº”**:

```json
{
    "id": 1,
    "order_id": 1,
    "payment_method": "alipay_qr",
    "payment_price": 99.99,
    "payment_status": "pending",
    "callback_url": "http://example.com/callback",
    "payment_url": "https://qr.alipay.com/xxx",
    "created_at": "2024-12-01T10:00:00Z",
    "updated_at": "2024-12-01T10:00:00Z",
    "order": {
        "id": 1,
        "order_number": "ORD20241201123456789",
        "user_id": "user123",
        "total_price": 99.99,
        "quantity": 1,
        "created_at": "2024-12-01T10:00:00Z",
        "updated_at": "2024-12-01T10:00:00Z",
        "product_id": 1
    }
}
```

#### è·å–æ”¯ä»˜è¯¦æƒ…

- **URL**: `GET /payments/{payment_id}`
- **æè¿°**: æ ¹æ®æ”¯ä»˜IDè·å–æ”¯ä»˜è¯¦æƒ…
- **è·¯å¾„å‚æ•°**:
  - `payment_id`: æ”¯ä»˜ID (æ•´æ•°)
- **å“åº”**: åŒåˆ›å»ºæ”¯ä»˜è®°å½•å“åº”æ ¼å¼

#### æ›´æ–°æ”¯ä»˜è®°å½•

- **URL**: `PUT /payments/{payment_id}`
- **æè¿°**: æ›´æ–°æ”¯ä»˜è®°å½•
- **è·¯å¾„å‚æ•°**:
  - `payment_id`: æ”¯ä»˜ID (æ•´æ•°)
- **è¯·æ±‚ä½“**:

```json
{
    "payment_status": "paid",
    "payment_url": "https://new.payment.url"
}
```

- **å“åº”**: åŒåˆ›å»ºæ”¯ä»˜è®°å½•å“åº”æ ¼å¼

#### åˆ é™¤æ”¯ä»˜è®°å½•

- **URL**: `DELETE /payments/{payment_id}`
- **æè¿°**: åˆ é™¤æŒ‡å®šæ”¯ä»˜è®°å½•
- **è·¯å¾„å‚æ•°**:
  - `payment_id`: æ”¯ä»˜ID (æ•´æ•°)
- **å“åº”**: HTTP 200 æˆåŠŸ

#### è·å–æ”¯ä»˜åˆ—è¡¨

- **URL**: `GET /payments`
- **æè¿°**: è·å–æ”¯ä»˜è®°å½•åˆ—è¡¨
- **æŸ¥è¯¢å‚æ•°**:
  - `skip`: è·³è¿‡è®°å½•æ•° (é»˜è®¤: 0)
  - `limit`: è¿”å›è®°å½•æ•° (é»˜è®¤: 100)
- **å“åº”**: æ”¯ä»˜è®°å½•åˆ—è¡¨æ•°ç»„

### 5. æ”¯ä»˜å®æ”¯ä»˜ API

#### åˆ›å»ºæ”¯ä»˜å®è®¢å•

- **URL**: `POST /alipay/pay_qr/create_order/`
- **æè¿°**: åˆ›å»ºæ”¯ä»˜å®æ”¯ä»˜è®¢å•
- **è¯·æ±‚ä½“**:

```json
{
    "user_id": "user123",
    "product_id": 1,
    "payment_price": 99.99,
    "quantity": 1
}
```

- **å“åº”**:

```json
{
    "user_id": "user123",
    "product_id": 1,
    "order_number": "ORD20241201123456789",
    "total_price": 99.99,
    "payment_price": 99.99,
    "quantity": 1,
    "status": "pending"
}
```

#### å‘èµ·æ”¯ä»˜å®æ”¯ä»˜

- **URL**: `POST /alipay/pay_qr/pay/`
- **æè¿°**: å‘èµ·æ”¯ä»˜å®äºŒç»´ç æ”¯ä»˜
- **è¯·æ±‚ä½“**:

```json
{
    "order_number": "ORD20241201123456789",
    "callback_url": "http://example.com/callback"
}
```

- **å“åº”**:

```json
{
    "order_number": "ORD20241201123456789",
    "payment_status": "pending",
    "payment_price": 99.99,
    "quantity": 1,
    "order_id": 1,
    "product_name": "å•†å“åç§°",
    "app_name": "åº”ç”¨åç§°",
    "qr_uri": "https://qr.alipay.com/xxx"
}
```

#### æŸ¥è¯¢æ”¯ä»˜å®æ”¯ä»˜çŠ¶æ€

- **URL**: `GET /alipay/pay_qr/payment_status/{order_number}`
- **æè¿°**: æŸ¥è¯¢æ”¯ä»˜å®æ”¯ä»˜çŠ¶æ€
- **è·¯å¾„å‚æ•°**:
  - `order_number`: è®¢å•å· (å­—ç¬¦ä¸²)
- **å“åº”**: åŒå‘èµ·æ”¯ä»˜å®æ”¯ä»˜å“åº”æ ¼å¼

### 6. é”™è¯¯å“åº”æ ¼å¼

æ‰€æœ‰APIåœ¨å‘ç”Ÿé”™è¯¯æ—¶è¿”å›ç»Ÿä¸€æ ¼å¼ï¼š

```json
{
    "detail": "é”™è¯¯è¯¦æƒ…æè¿°",
    "error_code": "å…·ä½“é”™è¯¯ä»£ç ",
    "http_status_code": 400
}
```

å¸¸è§é”™è¯¯ä»£ç ï¼š

- `å•†å“ä¸å­˜åœ¨`: 404 - æŒ‡å®šå•†å“ä¸å­˜åœ¨
- `è®¢å•å·ä¸å­˜åœ¨`: 404 - æŒ‡å®šè®¢å•ä¸å­˜åœ¨
- `æ”¯ä»˜å•å·ä¸å­˜åœ¨`: 404 - æŒ‡å®šæ”¯ä»˜è®°å½•ä¸å­˜åœ¨
- `ç”¨æˆ·ä¸å­˜åœ¨`: 404 - æŒ‡å®šç”¨æˆ·ä¸å­˜åœ¨
- `æ–°å¢æ•°æ®å¤±è´¥`: 500 - åˆ›å»ºæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯
- `æ›´æ–°æ•°æ®å¤±è´¥`: 500 - æ›´æ–°æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯
- `åˆ é™¤æ•°æ®å¤±è´¥`: 500 - åˆ é™¤æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯

## ğŸ—„ï¸ CRUDæ“ä½œè¯¦ç»†æŒ‡å—

æœ¬èŠ‚æä¾›æ‰€æœ‰æ•°æ®åº“CRUDæ“ä½œçš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œæ‚¨å¯ä»¥ç›´æ¥åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨è¿™äº›å‡½æ•°ã€‚

### ğŸ“‹ CRUDå‡½æ•°å¿«é€Ÿå‚è€ƒ

| æ¨¡å—             | åŠŸèƒ½                          | åˆ›å»º                  | è¯»å–               | æ›´æ–°                  | åˆ é™¤                  | åˆ—è¡¨                |
| ---------------- | ----------------------------- | --------------------- | ------------------ | --------------------- | --------------------- | ------------------- |
| **åº”ç”¨ç®¡ç†**     | `crud1_applications.py`       | `create_application`  | `get_application`  | `update_application`  | `delete_application`  | `list_applications` |
| **å•†å“ç®¡ç†**     | `crud2_products.py`           | `create_product`      | `get_product`      | `update_product`      | `delete_product`      | `get_products`      |
| **è®¢å•ç®¡ç†**     | `crud3_orders.py`             | `create_order`        | `get_order`        | `update_order`        | `delete_order`        | `list_orders`       |
| **æ”¯ä»˜ç®¡ç†**     | `crud4_payments.py`           | `create_payment`      | `get_payment`      | `update_payment`      | `delete_payment`      | `list_payments`     |
| **ç”¨æˆ·ç®¡ç†**     | `crudæ´»åŠ¨è¡¨1_ç”¨æˆ·.py`         | `create_user`         | `get_user`         | -                     | `delete_user`         | `list_users`        |
| **æ”¯ä»˜è½¬æ¢æƒé™** | `crudæ´»åŠ¨è¡¨2_æ”¯ä»˜è½¬æ¢æƒé™.py` | `create_æ”¯ä»˜è½¬æ¢æƒé™` | `get_æ”¯ä»˜è½¬æ¢æƒé™` | `update_æ”¯ä»˜è½¬æ¢æƒé™` | `delete_æ”¯ä»˜è½¬æ¢æƒé™` | `list_æ”¯ä»˜è½¬æ¢æƒé™` |
| **ä¿ƒé”€æ´»åŠ¨**     | `crudæ´»åŠ¨è¡¨3_ä¿ƒé”€æ´»åŠ¨.py`     | `create_promotion`    | `get_promotion`    | `update_promotion`    | `delete_promotion`    | `list_promotions`   |
| **ä¼˜æƒ åˆ¸**       | `crudæ´»åŠ¨è¡¨4_ä¼˜æƒ åˆ¸.py`       | `create_coupon`       | `get_coupon`       | `update_coupon`       | `delete_coupon`       | `list_coupons`      |
| **ç”¨æˆ·ä¼˜æƒ åˆ¸**   | `crudæ´»åŠ¨è¡¨5_ç”¨æˆ·ä¼˜æƒ åˆ¸.py`   | `create_ç”¨æˆ·ä¼˜æƒ åˆ¸`   | `get_ç”¨æˆ·ä¼˜æƒ åˆ¸`   | `update_ç”¨æˆ·ä¼˜æƒ åˆ¸`   | `delete_ç”¨æˆ·ä¼˜æƒ åˆ¸`   | `list_ç”¨æˆ·ä¼˜æƒ åˆ¸`   |

### æ•°æ®åº“è¿æ¥

æ‰€æœ‰CRUDæ“ä½œéƒ½éœ€è¦æ•°æ®åº“ä¼šè¯ï¼Œä½¿ç”¨ä»¥ä¸‹æ–¹å¼è·å–ï¼š

```python
from svc_order_zxw.db.get_db import get_db

async def your_business_function():
    async with get_db() as db:
        # åœ¨è¿™é‡Œä½¿ç”¨CRUDå‡½æ•°
        pass
```

### 1. åº”ç”¨ç®¡ç† CRUD (`crud1_applications.py`)

#### 1.1 åˆ›å»ºåº”ç”¨

```python
from svc_order_zxw.db.crud1_applications import create_application, PYD_ApplicationCreate

async def create_app():
    async with get_db() as db:
        app_data = PYD_ApplicationCreate(name="æˆ‘çš„åº”ç”¨")
        app = await create_application(db, app_data)
        return app
```

#### 1.2 è·å–åº”ç”¨

```python
from svc_order_zxw.db.crud1_applications import get_application

async def get_app():
    async with get_db() as db:
        # é€šè¿‡IDè·å–
        app = await get_application(db, 1, include_products=True)
        # é€šè¿‡åç§°è·å–
        app = await get_application(db, "åº”ç”¨åç§°", include_products=True)
        return app
```

#### 1.3 æ›´æ–°åº”ç”¨

```python
from svc_order_zxw.db.crud1_applications import update_application, PYD_ApplicationUpdate

async def update_app():
    async with get_db() as db:
        update_data = PYD_ApplicationUpdate(name="æ–°åº”ç”¨åç§°")
        app = await update_application(db, 1, update_data)
        return app
```

#### 1.4 åˆ é™¤åº”ç”¨

```python
from svc_order_zxw.db.crud1_applications import delete_application

async def delete_app():
    async with get_db() as db:
        success = await delete_application(db, 1)
        return success
```

#### 1.5 åˆ—å‡ºåº”ç”¨

```python
from svc_order_zxw.db.crud1_applications import list_applications

async def list_apps():
    async with get_db() as db:
        apps = await list_applications(db, skip=0, limit=10, include_products=True)
        return apps
```

### 2. å•†å“ç®¡ç† CRUD (`crud2_products.py`)

#### 2.1 åˆ›å»ºå•†å“

```python
from svc_order_zxw.db.crud2_products import create_product, PYD_ProductCreate

async def create_new_product():
    async with get_db() as db:
        product_data = PYD_ProductCreate(
            name="æµ‹è¯•å•†å“",
            app_id=1,
            price=99.99
        )
        product = await create_product(db, product_data)
        return product
```

#### 2.2 è·å–å•†å“

```python
from svc_order_zxw.db.crud2_products import get_product

async def get_product_info():
    async with get_db() as db:
        product = await get_product(db, 1)
        return product
```

#### 2.3 æ›´æ–°å•†å“

```python
from svc_order_zxw.db.crud2_products import update_product, PYD_ProductUpdate

async def update_product_info():
    async with get_db() as db:
        update_data = PYD_ProductUpdate(
            name="æ›´æ–°çš„å•†å“åç§°",
            price=199.99
        )
        product = await update_product(db, 1, update_data)
        return product
```

#### 2.4 åˆ é™¤å•†å“

```python
from svc_order_zxw.db.crud2_products import delete_product

async def delete_product_by_id():
    async with get_db() as db:
        success = await delete_product(db, 1)
        return success
```

#### 2.5 åˆ—å‡ºå•†å“

```python
from svc_order_zxw.db.crud2_products import get_products

async def list_all_products():
    async with get_db() as db:
        products = await get_products(db, skip=0, limit=100)
        return products
```

### 3. è®¢å•ç®¡ç† CRUD (`crud3_orders.py`)

#### 3.1 åˆ›å»ºè®¢å•

```python
from svc_order_zxw.db.crud3_orders import create_order, PYD_OrderCreate

async def create_new_order():
    async with get_db() as db:
        order_data = PYD_OrderCreate(
            user_id="user123",
            product_id=1,
            total_price=99.99,
            quantity=2
        )
        order = await create_order(
            db, order_data,
            include_product=True,
            include_application=True
        )
        return order
```

#### 3.2 è·å–è®¢å•

```python
from svc_order_zxw.db.crud3_orders import get_order

async def get_order_info():
    async with get_db() as db:
        # é€šè¿‡è®¢å•IDè·å–
        order = await get_order(
            db, 1,
            include_product=True,
            include_application=True,
            include_payment=True
        )
        # é€šè¿‡è®¢å•å·è·å–
        order = await get_order(
            db, "ORD20241201123456789",
            include_product=True
        )
        return order
```

#### 3.3 æ›´æ–°è®¢å•

```python
from svc_order_zxw.db.crud3_orders import update_order, PYD_OrderUpdate

async def update_order_info():
    async with get_db() as db:
        update_data = PYD_OrderUpdate(
            total_price=199.99,
            quantity=3
        )
        order = await update_order(db, 1, update_data)
        return order
```

#### 3.4 åˆ é™¤è®¢å•

```python
from svc_order_zxw.db.crud3_orders import delete_order

async def delete_order_by_id():
    async with get_db() as db:
        success = await delete_order(db, 1)
        return success
```

#### 3.5 åˆ—å‡ºè®¢å•ï¼ˆæ”¯æŒç­›é€‰ï¼‰

```python
from svc_order_zxw.db.crud3_orders import list_orders, PYD_OrderFilter

async def list_filtered_orders():
    async with get_db() as db:
        filter_data = PYD_OrderFilter(
            user_id="user123",  # ç­›é€‰ç‰¹å®šç”¨æˆ·çš„è®¢å•
            product_id=1,       # ç­›é€‰ç‰¹å®šå•†å“çš„è®¢å•
            application_id=1    # ç­›é€‰ç‰¹å®šåº”ç”¨çš„è®¢å•
        )
        orders = await list_orders(
            db, filter_data,
            skip=0, limit=100,
            include_product=True,
            include_application=True
        )
        return orders
```

### 4. æ”¯ä»˜ç®¡ç† CRUD (`crud4_payments.py`)

#### 4.1 åˆ›å»ºæ”¯ä»˜è®°å½•

```python
from svc_order_zxw.db.crud4_payments import create_payment, PYD_PaymentCreate
from svc_order_zxw.apis.schemas_payments import PaymentMethod, OrderStatus

async def create_payment_record():
    async with get_db() as db:
        payment_data = PYD_PaymentCreate(
            order_id=1,
            payment_method=PaymentMethod.ALIPAY_QR,
            payment_price=99.99,
            payment_status=OrderStatus.PENDING,
            callback_url="http://example.com/callback",
            payment_url="https://qr.alipay.com/xxx"
        )
        payment = await create_payment(db, payment_data, include_order=True)
        return payment
```

#### 4.2 è·å–æ”¯ä»˜è®°å½•

```python
from svc_order_zxw.db.crud4_payments import get_payment

async def get_payment_info():
    async with get_db() as db:
        # é€šè¿‡æ”¯ä»˜IDè·å–
        payment = await get_payment(db, payment_id=1, include_order=True)
        # é€šè¿‡è®¢å•å·è·å–
        payment = await get_payment(db, order_number="ORD20241201123456789", include_order=True)
        return payment
```

#### 4.3 æ›´æ–°æ”¯ä»˜è®°å½•

```python
from svc_order_zxw.db.crud4_payments import update_payment, PYD_PaymentUpdate

async def update_payment_status():
    async with get_db() as db:
        update_data = PYD_PaymentUpdate(
            payment_status=OrderStatus.PAID,
            payment_url="https://new.payment.url"
        )
        payment = await update_payment(db, 1, update_data, include_order=True)
        return payment
```

#### 4.4 åˆ é™¤æ”¯ä»˜è®°å½•

```python
from svc_order_zxw.db.crud4_payments import delete_payment

async def delete_payment_record():
    async with get_db() as db:
        success = await delete_payment(db, 1)
        return success
```

#### 4.5 åˆ—å‡ºæ”¯ä»˜è®°å½•

```python
from svc_order_zxw.db.crud4_payments import list_payments

async def list_payment_records():
    async with get_db() as db:
        payments = await list_payments(db, skip=0, limit=100, include_order=True)
        return payments
```

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### 1. åˆ›å»ºè®¢å•

```python
from svc_order_zxw.db.crud3_orders import create_order
from svc_order_zxw.db.get_db import get_db

async def create_new_order():
    async with get_db() as db:
        order_data = {
            "product_id": 1,
            "quantity": 2,
            "total_amount": 199.98,
            "user_id": 1
        }
        order = await create_order(db, order_data)
        return order
```

### 2. æ”¯ä»˜å®æ”¯ä»˜

```python
from svc_order_zxw.interface.interface_æ”¯ä»˜å®æ”¯ä»˜ import åˆ›å»ºæ”¯ä»˜è®¢å•

async def create_alipay_order():
    æ”¯ä»˜è®¢å• = await åˆ›å»ºæ”¯ä»˜è®¢å•(
        order_number="ORDER_20241201_001",
        total_amount=99.99,
        subject="å•†å“åç§°",
        return_url="http://localhost:8000/success"
    )
    return æ”¯ä»˜è®¢å•
```

### 3. å•†å“ç®¡ç†

```python
from svc_order_zxw.db.crud2_products import create_product, get_products

async def manage_products():
    async with get_db() as db:
        # åˆ›å»ºå•†å“
        product_data = {
            "name": "æµ‹è¯•å•†å“",
            "price": 99.99,
            "description": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å•†å“",
            "stock": 100
        }
        product = await create_product(db, product_data)

        # æŸ¥è¯¢æ‰€æœ‰å•†å“
        products = await get_products(db)
        return products
```

### 5. ç”¨æˆ·ç®¡ç† CRUD (`crudæ´»åŠ¨è¡¨1_ç”¨æˆ·.py`)

#### 5.1 åˆ›å»ºç”¨æˆ·

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨1_ç”¨æˆ· import create_user

async def create_new_user():
    async with get_db() as db:
        user = await create_user(db, external_user_id=12345)
        return user
```

#### 5.2 è·å–ç”¨æˆ·

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨1_ç”¨æˆ· import get_user

async def get_user_info():
    async with get_db() as db:
        user = await get_user(
            db, 12345,
            include_æ”¯ä»˜è½¬æ¢æƒé™=True,
            include_ç”¨æˆ·ä¼˜æƒ åˆ¸=True
        )
        return user
```

#### 5.3 åˆ é™¤ç”¨æˆ·

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨1_ç”¨æˆ· import delete_user

async def delete_user_by_id():
    async with get_db() as db:
        success = await delete_user(db, 12345)
        return success
```

#### 5.4 åˆ—å‡ºç”¨æˆ·

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨1_ç”¨æˆ· import list_users

async def list_all_users():
    async with get_db() as db:
        users = await list_users(
            db, skip=0, limit=100,
            include_æ”¯ä»˜è½¬æ¢æƒé™=True,
            include_ç”¨æˆ·ä¼˜æƒ åˆ¸=True
        )
        return users
```

### 6. æ”¯ä»˜è½¬æ¢æƒé™ç®¡ç† CRUD (`crudæ´»åŠ¨è¡¨2_æ”¯ä»˜è½¬æ¢æƒé™.py`)

#### 6.1 åˆ›å»ºæ”¯ä»˜è½¬æ¢æƒé™

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨2_æ”¯ä»˜è½¬æ¢æƒé™ import create_æ”¯ä»˜è½¬æ¢æƒé™

async def create_payment_permission():
    async with get_db() as db:
        permission = await create_æ”¯ä»˜è½¬æ¢æƒé™(
            db,
            user_id=12345,
            isCharged=True,
            order_number="ORD20241201123456789"  # å¯é€‰
        )
        return permission
```

#### 6.2 è·å–æ”¯ä»˜è½¬æ¢æƒé™

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨2_æ”¯ä»˜è½¬æ¢æƒé™ import get_æ”¯ä»˜è½¬æ¢æƒé™

async def get_payment_permission():
    async with get_db() as db:
        # é€šè¿‡æƒé™IDè·å–
        permission = await get_æ”¯ä»˜è½¬æ¢æƒé™(
            db, æ”¯ä»˜è½¬æ¢æƒé™_id=1,
            include_user=True,
            include_order=True
        )
        # é€šè¿‡è®¢å•å·è·å–
        permission = await get_æ”¯ä»˜è½¬æ¢æƒé™(
            db, order_number="ORD20241201123456789",
            include_user=True
        )
        return permission
```

#### 6.3 æ›´æ–°æ”¯ä»˜è½¬æ¢æƒé™

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨2_æ”¯ä»˜è½¬æ¢æƒé™ import update_æ”¯ä»˜è½¬æ¢æƒé™

async def update_payment_permission():
    async with get_db() as db:
        permission = await update_æ”¯ä»˜è½¬æ¢æƒé™(
            db, 1,
            isCharged=False,
            order_number="NEW_ORDER_NUMBER"
        )
        return permission
```

#### 6.4 åˆ é™¤æ”¯ä»˜è½¬æ¢æƒé™

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨2_æ”¯ä»˜è½¬æ¢æƒé™ import delete_æ”¯ä»˜è½¬æ¢æƒé™

async def delete_payment_permission():
    async with get_db() as db:
        success = await delete_æ”¯ä»˜è½¬æ¢æƒé™(db, 1)
        return success
```

#### 6.5 åˆ—å‡ºæ”¯ä»˜è½¬æ¢æƒé™

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨2_æ”¯ä»˜è½¬æ¢æƒé™ import list_æ”¯ä»˜è½¬æ¢æƒé™

async def list_payment_permissions():
    async with get_db() as db:
        permissions = await list_æ”¯ä»˜è½¬æ¢æƒé™(
            db, user_id=12345,
            skip=0, limit=100
        )
        return permissions
```

### 7. ä¿ƒé”€æ´»åŠ¨ç®¡ç† CRUD (`crudæ´»åŠ¨è¡¨3_ä¿ƒé”€æ´»åŠ¨.py`)

#### 7.1 åˆ›å»ºä¿ƒé”€æ´»åŠ¨

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨3_ä¿ƒé”€æ´»åŠ¨ import create_promotion, PYD_CreatePromotion, DiscountType
from datetime import date

async def create_new_promotion():
    async with get_db() as db:
        promotion_data = PYD_CreatePromotion(
            name="åŒåä¸€ç‰¹ä»·",
            threshold=100.0,  # æ»¡100å…ƒ
            discount_type=DiscountType.æŠ˜æ‰£,
            discount_value=0.8,  # 8æŠ˜
            start_date=date(2024, 11, 1),
            end_date=date(2024, 11, 11),
            is_active=True,
            product_id=1
        )
        promotion = await create_promotion(db, promotion_data)
        return promotion
```

#### 7.2 è·å–ä¿ƒé”€æ´»åŠ¨

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨3_ä¿ƒé”€æ´»åŠ¨ import get_promotion

async def get_promotion_info():
    async with get_db() as db:
        promotion = await get_promotion(db, 1, include_product=True)
        return promotion
```

#### 7.3 æ›´æ–°ä¿ƒé”€æ´»åŠ¨

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨3_ä¿ƒé”€æ´»åŠ¨ import update_promotion, PYD_UpdatePromotion

async def update_promotion_info():
    async with get_db() as db:
        update_data = PYD_UpdatePromotion(
            name="åŒåä¸€è¶…çº§ç‰¹ä»·",
            discount_value=0.7,  # æ”¹ä¸º7æŠ˜
            is_active=False
        )
        promotion = await update_promotion(db, 1, update_data)
        return promotion
```

#### 7.4 åˆ é™¤ä¿ƒé”€æ´»åŠ¨

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨3_ä¿ƒé”€æ´»åŠ¨ import delete_promotion

async def delete_promotion_by_id():
    async with get_db() as db:
        success = await delete_promotion(db, 1)
        return success
```

#### 7.5 åˆ—å‡ºä¿ƒé”€æ´»åŠ¨

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨3_ä¿ƒé”€æ´»åŠ¨ import list_promotions, PYD_PromotionFilter

async def list_active_promotions():
    async with get_db() as db:
        filter_data = PYD_PromotionFilter(
            product_id=1,     # ç­›é€‰ç‰¹å®šå•†å“çš„ä¿ƒé”€
            is_active=True    # åªè¦æ¿€æ´»çš„ä¿ƒé”€
        )
        promotions = await list_promotions(
            db, filter_data,
            skip=0, limit=100,
            include_product=True
        )
        return promotions
```

### 8. ä¼˜æƒ åˆ¸ç®¡ç† CRUD (`crudæ´»åŠ¨è¡¨4_ä¼˜æƒ åˆ¸.py`)

#### 8.1 åˆ›å»ºä¼˜æƒ åˆ¸

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨4_ä¼˜æƒ åˆ¸ import create_coupon
from datetime import date

async def create_new_coupon():
    async with get_db() as db:
        coupon = await create_coupon(
            db,
            code="DISCOUNT10",
            discount_value=10.0,  # 10å…ƒä¼˜æƒ 
            expiration_date=date(2024, 12, 31),
            promotion_id=1
        )
        return coupon
```

#### 8.2 è·å–ä¼˜æƒ åˆ¸

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨4_ä¼˜æƒ åˆ¸ import get_coupon

async def get_coupon_info():
    async with get_db() as db:
        coupon = await get_coupon(db, 1, include_promotion=True)
        return coupon
```

#### 8.3 æ›´æ–°ä¼˜æƒ åˆ¸

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨4_ä¼˜æƒ åˆ¸ import update_coupon
from datetime import date

async def update_coupon_info():
    async with get_db() as db:
        coupon = await update_coupon(
            db, 1,
            code="NEWDISCOUNT15",
            discount_value=15.0,
            expiration_date=date(2025, 1, 31)
        )
        return coupon
```

#### 8.4 åˆ é™¤ä¼˜æƒ åˆ¸

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨4_ä¼˜æƒ åˆ¸ import delete_coupon

async def delete_coupon_by_id():
    async with get_db() as db:
        success = await delete_coupon(db, 1)
        return success
```

#### 8.5 åˆ—å‡ºä¼˜æƒ åˆ¸

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨4_ä¼˜æƒ åˆ¸ import list_coupons, PYD_ä¼˜æƒ åˆ¸Filter
from datetime import date

async def list_active_coupons():
    async with get_db() as db:
        filter_data = PYD_ä¼˜æƒ åˆ¸Filter(
            promotion_id=1,  # ç‰¹å®šä¿ƒé”€æ´»åŠ¨çš„ä¼˜æƒ åˆ¸
            expiration_date_after=date.today()  # æœªè¿‡æœŸçš„ä¼˜æƒ åˆ¸
        )
        coupons = await list_coupons(
            db, filter_data,
            skip=0, limit=100,
            include_promotion=True
        )
        return coupons
```

### 9. ç”¨æˆ·ä¼˜æƒ åˆ¸ç®¡ç† CRUD (`crudæ´»åŠ¨è¡¨5_ç”¨æˆ·ä¼˜æƒ åˆ¸.py`)

#### 9.1 åˆ†é…ä¼˜æƒ åˆ¸ç»™ç”¨æˆ·

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨5_ç”¨æˆ·ä¼˜æƒ åˆ¸ import create_ç”¨æˆ·ä¼˜æƒ åˆ¸

async def assign_coupon_to_user():
    async with get_db() as db:
        user_coupon = await create_ç”¨æˆ·ä¼˜æƒ åˆ¸(db, user_id=12345, coupon_id=1)
        return user_coupon
```

#### 9.2 è·å–ç”¨æˆ·ä¼˜æƒ åˆ¸

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨5_ç”¨æˆ·ä¼˜æƒ åˆ¸ import get_ç”¨æˆ·ä¼˜æƒ åˆ¸

async def get_user_coupon():
    async with get_db() as db:
        user_coupon = await get_ç”¨æˆ·ä¼˜æƒ åˆ¸(
            db, 1,
            include_user=True,
            include_coupon=True
        )
        return user_coupon
```

#### 9.3 æ›´æ–°ç”¨æˆ·ä¼˜æƒ åˆ¸çŠ¶æ€

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨5_ç”¨æˆ·ä¼˜æƒ åˆ¸ import update_ç”¨æˆ·ä¼˜æƒ åˆ¸

async def mark_coupon_as_used():
    async with get_db() as db:
        user_coupon = await update_ç”¨æˆ·ä¼˜æƒ åˆ¸(db, 1, is_used=True)
        return user_coupon
```

#### 9.4 åˆ é™¤ç”¨æˆ·ä¼˜æƒ åˆ¸

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨5_ç”¨æˆ·ä¼˜æƒ åˆ¸ import delete_ç”¨æˆ·ä¼˜æƒ åˆ¸

async def remove_user_coupon():
    async with get_db() as db:
        success = await delete_ç”¨æˆ·ä¼˜æƒ åˆ¸(db, 1)
        return success
```

#### 9.5 åˆ—å‡ºç”¨æˆ·ä¼˜æƒ åˆ¸

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨5_ç”¨æˆ·ä¼˜æƒ åˆ¸ import list_ç”¨æˆ·ä¼˜æƒ åˆ¸

async def list_user_coupons():
    async with get_db() as db:
        user_coupons = await list_ç”¨æˆ·ä¼˜æƒ åˆ¸(
            db, user_id=12345,
            skip=0, limit=100
        )
        return user_coupons
```

### CRUDæ“ä½œæœ€ä½³å®è·µ

#### 1. å¼‚å¸¸å¤„ç†

```python
from app_tools_zxw.Errors.api_errors import HTTPException_AppToolsSZXW

async def safe_create_order():
    try:
        async with get_db() as db:
            order = await create_order(db, order_data)
            return order
    except HTTPException_AppToolsSZXW as e:
        print(f"ä¸šåŠ¡å¼‚å¸¸: {e.detail}")
        raise
    except Exception as e:
        print(f"ç³»ç»Ÿå¼‚å¸¸: {str(e)}")
        raise
```

#### 2. äº‹åŠ¡ç®¡ç†

```python
async def complex_business_operation():
    async with get_db() as db:
        try:
            # åˆ›å»ºè®¢å•
            order = await create_order(db, order_data)
            # åˆ›å»ºæ”¯ä»˜è®°å½•
            payment = await create_payment(db, payment_data)
            # åˆ†é…ä¼˜æƒ åˆ¸
            user_coupon = await create_ç”¨æˆ·ä¼˜æƒ åˆ¸(db, user_id, coupon_id)

            # å¦‚æœæ‰€æœ‰æ“ä½œæˆåŠŸï¼Œäº‹åŠ¡ä¼šè‡ªåŠ¨æäº¤
            return {"order": order, "payment": payment, "user_coupon": user_coupon}
        except Exception as e:
            # å‡ºç°å¼‚å¸¸æ—¶ï¼Œäº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
            raise
```

#### 3. æ‰¹é‡æ“ä½œä¼˜åŒ–

```python
async def batch_create_orders(order_list):
    async with get_db() as db:
        orders = []
        for order_data in order_list:
            order = await create_order(db, order_data)
            orders.append(order)
        return orders
```

### ğŸ¯ å¸¸ç”¨æ•°æ®ç±»å‹ä¸æšä¸¾

#### Pydanticæ¨¡å‹ç±»å‹

| æ¨¡å—         | åˆ›å»ºç±»å‹                | æ›´æ–°ç±»å‹                | å“åº”ç±»å‹                  | ç­›é€‰ç±»å‹              |
| ------------ | ----------------------- | ----------------------- | ------------------------- | --------------------- |
| **åº”ç”¨ç®¡ç†** | `PYD_ApplicationCreate` | `PYD_ApplicationUpdate` | `PYD_ApplicationResponse` | -                     |
| **å•†å“ç®¡ç†** | `PYD_ProductCreate`     | `PYD_ProductUpdate`     | `PYD_ProductResponse`     | -                     |
| **è®¢å•ç®¡ç†** | `PYD_OrderCreate`       | `PYD_OrderUpdate`       | `PYD_OrderResponse`       | `PYD_OrderFilter`     |
| **æ”¯ä»˜ç®¡ç†** | `PYD_PaymentCreate`     | `PYD_PaymentUpdate`     | `PYD_PaymentResponse`     | -                     |
| **ä¿ƒé”€æ´»åŠ¨** | `PYD_CreatePromotion`   | `PYD_UpdatePromotion`   | `PYD_PromotionResponse`   | `PYD_PromotionFilter` |
| **ä¼˜æƒ åˆ¸**   | -                       | -                       | `PYD_ä¼˜æƒ åˆ¸Response`      | `PYD_ä¼˜æƒ åˆ¸Filter`    |

#### æšä¸¾ç±»å‹

```python
# æ”¯ä»˜æ–¹å¼æšä¸¾
from svc_order_zxw.apis.schemas_payments import PaymentMethod
PaymentMethod.WECHAT_H5     # å¾®ä¿¡H5æ”¯ä»˜
PaymentMethod.WECHAT_QR     # å¾®ä¿¡äºŒç»´ç æ”¯ä»˜
PaymentMethod.ALIPAY_H5     # æ”¯ä»˜å®H5æ”¯ä»˜
PaymentMethod.ALIPAY_QR     # æ”¯ä»˜å®äºŒç»´ç æ”¯ä»˜

# è®¢å•çŠ¶æ€æšä¸¾
from svc_order_zxw.apis.schemas_payments import OrderStatus
OrderStatus.PENDING         # å¾…æ”¯ä»˜
OrderStatus.PAID           # å·²æ”¯ä»˜
OrderStatus.FAILED         # æ”¯ä»˜å¤±è´¥
OrderStatus.CANCELLED      # å·²å–æ¶ˆ
OrderStatus.FINISHED       # äº¤æ˜“å®Œæˆ

# æŠ˜æ‰£ç±»å‹æšä¸¾
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨3_ä¿ƒé”€æ´»åŠ¨ import DiscountType
DiscountType.é‡‘é¢          # é‡‘é¢æŠ˜æ‰£
DiscountType.æŠ˜æ‰£          # ç™¾åˆ†æ¯”æŠ˜æ‰£
DiscountType.ä¼˜æƒ åˆ¸        # ä¼˜æƒ åˆ¸
```

#### å¸¸ç”¨å¯¼å…¥è¯­å¥

```python
# æ•°æ®åº“è¿æ¥
from svc_order_zxw.db.get_db import get_db

# åº”ç”¨ç®¡ç†
from svc_order_zxw.db.crud1_applications import (
    create_application, get_application, update_application,
    delete_application, list_applications,
    PYD_ApplicationCreate, PYD_ApplicationUpdate, PYD_ApplicationResponse
)

# å•†å“ç®¡ç†
from svc_order_zxw.db.crud2_products import (
    create_product, get_product, update_product, delete_product, get_products,
    PYD_ProductCreate, PYD_ProductUpdate, PYD_ProductResponse
)

# è®¢å•ç®¡ç†
from svc_order_zxw.db.crud3_orders import (
    create_order, get_order, update_order, delete_order, list_orders,
    PYD_OrderCreate, PYD_OrderUpdate, PYD_OrderResponse, PYD_OrderFilter
)

# æ”¯ä»˜ç®¡ç†
from svc_order_zxw.db.crud4_payments import (
    create_payment, get_payment, update_payment, delete_payment, list_payments,
    PYD_PaymentCreate, PYD_PaymentUpdate, PYD_PaymentResponse
)

# ç”¨æˆ·ç®¡ç†
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨1_ç”¨æˆ· import (
    create_user, get_user, delete_user, list_users
)

# æ”¯ä»˜è½¬æ¢æƒé™ç®¡ç†
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨2_æ”¯ä»˜è½¬æ¢æƒé™ import (
    create_æ”¯ä»˜è½¬æ¢æƒé™, get_æ”¯ä»˜è½¬æ¢æƒé™, update_æ”¯ä»˜è½¬æ¢æƒé™,
    delete_æ”¯ä»˜è½¬æ¢æƒé™, list_æ”¯ä»˜è½¬æ¢æƒé™
)

# ä¿ƒé”€æ´»åŠ¨ç®¡ç†
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨3_ä¿ƒé”€æ´»åŠ¨ import (
    create_promotion, get_promotion, update_promotion, delete_promotion, list_promotions,
    PYD_CreatePromotion, PYD_UpdatePromotion, PYD_PromotionResponse,
    PYD_PromotionFilter, DiscountType
)

# ä¼˜æƒ åˆ¸ç®¡ç†
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨4_ä¼˜æƒ åˆ¸ import (
    create_coupon, get_coupon, update_coupon, delete_coupon, list_coupons,
    PYD_ä¼˜æƒ åˆ¸Filter
)

# ç”¨æˆ·ä¼˜æƒ åˆ¸ç®¡ç†
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨5_ç”¨æˆ·ä¼˜æƒ åˆ¸ import (
    create_ç”¨æˆ·ä¼˜æƒ åˆ¸, get_ç”¨æˆ·ä¼˜æƒ åˆ¸, update_ç”¨æˆ·ä¼˜æƒ åˆ¸,
    delete_ç”¨æˆ·ä¼˜æƒ åˆ¸, list_ç”¨æˆ·ä¼˜æƒ åˆ¸
)

# å¼‚å¸¸å¤„ç†
from app_tools_zxw.Errors.api_errors import HTTPException_AppToolsSZXW

# æ—¶é—´ç›¸å…³
from datetime import date, datetime
```

### 4. ä¼˜æƒ åˆ¸ç³»ç»Ÿ

```python
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨4_ä¼˜æƒ åˆ¸ import create_coupon
from svc_order_zxw.db.crudæ´»åŠ¨è¡¨5_ç”¨æˆ·ä¼˜æƒ åˆ¸ import create_ç”¨æˆ·ä¼˜æƒ åˆ¸

async def coupon_example():
    async with get_db() as db:
        # åˆ›å»ºä¼˜æƒ åˆ¸
        coupon = await create_coupon(
            db,
            code="NEWUSER10",
            discount_value=10.0,
            expiration_date=date(2024, 12, 31),
            promotion_id=1
        )

        # åˆ†é…ç»™ç”¨æˆ·
        user_coupon = await create_ç”¨æˆ·ä¼˜æƒ åˆ¸(db, user_id=12345, coupon_id=coupon.id)
        return {"coupon": coupon, "user_coupon": user_coupon}
```

## ğŸ”§ å¼€å‘æŒ‡å—

### è¿è¡Œæµ‹è¯•

```bash
cd svc_order_zxw
python -m pytest tests/ -v
```

### æ•°æ®åº“è¿ç§»

```bash
# å¦‚æœä½¿ç”¨Alembicè¿›è¡Œæ•°æ®åº“è¿ç§»
alembic upgrade head
```

### å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
python main.py
```

æˆ–ä½¿ç”¨uvicornï¼š

```bash
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
svc_order_zxw/
â”œâ”€â”€ db/                     # æ•°æ®åº“å±‚
â”‚   â”œâ”€â”€ models.py          # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ crud*.py           # CRUDæ“ä½œ
â”‚   â””â”€â”€ get_db.py          # æ•°æ®åº“è¿æ¥
â”œâ”€â”€ apis/                   # APIè·¯ç”±å±‚
â”‚   â”œâ”€â”€ api_å•†å“ç®¡ç†.py     # å•†å“API
â”‚   â””â”€â”€ api_æ”¯ä»˜_*/         # æ”¯ä»˜API
â”œâ”€â”€ interface/              # ä¸šåŠ¡æ¥å£å±‚
â””â”€â”€ tests/                 # æµ‹è¯•ç”¨ä¾‹
```

## ğŸ“‹ ä¾èµ–è¦æ±‚

- Python >= 3.10
- FastAPI >= 0.112.0
- SQLAlchemy == 2.0.32
- asyncpg == 0.29.0 (PostgreSQL)
- uvicorn >= 0.30.0
- app-tools-zxw >= 1.0.81

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“è¿æ¥å¤±è´¥**

   - æ£€æŸ¥ `DATABASE_URL` é…ç½®
   - ç¡®ä¿æ•°æ®åº“æœåŠ¡æ­£åœ¨è¿è¡Œ
2. **æ”¯ä»˜é…ç½®é”™è¯¯**

   - éªŒè¯æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜çš„é…ç½®å‚æ•°
   - æ£€æŸ¥è¯ä¹¦æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
3. **å¯¼å…¥é”™è¯¯**

   - ç¡®ä¿å·²æ­£ç¡®å®‰è£…æ‰€æœ‰ä¾èµ–
   - æ£€æŸ¥Pythonç‰ˆæœ¬å…¼å®¹æ€§

### æ—¥å¿—é…ç½®

é¡¹ç›®æ”¯æŒè¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œå¯ä»¥åœ¨ `logs/` ç›®å½•ä¸‹æŸ¥çœ‹è¿è¡Œæ—¥å¿—ã€‚

## ğŸ“ æ”¯æŒä¸è´¡çŒ®

- **ä½œè€…**: è–›ä¼Ÿçš„å°å·¥å…·
- **GitHub**: https://github.com/sunshineinwater/
- **é‚®ç®±**: shuiheyangguang@gmail.com

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ï¼

## ğŸ“„ è®¸å¯è¯

MIT License - è¯¦è§LICENSEæ–‡ä»¶

---

*æœ¬æ–‡æ¡£ä¼šéšç€é¡¹ç›®æ›´æ–°è€ŒæŒç»­æ›´æ–°ï¼Œè¯·å…³æ³¨æœ€æ–°ç‰ˆæœ¬ã€‚*

