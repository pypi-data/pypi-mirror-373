from enum import Enum
from typing import Any

import pydantic
from pydantic.alias_generators import to_camel


class ModelInfo(pydantic.BaseModel):
    """Defines the structure for model information."""

    provider: str
    base_model: str
    model_name: str

    model_config = pydantic.ConfigDict(alias_generator=to_camel, populate_by_name=True)


class MediaType(Enum):
    TEXT = "text"
    IMAGE = "image"


class Usage(pydantic.BaseModel):
    """A generic, provider-agnostic model for token usage."""

    prompt_tokens: int = 0
    completion_tokens: int = 0

    model_config = pydantic.ConfigDict(alias_generator=to_camel, populate_by_name=True)


class PipelineData(pydantic.BaseModel):
    """Container for data passing through pipeline steps"""

    media_type: MediaType
    content: Any
    metadata: dict[str, Any] = {}

    model_config = pydantic.ConfigDict(alias_generator=to_camel, populate_by_name=True)


class TokenSummary(pydantic.BaseModel):
    """Defines the structure for token usage in the API response."""

    input_tokens: int
    output_tokens: int
    total_tokens: int
    cost_usd: float | None = None

    model_config = pydantic.ConfigDict(alias_generator=to_camel, populate_by_name=True)


class PerformanceSummary(pydantic.BaseModel):
    """Defines the top-level structure for the performance block in the API response."""

    timing: dict[str, Any]
    trace_id: str
    tokens: TokenSummary | None = None

    model_config = pydantic.ConfigDict(alias_generator=to_camel, populate_by_name=True)


class ProgramMetadata(pydantic.BaseModel):
    """Metadata for a DSPy program signature"""

    id: str
    name: str
    version: str
    code_hash: str
    description: str = ""
    tags: list[str] = []
    parent_id: str | None = None
    parent_version: str | None = None

    model_config = pydantic.ConfigDict(alias_generator=to_camel, populate_by_name=True)


class ProgramExecutionInfo(pydantic.BaseModel):
    """Information about a specific program execution"""

    program_id: str
    program_version: str
    program_name: str
    model_id: str
    model_info: dict[str, Any] = {}
    execution_id: str
    timestamp: str
    trace_id: str | None = None

    model_config = pydantic.ConfigDict(alias_generator=to_camel, populate_by_name=True)


class ModelResponseInfo(pydantic.BaseModel):
    """Defines the structure for the 'model' block in the response metadata."""

    id: str
    provider: str
    base_model: str
    model_name: str

    model_config = pydantic.ConfigDict(alias_generator=to_camel, populate_by_name=True)


class ProgramResponseInfo(pydantic.BaseModel):
    """Defines the structure for the 'program' block in the response metadata."""

    id: str
    version: str
    name: str

    model_config = pydantic.ConfigDict(alias_generator=to_camel, populate_by_name=True)


class ResponseMetadata(pydantic.BaseModel):
    """Defines the top-level 'metadata' object in the API response."""

    execution_id: str
    timestamp: str
    program: ProgramResponseInfo | None = None
    model: ModelResponseInfo | None = None
    performance: PerformanceSummary | None = None

    model_config = pydantic.ConfigDict(alias_generator=to_camel, populate_by_name=True)


class ImageProcessingMetadata(pydantic.BaseModel):
    """Metadata generated by the ImageProcessor step."""

    processed: bool = True
    mime_type: str
    original_size: tuple[int, int]
    processed_size: tuple[int, int]
    compression_ratio: float

    model_config = pydantic.ConfigDict(alias_generator=to_camel, populate_by_name=True)
