name: Claude Tag Release

concurrency:
  group: robosystems-client-tag-release
  cancel-in-progress: false

on:
  push:
    branches: [main]

jobs:
  action:
    runs-on: ubuntu-latest # Use GitHub-hosted runners for memory-intensive git/Claude operations
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          token: ${{ secrets.ACTIONS_TOKEN }}
          fetch-depth: 0

      - name: Get Version from pyproject.toml
        id: get-version
        run: |
          VERSION=$(grep "^version = " pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"

      - name: Check If Tag Exists
        id: check-tag
        run: |
          if [ $(git tag -l "v${{ steps.get-version.outputs.version }}") ]; then
            echo "tag_exists=true" >> $GITHUB_OUTPUT
            echo "Tag v${{ steps.get-version.outputs.version }} already exists"
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
            echo "Tag v${{ steps.get-version.outputs.version }} does not exist yet"
          fi

      - name: Analyze changes since last release
        if: steps.check-tag.outputs.tag_exists == 'false'
        id: analyze-changes
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"

          # Get the last release tag
          LAST_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | head -1)

          if [ -z "$LAST_TAG" ]; then
            echo "No previous release found, analyzing all commits"
            COMMIT_RANGE="$(git rev-list --max-parents=0 HEAD)..HEAD"
            LAST_TAG="initial"
          else
            COMMIT_RANGE="$LAST_TAG..HEAD"
            echo "Analyzing changes since last release: $LAST_TAG"
          fi

          # Get change statistics
          FILES_CHANGED=$(git diff --name-only $COMMIT_RANGE | wc -l)
          COMMITS_COUNT=$(git rev-list --count $COMMIT_RANGE)
          ADDITIONS=$(git diff --shortstat $COMMIT_RANGE | grep -oE '[0-9]+ insertions?' | grep -oE '[0-9]+' || echo "0")
          DELETIONS=$(git diff --shortstat $COMMIT_RANGE | grep -oE '[0-9]+ deletions?' | grep -oE '[0-9]+' || echo "0")

          # Get commit messages (limit to prevent memory issues)
          COMMIT_MESSAGES=$(git log --oneline --no-color $COMMIT_RANGE | head -30)

          # Get file changes focusing on Python patterns
          DETAILED_CHANGES=$(git diff --name-status --no-color $COMMIT_RANGE | head -50)

          # Get Python and config file changes
          PYTHON_CHANGED=$(git diff --name-only $COMMIT_RANGE | grep -E '\.py$' | grep -v 'test\|spec' | wc -l || echo "0")
          CONFIG_CHANGED=$(git diff --name-only $COMMIT_RANGE | grep -E '\.(toml|yaml|yml|json|ini)$' | wc -l || echo "0")
          DOCS_CHANGED=$(git diff --name-only $COMMIT_RANGE | grep -E '\.(md|rst|txt)$' | wc -l || echo "0")

          # Get PR references from commit messages
          PR_REFS=$(git log --oneline --no-color $COMMIT_RANGE | grep -oE '#[0-9]+' | sort -u | head -10 || echo "")

          # Save outputs
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "commit_range=$COMMIT_RANGE" >> $GITHUB_OUTPUT
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "commits_count=$COMMITS_COUNT" >> $GITHUB_OUTPUT
          echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
          echo "python_changed=$PYTHON_CHANGED" >> $GITHUB_OUTPUT
          echo "config_changed=$CONFIG_CHANGED" >> $GITHUB_OUTPUT
          echo "docs_changed=$DOCS_CHANGED" >> $GITHUB_OUTPUT

          # Save multiline outputs
          {
            echo "commit_messages<<EOF"
            echo "$COMMIT_MESSAGES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "detailed_changes<<EOF"
            echo "$DETAILED_CHANGES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "pr_refs<<EOF"
            echo "$PR_REFS"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Generate changelog with Claude
        if: steps.check-tag.outputs.tag_exists == 'false'
        id: generate-changelog
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          LAST_TAG="${{ steps.analyze-changes.outputs.last_tag }}"

          # Create analysis prompt for Claude
          cat > /tmp/changelog_prompt.txt << PROMPT_EOF
          I need you to generate a concise but informative changelog for a Python MCP (Model Context Protocol) tool release.

          **Release Info:**
          - Package: RoboSystems Python Client (Python client for RoboSystems financial graph database API)
          - Version: $VERSION
          - Previous Version: $LAST_TAG
          - Files Changed: ${{ steps.analyze-changes.outputs.files_changed }}
          - Commits: ${{ steps.analyze-changes.outputs.commits_count }}
          - Lines Added: ${{ steps.analyze-changes.outputs.additions }}
          - Lines Deleted: ${{ steps.analyze-changes.outputs.deletions }}
          - Python Files Changed: ${{ steps.analyze-changes.outputs.python_changed }}
          - Config Files Changed: ${{ steps.analyze-changes.outputs.config_changed }}
          - Documentation Changed: ${{ steps.analyze-changes.outputs.docs_changed }}

          **Recent Commits:**
          ${{ steps.analyze-changes.outputs.commit_messages }}

          **File Changes:**
          ${{ steps.analyze-changes.outputs.detailed_changes }}

          **PR References:**
          ${{ steps.analyze-changes.outputs.pr_refs }}

          Please generate a changelog for this Python Client that includes:
          1. A brief 1-2 sentence summary focusing on functionality improvements
          2. Key features/improvements (bullet points) - focus on Client capabilities
          3. Breaking changes (if any) - clearly marked with ‚ö†Ô∏è
          4. Notable technical changes (dependencies, performance, API improvements)
          5. Bug fixes and stability improvements

          Keep it developer-focused since this is a developer Client. Highlight:
          - New API endpoints and methods
          - Client improvements and features
          - Performance optimizations
          - Type safety and validation enhancements
          - Integration improvements
          - Documentation and usage improvements

          Use markdown formatting. Don't include a version header as that will be added separately.
          Format your response as clean markdown without any prefix text.
          PROMPT_EOF

          echo "‚úÖ Changelog prompt created"

      - name: Call Claude API for changelog
        if: steps.check-tag.outputs.tag_exists == 'false'
        id: claude-changelog
        run: |
          # Call Claude API with the analysis prompt
          PROMPT=$(cat /tmp/changelog_prompt.txt)

          # Create a proper JSON payload using jq to handle escaping
          PAYLOAD=$(jq -n \
            --arg model "claude-sonnet-4-20250514" \
            --arg content "$PROMPT" \
            '{
              "model": $model,
              "max_tokens": 3000,
              "messages": [
                {
                  "role": "user",
                  "content": $content
                }
              ]
            }')

          RESPONSE=$(curl -s -X POST "https://api.anthropic.com/v1/messages" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -d "$PAYLOAD")

          # Check for API errors
          if echo "$RESPONSE" | jq -e '.error' > /dev/null; then
            echo "‚ùå Claude API error: $(echo "$RESPONSE" | jq -r '.error.message')"
            echo "Using fallback changelog"
            CHANGELOG="## What's Changed\n\n- ${{ steps.analyze-changes.outputs.commits_count }} commits with ${{ steps.analyze-changes.outputs.files_changed }} files changed\n- ${{ steps.analyze-changes.outputs.python_changed }} Python files and ${{ steps.analyze-changes.outputs.config_changed }} config files updated\n- ${{ steps.analyze-changes.outputs.additions }} additions and ${{ steps.analyze-changes.outputs.deletions }} deletions\n\nSee commit history for detailed changes."
          else
            # Extract changelog from Claude's response
            CHANGELOG=$(echo "$RESPONSE" | jq -r '.content[0].text')
            
            # Validate that Claude returned meaningful content
            if [ -z "$CHANGELOG" ] || [ "$CHANGELOG" = "null" ]; then
              echo "‚ùå Claude returned empty changelog, using fallback"
              CHANGELOG="## What's Changed\n\n- ${{ steps.analyze-changes.outputs.commits_count }} commits with ${{ steps.analyze-changes.outputs.files_changed }} files changed\n- ${{ steps.analyze-changes.outputs.python_changed }} Python files and ${{ steps.analyze-changes.outputs.config_changed }} config files updated\n- ${{ steps.analyze-changes.outputs.additions }} additions and ${{ steps.analyze-changes.outputs.deletions }} deletions\n\nSee commit history for detailed changes."
            else
              echo "‚úÖ Claude changelog generated successfully"
            fi
          fi

          # Save changelog to output
          {
            echo "changelog<<EOF"
            echo -e "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release Tag
        if: steps.check-tag.outputs.tag_exists == 'false'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Configure git to use the token for authentication
          git remote set-url origin https://x-access-token:${{ secrets.ACTIONS_TOKEN }}@github.com/${{ github.repository }}.git
          
          git tag -a "v${{ steps.get-version.outputs.version }}" -m "Release v${{ steps.get-version.outputs.version }}"
          git push origin "v${{ steps.get-version.outputs.version }}"

      - name: Create GitHub Release
        if: steps.check-tag.outputs.tag_exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get-version.outputs.version }}
          name: Release v${{ steps.get-version.outputs.version }}
          body: |
            # RoboSystems Python Client v${{ steps.get-version.outputs.version }}

            ${{ steps.claude-changelog.outputs.changelog }}

            ---

            ## üìä Release Statistics

            - **Commits:** ${{ steps.analyze-changes.outputs.commits_count }}
            - **Files Changed:** ${{ steps.analyze-changes.outputs.files_changed }}
            - **Python Files Updated:** ${{ steps.analyze-changes.outputs.python_changed }}
            - **Config Files Updated:** ${{ steps.analyze-changes.outputs.config_changed }}
            - **Documentation Updated:** ${{ steps.analyze-changes.outputs.docs_changed }}
            - **Lines Added:** ${{ steps.analyze-changes.outputs.additions }}
            - **Lines Deleted:** ${{ steps.analyze-changes.outputs.deletions }}
            - **Previous Release:** ${{ steps.analyze-changes.outputs.last_tag }}

            ## üîó Links

            - **PyPI Package:** [robosystems-client](https://pypi.org/project/robosystems-client/)
            - **Full Changelog:** [${{ steps.analyze-changes.outputs.last_tag }}...v${{ steps.get-version.outputs.version }}](https://github.com/${{ github.repository }}/compare/${{ steps.analyze-changes.outputs.last_tag }}...v${{ steps.get-version.outputs.version }})
            - **All Releases:** [View all releases](https://github.com/${{ github.repository }}/releases)

            ## üõ†Ô∏è Installation

            ```bash
            pip install robosystems-client
            # or
            uv add robosystems-client
            ```

            ---
            ü§ñ Generated with [Claude Code](https://claude.ai/code)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_TOKEN }}

      - name: Create release summary
        if: steps.check-tag.outputs.tag_exists == 'false'
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"

          echo "## üöÄ RoboSystems Python Client v$VERSION Released" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** [v$VERSION](https://github.com/${{ github.repository }}/releases/tag/v$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "**PyPI Package:** [robosystems-client](https://pypi.org/project/robosystems-client/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Python Tool Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Commits:** ${{ steps.analyze-changes.outputs.commits_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Files Changed:** ${{ steps.analyze-changes.outputs.files_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Files Updated:** ${{ steps.analyze-changes.outputs.python_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Config Files Updated:** ${{ steps.analyze-changes.outputs.config_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation Updated:** ${{ steps.analyze-changes.outputs.docs_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous Release:** ${{ steps.analyze-changes.outputs.last_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ü§ñ Claude-Generated Changelog" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.claude-changelog.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
