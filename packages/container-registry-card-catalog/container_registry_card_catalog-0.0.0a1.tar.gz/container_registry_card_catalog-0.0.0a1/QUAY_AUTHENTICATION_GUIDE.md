# Quay.io Authentication Guide

<!--
AI Attribution (AIA) Notice:
- Generated by: Claude (Anthropic AI Assistant)
- Session Date: 2025-08-25
- Vibe-Coder: Andrew Potozniak <potozniak@redhat.com>
-->

## Overview

Quay.io requires **Docker Registry v2 token authentication** for catalog access, even with valid credentials. This guide explains why basic auth fails and how to properly authenticate with Quay.

## The Problem: "Invalid Bearer Token" Errors

### Why Basic Auth Fails
When using basic auth (username:password) with Quay's `/v2/_catalog` endpoint:

```bash
curl -u "namespace+robotname:token" https://quay.io/v2/_catalog
# Returns: {"errors":[{"code":"INVALID_TOKEN","message":"Invalid bearer token format"}]}
```

**Root Cause**: Quay requires a **two-step authentication process**:
1. Use your credentials to **request a token** from Quay's auth server
2. Use that **JWT token** for actual API calls

## The Solution: Docker Registry v2 Token Flow

### Authentication Flow
```
1. GET /v2/_catalog (without auth)
   ↓
2. 401 Unauthorized + WWW-Authenticate header
   ↓  
3. Parse auth challenge: realm, service, scope
   ↓
4. POST to auth server with basic auth (username:password)
   ↓
5. Receive JWT token (expires in 5-60 minutes)
   ↓
6. Use JWT token for all subsequent API calls
```

### Example WWW-Authenticate Header
```
WWW-Authenticate: Bearer realm="https://quay.io/v2/auth",service="quay.io",scope="repository:my-org/my-repo:pull"
```

### Token Request
```bash
# Step 1: Get token from auth server
curl -X POST https://quay.io/v2/auth \
  -u "my-org+robot-name:robot_token" \
  -d "service=quay.io&scope=repository:my-org/my-repo:pull"

# Response:
{
  "token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_in": 300,
  "issued_at": "2025-08-25T14:23:45Z"
}

# Step 2: Use token for API calls
curl -H "Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..." \
  https://quay.io/v2/_catalog
```

## Critical Configuration Requirements

### Service Parameter
- **Must be the FQDN**: `quay.io` (not just "registry" or "quay")
- **Case sensitive**: Use exact hostname from registry URL
- **Example**: For `https://quay.io`, service is `quay.io`

### Scope Format
- **Correct**: `repository:my-org/my-repo:pull`
- **Incorrect**: `registry:catalog:*` (this doesn't work for Quay)
- **Pattern**: `repository:<namespace>/<repository>:pull`
- **Wildcard**: `repository:my-org/*:pull` (for all repos in org)

## Container Registry Card Catalog Configuration

### TUI Configuration
1. **Registry Type**: Select "Quay.io"
2. **Auth Type**: Select "Token Auth (Docker v2)"
3. **Username**: `my-org+robot-name` (note the `+` separator)
4. **Password**: Your robot account token
5. **Auth Scope**: `repository:my-org/my-repo:pull`
6. **Max Repositories**: 100-500 depending on organization size

### Robot Account Format
- **Correct**: `myorg+myrobot`
- **Incorrect**: `myrobot` or `myorg/myrobot`

### Scope Examples
- `repository:myorg/myrepo:pull` - Single repository access
- `repository:myorg/*:pull` - All repositories in organization
- `repository:myorg/frontend:pull,repository:myorg/backend:pull` - Multiple specific repos

## Token Management

### Token Lifecycle
- **Expiration**: Usually 5-15 minutes for Quay
- **Automatic Refresh**: System handles token renewal
- **Caching**: Tokens cached in memory during session
- **Security**: Tokens never persisted to disk

### Token Response Fields
```json
{
  "token": "jwt_token_here",
  "access_token": "jwt_token_here",  // Alternative field name
  "expires_in": 300,                // Seconds until expiration  
  "issued_at": "2025-08-25T14:23:45Z"
}
```

## Troubleshooting

### Common Issues

#### "Invalid Bearer Token Format"
- **Cause**: Using basic auth instead of token auth
- **Solution**: Use "Token Auth (Docker v2)" in TUI

#### "Authorization Required" 
- **Cause**: Missing or expired token
- **Solution**: Check robot account permissions and token validity

#### "Insufficient Permissions"
- **Cause**: Robot account lacks required permissions
- **Solution**: Grant read permissions to robot account in Quay UI

#### Username Format Errors
- **Cause**: Missing `+` separator in robot username
- **Solution**: Use `namespace+robotname` format

#### Wrong Service Parameter
- **Cause**: Using generic service name instead of FQDN
- **Solution**: Use `quay.io` as service parameter

#### Wrong Scope Format
- **Cause**: Using `registry:catalog:*` instead of repository-specific scope
- **Solution**: Use `repository:org/repo:pull` format

### Debug Information
The TUI provides detailed debugging:
- Token request/response details
- Auth header formats being sent
- Server error messages
- Token expiration times
- Service and scope parameters being used

## Implementation Details

### RegistryClient Token Flow
```python
# Automatic token management
async def _get_registry_token(self, scope: str = None) -> Optional[str]:
    # 1. Get WWW-Authenticate challenge
    # 2. Parse realm, service, scope
    # 3. Request token with basic auth
    # 4. Cache token with expiration
    # 5. Return token for use
```

### Token Expiration Handling
```python
def _get_auth_headers(self) -> Dict[str, str]:
    if self.token_expires_at and time.time() >= self.token_expires_at:
        self.cached_token = None  # Clear expired token
    return {"Authorization": f"Bearer {self.cached_token}"}
```

### Quay Pagination Support
```python
# Handles Quay's Link header pagination
Link: </v2/_catalog?n=100&next_page=gAAAAA...%3D>; rel="next"
```

## Best Practices

### Security
- Use robot accounts, not personal accounts
- Limit robot account permissions to minimum required
- Use specific repository scopes, not wildcards when possible
- Never log tokens or credentials

### Performance  
- Configure appropriate max repository limits
- Use specific repository scopes for targeted access
- Let the system handle token caching
- Monitor token expiration in debug console

### Configuration
- Test connection before saving
- Use repository-specific scopes: `repository:org/repo:pull`
- Ensure service matches registry FQDN: `quay.io`
- Configure reasonable repository limits

---

## Quick Reference

### Working Quay Configuration
```
Registry Type: Quay.io
Auth Type: Token Auth (Docker v2)  
Username: myorg+myrobot
Password: [robot_token]
Auth Scope: repository:myorg/myrepo:pull
Max Repos: 200
```

### Curl Equivalent
```bash
# Get token
TOKEN=$(curl -s -u "myorg+myrobot:robot_token" \
  "https://quay.io/v2/auth?service=quay.io&scope=repository:myorg/myrepo:pull" | \
  jq -r .token)

# Use token
curl -H "Authorization: Bearer $TOKEN" \
  "https://quay.io/v2/_catalog?n=200"
```

### Key Requirements Summary
- **Service**: Must be FQDN (`quay.io`)
- **Scope**: Must be `repository:org/repo:pull` format
- **Username**: Must be `org+robotname` format
- **Auth Type**: Must be "Token Auth (Docker v2)"

This guide should help you successfully authenticate with Quay.io registries and understand why the Docker Registry v2 token flow is required.