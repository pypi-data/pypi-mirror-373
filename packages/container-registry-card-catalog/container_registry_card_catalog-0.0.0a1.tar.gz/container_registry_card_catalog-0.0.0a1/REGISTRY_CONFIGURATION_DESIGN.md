# Registry Configuration & Authentication Design

<!--
AI Attribution (AIA) Notice:
- Generated by: Claude (Anthropic AI Assistant)
- Session Date: 2025-08-25
- Vibe-Coder: Andrew Potozniak <potozniak@redhat.com>
-->

## Design Philosophy

> "So let it be written, so let it be done!" - The vibe-coding decree for registry authentication

This design document captures the vision for comprehensive registry configuration, authentication, and management within the Container Registry Card Catalog TUI.

## Core Principles

1. **User Experience First**: Configuration should be intuitive, discoverable, and immediate
2. **Security by Design**: Credentials encrypted, tokens cached securely, no hardcoded secrets
3. **Debug Transparency**: All operations logged to debug console for troubleshooting
4. **Incremental Implementation**: Start simple, build up complexity systematically
5. **Universal Registry Support**: Handle any registry URL structure with pattern matching

## Architecture Overview

### **Phase 1: Configuration Modal (PRIORITY)**
```
Main Screen → 'C' Key → Registry Configuration Modal
                     ↓
              [Test] [Save] [Cancel]
                     ↓
              Debug Console Logging
```

### **Phase 2: Registry Manager (FUTURE)**
```
Main Screen → 'M' Key → Full Screen Registry Manager
                     ↓
              [A]dd [C]onfigure [E]dit [D]elete [T]est
                     ↓
              Individual Action Modals
```

## Configuration Modal Design

### **Key Features:**
- **'C' Key Binding**: Configure currently selected registry
- **Test Button**: Live connection testing with debug logging
- **Form Fields**: Username, password, auth type, cache TTL
- **Real-time Feedback**: Test results displayed immediately
- **Debug Integration**: All test operations logged to debug console

### **Modal Layout:**
```
┌─ Configure Registry: docker.io ───────────────────┐
│                                                   │
│ 🔧 Authentication                                 │
│ Username: [myuser               ]                 │
│ Password: [**********           ]                 │
│ Auth Type: [bearer ▼] bearer/basic/none           │
│                                                   │
│ 🕒 Caching                                        │
│ Cache TTL: [1800] seconds (0 = no cache)         │
│                                                   │
│ 🧪 Test Results                                   │
│ ┌─────────────────────────────────────────────┐   │
│ │ Press Test to verify connection...          │   │
│ └─────────────────────────────────────────────┘   │
│                                                   │
│        [Cancel]  [Test]  [Save & Apply]           │
└───────────────────────────────────────────────────┘
```

### **Test Connection Flow:**
1. **Basic Connectivity**: `GET /v2/` (logged to debug)
2. **Authentication**: `GET /v2/_catalog` (logged to debug)
3. **Performance**: Multiple requests for average (logged to debug)
4. **Results Display**: Real-time status updates in modal
5. **Debug Logging**: All operations visible in debug console

## Right Panel Integration

### **Configure Registry Button:**
```
┌─ Registry Details ────────────────────────────────┐
│                                                   │
│ Registry: docker.io                               │
│ Status: ✅ Connected                              │
│ Username: myuser                                  │
│ Auth Type: Bearer Token                           │
│ Last Checked: 2 minutes ago                       │
│ Response Time: 245ms                              │
│ Repositories: 1,247                               │
│ Cache TTL: 30 minutes                             │
│                                                   │
│              [Configure Registry]                 │
│                                                   │
└───────────────────────────────────────────────────┘
```

## Registry Manager (Future Phase)

### **Full Screen Interface:**
```
┌─ Registry Manager ────────────────────────────────────────────────────┐
│                                                                       │
│ ┌─ Registries ─────────────────────────────────────────────────────┐ │
│ │ Status │ Registry             │ User     │ Auth   │ Cache │ Repos │ │
│ │ ✅     │ docker.io           │ myuser   │ Bearer │ 1800s │ 1247  │ │
│ │ ✅     │ quay.io             │ robot+   │ Bearer │ 3600s │ 892   │ │
│ │ ⚠️      │ harbor.company.com  │ admin    │ Basic  │ 0s    │ 45    │ │
│ │ ❌     │ private.company.com │ [NEEDS]  │ -      │ -     │ -     │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                       │
│ [A]dd  [C]onfigure  [E]dit  [D]elete  [T]est  [R]efresh  [Q]uit      │
└───────────────────────────────────────────────────────────────────────┘
```

### **Modal Actions:**
- **[A]dd**: New registry discovery and configuration
- **[C]onfigure**: Full settings (auth, cache, connection, aliases)
- **[E]dit**: Quick credential updates
- **[D]elete**: Confirmation dialog with impact summary
- **[T]est**: Comprehensive connection testing

## Configuration Storage

### **File Structure:**
```yaml
# ~/.config/container-registry-card-catalog/registries.yaml
registries:
  "docker.io":
    auth_required: true
    auth_type: "bearer"
    username: "myuser"
    password: "encrypted:abc123..."
    cache_ttl: 1800
    aliases: ["registry-1.docker.io", "index.docker.io"]
    
  "*.localhost*":
    auth_required: false
    cache_ttl: 0
    pattern: true  # Pattern matching entry
    
  "local:podman":
    type: "local"
    cache_ttl: 0
    auth_required: false
```

### **Environment Variable Overrides:**
```bash
# Override specific credentials
export DOCKER_HUB_PASSWORD="my-token"
export QUAY_TOKEN="robot-token"
export HARBOR_PASSWORD="admin-secret"
```

## Debug Systems Integration

### **Dual Debug Architecture:**

**1. API Debug Console (Ctrl+D in TUI):**
- Real-time HTTP request/response logging
- Authentication flow transparency
- Performance metrics and timing
- Interactive debug screen within TUI

**2. TUI Operations Debug Logging (`--debug` flag):**
- File-based logging of TUI state changes
- User interaction tracking
- Configuration and navigation logging
- Application lifecycle events
- File-only output (prevents TUI corruption)

### **API Debug Console Output:**
```
14:23:45.123  TEST   Testing registry configuration for docker.io               ✅  245ms
14:23:45.234  GET    docker.io/v2/                                             ✅  122ms  
14:23:45.445  GET    docker.io/v2/_catalog                                     ✅  289ms
14:23:46.001  PERF   performance_test                                          ✅  156ms
14:23:46.157  TEST   Configuration test completed for docker.io               ✅  1034ms
```

### **TUI Debug Log Output:**
```
2025-08-25 14:23:45,123 [TUI-DEBUG] TUI-Operations: Starting Container Registry Card Catalog | debug_enabled=True
2025-08-25 14:23:47,234 [TUI-DEBUG] TUI-Operations: Registry configuration saved | registry_url=quay.io, auth_type=token_auth, username=myorg+robot, password=abc...xyz
2025-08-25 14:23:48,456 [TUI-DEBUG] TUI-Operations: Navigating to repository view | registry_name=Quay.io, mock_mode=False
```

### **Security Features:**
- **Credential masking**: All sensitive data automatically redacted
- **Smart masking**: Shows first/last 3 characters for identification (abc...xyz)
- **Comprehensive coverage**: Passwords, tokens, auth headers, API keys
- **No credential leakage**: Sensitive data never appears in logs

### **Usage Examples:**
```bash
# Enable TUI debug logging only
./container_registry_card_catalog.py --debug

# Custom debug log location
./container_registry_card_catalog.py --debug --debug-location /home/user/tui-debug.log

# TUI debug + real registries (API debug via Ctrl+D)
./container_registry_card_catalog.py --debug --registry quay.io
```

### **Debug Data Coverage:**

**API Debug Console:**
- Authentication flows and token requests
- HTTP status codes and error messages
- Performance metrics and response times
- Bearer tokens (masked) and auth headers
- Registry API call details

**TUI Debug Logging:**
- Application startup and configuration parsing
- Registry configuration saves and updates
- Screen navigation and state transitions
- User interactions and key presses
- Error conditions and application lifecycle

## Authentication Implementation

### **Supported Methods:**
1. **Bearer Token** (Primary): OAuth2-style token authentication
2. **Basic Auth** (Fallback): Username/password for simple registries
3. **AWS ECR**: Temporary credential support
4. **Google GCR**: OAuth2 integration
5. **Azure ACR**: Service principal support

### **Token Management:**
- **In-memory storage**: Tokens never persisted to disk
- **Automatic refresh**: Handle expired tokens transparently
- **Secure credential storage**: Encrypted passwords in config files
- **Environment variable support**: Override credentials dynamically

## Security Considerations

### **Credential Protection:**
- **Encryption**: All stored passwords encrypted with derived master key
- **No logging**: Credentials never appear in debug logs (masked as `[REDACTED]`)
- **Memory clearing**: Sensitive data cleared on application exit
- **Environment variables**: Support for external credential management

### **Token Handling:**
- **Session-only storage**: Bearer tokens stored in memory only
- **Expiration handling**: Automatic refresh on 401 responses
- **Scope management**: Request minimal required permissions
- **Secure transmission**: HTTPS only for credential exchanges

## Implementation Priority

### **Phase 1 (Completed):**
1. ✅ Main screen 'C' key binding
2. ✅ Registry configuration modal design
3. ✅ Test connection functionality
4. ✅ Debug console integration
5. ✅ Configure Registry button in right panel
6. ✅ Docker Registry v2 token authentication
7. ✅ Registry type detection and hints
8. ✅ Authorization scope configuration
9. ✅ Max repositories setting
10. ✅ Quay.io Link header pagination support
11. ✅ Dual debug systems (TUI operations + API debug console)
12. ✅ Security-first logging with comprehensive credential masking

### **Current Implementation Status:**

**Authentication Features:**
- ✅ Token Auth (Docker v2) - Full implementation with auto-refresh
- ✅ Basic Auth - For simple registries  
- ✅ Bearer Token - For direct token usage
- ✅ Registry-specific hints and validation
- ✅ Authorization scope configuration
- ✅ Token expiration handling and caching

**Registry Support:**
- ✅ Quay.io - Full support with proper scope format
- ✅ Local containers (podman/docker) - With tag loading
- ✅ Generic registries - Basic support
- ✅ Link header pagination - Quay format

**Configuration Features:**
- ✅ Registry type detection and selection
- ✅ Max repositories setting (user-controlled)
- ✅ Cache TTL configuration
- ✅ In-memory credential storage
- ❌ Persistent configuration (not implemented)

**Performance Optimizations:**
- ✅ Tag loading only for ≤50 repositories
- ✅ Pagination with configurable limits
- ✅ Token caching and auto-refresh
- ✅ Debug logging for troubleshooting

### **Phase 2 (Next Sprint):**
1. 📋 Persistent configuration storage
2. 📋 Credential encryption for saved configs
3. 📋 Full-screen Registry Manager
4. 📋 Add/Edit/Delete registry modals
5. 📋 Pattern matching for registry URLs

### **Phase 3 (Future):**
1. 📋 Advanced authentication (AWS ECR, GCR, ACR)
2. 📋 Docker credential helper integration
3. 📋 Bulk registry import/export
4. 📋 Advanced caching controls

## Key Bindings Summary

### **Main Screen:**
- **'C'**: Configure selected registry
- **'M'**: Open Registry Manager (future)
- **Button**: Configure Registry (right panel)

### **Registry Manager:**
- **'A'**: Add new registry
- **'C'**: Configure selected registry
- **'E'**: Edit credentials (quick)
- **'D'**: Delete registry
- **'T'**: Test connection
- **'Q'/Escape**: Return to main view

## Success Metrics

### **User Experience:**
- ✅ One-key access to configuration ('C')
- ✅ Immediate test feedback (< 5 seconds)
- ✅ Visual status indicators (✅❌⚠️)
- ✅ Complete debug transparency

### **Security:**
- ✅ No credential leakage in logs
- ✅ Encrypted storage for persistent credentials
- ✅ Secure token management
- ✅ Environment variable support

### **Functionality:**
- ✅ Universal registry support (any URL)
- ✅ Multiple authentication methods
- ✅ Flexible caching controls
- ✅ Pattern-based configuration

---

## Implementation Notes

This design prioritizes **immediate utility** (Phase 1) while establishing a foundation for **comprehensive registry management** (Phases 2-3). The incremental approach ensures users get value quickly while maintaining architectural consistency for future enhancements.

**The vibes mandate**: Start with the configuration modal, make it robust, then expand systematically. All operations must be transparent through debug logging, and security must be baked in from the beginning.

*Vibe-Coded with systematic precision and user-first thinking.*