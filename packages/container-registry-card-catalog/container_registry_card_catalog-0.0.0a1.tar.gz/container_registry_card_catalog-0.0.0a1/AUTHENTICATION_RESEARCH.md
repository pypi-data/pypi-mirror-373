# Docker Registry Authentication Research

<!--
AI Attribution (AIA) Notice:
- Generated by: Claude (Anthropic AI Assistant)
- Session Date: 2025-08-22
- Vibe-Coder: Andrew Potozniak <potozniak@redhat.com>
-->

## Executive Summary

Docker Registry HTTP API v2 authentication is **mandatory for most production registries**, even for read-only operations like browsing catalogs. Anonymous access is typically limited to public repositories only, and even then, catalog endpoints (`/v2/_catalog`) almost universally require authentication.

## Authentication Methods by Registry

### Docker Hub (docker.io / registry-1.docker.io)

**Authentication Type:** Bearer Token (OAuth2-style)  
**Anonymous Access:** Limited to public repositories only, NO catalog access  
**Catalog Access:** Requires authentication even for public repositories  

**Authentication Flow:**
1. Request catalog without auth → `401 Unauthorized` with `WWW-Authenticate` header
2. Extract realm and service from challenge: `Bearer realm="https://auth.docker.io/token",service="registry.docker.io"`
3. POST to auth endpoint with credentials to get token
4. Use bearer token in subsequent requests

**Example Authentication Headers:**
```http
# Challenge response
WWW-Authenticate: Bearer realm="https://auth.docker.io/token",service="registry.docker.io",scope="registry:catalog:*"

# Token request
POST https://auth.docker.io/token
Content-Type: application/x-www-form-urlencoded
Authorization: Basic <base64(username:password)>

service=registry.docker.io&scope=registry:catalog:*

# Authenticated request
GET /v2/_catalog
Authorization: Bearer <token>
```

### Quay.io

**Authentication Type:** Docker Registry v2 Token Authentication (REQUIRED)  
**Anonymous Access:** Limited public repositories, NO catalog  
**Catalog Access:** Requires token authentication (basic auth fails)  

**Critical Requirements:**
- **Service**: Must be FQDN `quay.io` (not generic "registry")
- **Scope**: Must be `repository:org/repo:pull` format (NOT `registry:catalog:*`)
- **Username**: Must be `namespace+robotname` format

**Authentication Flow:** Docker Registry v2 token flow mandatory
- Realm: `https://quay.io/v2/auth`
- Service: `quay.io`
- Scope: `repository:namespace/repo:pull`

### Google Container Registry (GCR)

**Authentication Type:** Bearer Token (Google OAuth2)  
**Anonymous Access:** Public repositories only  
**Catalog Access:** Requires Google Cloud authentication  

**Special Requirements:**
- Requires Google Cloud service account or user credentials
- Uses Google OAuth2 access tokens as bearer tokens
- Supports `_token` username with OAuth token as password for basic auth

### Amazon ECR

**Authentication Type:** Basic Auth with temporary credentials  
**Anonymous Access:** None (private by default)  
**Catalog Access:** Requires AWS IAM authentication  

**Authentication Flow:**
1. Use AWS CLI/SDK to get login token: `aws ecr get-login-password`
2. Use `AWS` as username and token as password for basic auth
3. Tokens expire after 12 hours

### Azure Container Registry (ACR)

**Authentication Type:** Bearer Token or Basic Auth  
**Anonymous Access:** Limited (if enabled)  
**Catalog Access:** Requires authentication  

**Authentication Methods:**
- Azure AD service principal
- Admin user credentials (if enabled)
- Azure CLI token

### Harbor (Self-hosted)

**Authentication Type:** Basic Auth or Bearer Token  
**Anonymous Access:** Configurable (often disabled)  
**Catalog Access:** Typically requires authentication  

**Authentication Flow:**
- Supports both basic auth and Docker Registry v2 token flow
- Configuration dependent on Harbor setup

## Docker Registry v2 Authentication Specification

### Bearer Token Flow (RFC 6750)

**Standard Flow:**
1. **Challenge:** Client requests protected resource → 401 with WWW-Authenticate header
2. **Token Request:** Client requests token from auth service with credentials
3. **Token Response:** Auth service returns JWT/opaque token
4. **Authenticated Request:** Client uses bearer token for API calls

**WWW-Authenticate Header Format:**
```
Bearer realm="<auth-server-url>",service="<service-name>",scope="<scope>"
```

**Token Request:**
```http
POST <realm>
Content-Type: application/x-www-form-urlencoded
Authorization: Basic <base64(username:password)>

service=<service>&scope=<scope>
```

**Token Response:**
```json
{
  "token": "<jwt-or-opaque-token>",
  "access_token": "<jwt-or-opaque-token>",
  "expires_in": 300,
  "issued_at": "2025-08-22T10:00:00Z"
}
```

### Basic Authentication

**Format:** `Authorization: Basic <base64(username:password)>`  
**Usage:** Simpler registries, some self-hosted installations  
**Security:** Less secure, credentials sent with every request  

## Common Scopes and Permissions

### Catalog Access
- `registry:catalog:*` - Full catalog access
- `registry:catalog:search` - Search only

### Repository Access
- `repository:<name>:pull` - Pull images/manifests
- `repository:<name>:push` - Push images/manifests
- `repository:<name>:*` - Full repository access

### Typical Scopes for Browsing
```
registry:catalog:*
repository:*:pull
```

## Anonymous Access Limitations

### What Usually Works Anonymously:
- Public repository manifest access
- Public repository tag lists
- Layer blob downloads (for public repos)

### What Requires Authentication:
- **Catalog endpoint (`/v2/_catalog`)** - Almost universal requirement
- Private repository access
- Repository search
- Administrative operations

## Implementation Recommendations

### Authentication Strategy
1. **Probe for anonymous access first** - attempt unauthenticated request
2. **Parse WWW-Authenticate challenge** - extract realm, service, scope
3. **Implement token caching** - tokens typically valid 5-60 minutes
4. **Handle token refresh** - automatic retry on 401 responses
5. **Support multiple auth methods** - bearer token preferred, basic auth fallback

### Credential Storage
```yaml
# Secure credential storage options
credentials:
  docker_hub:
    type: "bearer_token"
    username: "myuser"
    password: "encrypted_or_env_var"
    token_cache_ttl: 300
    
  private_registry:
    type: "basic_auth"
    username: "admin"
    password: "${REGISTRY_PASSWORD}"
    
  ecr_registry:
    type: "aws_ecr"
    region: "us-east-1"
    # Uses AWS CLI/SDK for token generation
```

### Security Best Practices
- **Never hardcode credentials** in source code
- **Use environment variables** or secure credential stores
- **Encrypt stored passwords** when persisting to disk
- **Implement token refresh** to avoid storing long-lived credentials
- **Clear tokens on exit** from memory
- **Use keyring/keychain** integration where available

## Error Handling Patterns

### Common Authentication Errors
- `401 Unauthorized` - Invalid or missing credentials
- `403 Forbidden` - Valid credentials but insufficient permissions
- `429 Too Many Requests` - Rate limiting (implement backoff)

### Retry Logic
1. **401 on first request** - Normal, attempt authentication
2. **401 after authentication** - Token expired, refresh and retry
3. **403 after valid auth** - Insufficient permissions, user error
4. **Multiple 401s** - Invalid credentials, stop retrying

## Registry-Specific Implementation Notes

### Docker Hub Quirks
- Uses different hostnames: `docker.io` vs `registry-1.docker.io`
- Anonymous pulls work for public repos, but not catalog
- Rate limiting aggressive for anonymous requests

### Private Registry Variations
- Self-hosted registries may not implement catalog endpoint
- Some use basic auth only
- Harbor has complex permission model
- Distribution (Docker's reference implementation) supports both flows

## Testing Authentication

### Local Development
```bash
# Test Docker Hub authentication
curl -v -H "Authorization: Bearer <token>" \
  https://registry-1.docker.io/v2/_catalog

# Test basic auth
curl -v -u username:password \
  https://your-registry.com/v2/_catalog
```

### Mock Authentication for Development
- Implement mock auth responses for testing
- Simulate token expiration scenarios
- Test with various error conditions

## Implementation Priority

1. **Bearer Token Authentication** - Most common, standards-compliant
2. **Basic Authentication** - Simpler fallback
3. **AWS ECR Support** - Popular enterprise registry
4. **Google GCR Support** - Common in cloud environments
5. **Azure ACR Support** - Microsoft ecosystem

## Security Considerations

### Token Handling
- Store tokens in memory only during session
- Clear sensitive data on application exit
- Implement secure token refresh flows
- Never log tokens or credentials

### Credential Management
- Support external credential helpers (Docker credential helpers)
- Integration with system keychains/credential stores
- Environment variable support for CI/CD scenarios
- Configuration file encryption for persistent storage

---

*Research compiled through systematic investigation of Docker Registry HTTP API v2 specification, major registry provider documentation, and real-world authentication patterns. Ready for implementation in container-registry-card-catalog project.*