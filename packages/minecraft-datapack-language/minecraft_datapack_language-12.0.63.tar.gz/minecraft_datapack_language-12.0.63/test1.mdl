// test1.mdl - Hello World Example with New MDL Features
pack "test1" "A simple hello world datapack" 82;

namespace "test1";

// Server-wide variables (global scope)
var num global_timer scope<global> = 0;
var num global_hello_count scope<global> = 0;

// Player-specific variables (stored on all players)
var num player_hello_count scope<@a> = 0;
var num player_timer_enabled scope<@a> = 0;
var num player_tick_counter scope<@a> = 0;

function "hello" {
    say Hello, Minecraft!;
    tellraw @a {"text":"Welcome to my datapack!","color":"green"};
    
    // Update both global and player counters
    global_hello_count<global> = global_hello_count<global> + 1;
    player_hello_count<@s> = player_hello_count<@s> + 1;
    
    // Display counters
    tellraw @a {"text":"Global Hello Count: $global_hello_count$","color":"gold"};
    tellraw @a {"text":"Your Hello Count: $player_hello_count$","color":"blue"};
    tellraw @a {"text":"Your Timer Enabled: $player_timer_enabled$","color":"green"};
    
    // Raw text only for commands that contain MDL keywords
    $!raw
    say "To enable your timer, run /function test1:enabletimer"
    say "To disable your timer, run /function test1:disabletimer"
    say "To see all players' stats, run /function test1:showstats"
    raw!$
}

function "enabletimer" {
    $!raw
    scoreboard players set @s player_timer_enabled 1
    raw!$
    say Your timer is now enabled!;
    tellraw @s {"text":"Timer enabled for you!","color":"green"};
}

function "disabletimer" {
    $!raw
    scoreboard players set @s player_timer_enabled 0
    raw!$
    say Your timer is now disabled!;
    tellraw @s {"text":"Timer disabled for you!","color":"red"};
}

function "tick" {
    global_timer<global> = global_timer<global> + 1;
    
    // Execute as each player to increment their individual tick counters
    $!raw
    execute as @a run function test1:increase_tick_per_player
    raw!$
    
    // Global timer event every 200 ticks
    if "$global_timer<global>$ > 200" {
        tellraw @a {"text":"Server has been running for $global_timer<global>$ ticks!","color":"yellow"};
        
        while "$global_timer<global>$ > 200" {
            global_timer<global> = global_timer<global> - 1;
            tellraw @a {"text":"Reducing global timer by 1 tick. New value: $global_timer<global>$","color":"yellow"};
        }
    }
}

function "increase_tick_per_player" {
    $!raw
    scoreboard players add @s player_tick_counter 1
    raw!$
    
    if "$player_tick_counter$ > 100" {
        if "$player_timer_enabled$ == 1" {
            function "test1:hello";
        }
        $!raw
        scoreboard players set @s player_tick_counter 0
        raw!$
    }
}

function "showstats" {
    tellraw @a {"text":"=== Player Statistics ===","color":"gold","bold":true};
    tellraw @a {"text":"Global Hello Count: $global_hello_count$","color":"gold"};
    tellraw @a {"text":"Your Hello Count: $player_hello_count$","color":"blue"};
    tellraw @a {"text":"Your Timer Status: $player_timer_enabled$","color":"green"};
}

function "resetstats" {
    global_hello_count<global> = 0;
    player_hello_count<@s> = 0;
    say Statistics reset!;
    tellraw @s {"text":"Your statistics have been reset!","color":"yellow"};
}

// Hook to run hello function when datapack loads
on_load "test1:hello";
on_tick "test1:tick";
