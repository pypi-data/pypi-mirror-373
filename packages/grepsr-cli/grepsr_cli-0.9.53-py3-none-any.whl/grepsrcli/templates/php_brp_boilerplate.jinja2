<?php

/**
 * Name: {{host_name | default(plugin_name)}}
 * Description: {{host_name | default(plugin_name)}}
 * PID: {{pid}} force
 * Dependencies: brp_locations
 */

require_once __DIR__ . '/../brp_locations/brp_locations.php';
class {{plugin_name}} extends brp_locations {
    protected $colHeaders = {{col_headers}};
    protected $baseUrl = '{{base_url}}';
    protected $domainUrl = '{{domain_url}}';
    private $cache;
	
    public function __construct() {
        parent::__construct();
		$this->colHeaders = array("Universal_ID","Manufacturer","Product_Line","Product_Line_Standard","Product_Line_DeepDive","Dealer_Name","Dealer_ID","Address_1","Address_2","City","State","Zip","PO_Box","Country","Phone","Fax","Email","Website","Service_Level","Latitude","Longitude","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday");
        $this->cache = new Vtx_Service_Data_Cache(__CLASS__,time());
    }

    public function newSession() {
        $this->resetCurl(true);
        $this->useProxy = true;

		/*
        $holaZone = 'grepsr';
        $holaCountry = 'US';
        if (method_exists($this, 'enableProxy')) {
            $this->enableProxy('HOLA', $holaCountry, $holaZone);
        } else {
            $this->resetHolaSuperProxy();
            $this->enableHola($holaCountry);
            $this->setHolaZone($holaZone);
        }
        */

        $this->setHeaders('Accept-Encoding', 'gzip, deflate');
        $this->setHeaders('Accept', 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8');
        $this->setHeaders('Accept-Language', 'en-US,en;q=0.5');
        $this->setHeaders('Connection', 'keep-alive');
        $this->setHeaders('Upgrade-Insecure-Requests', '1');
        $this->setHeaders('User-Agent', 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36');
    }

    public function main($params) {
	    echo("Crawling : " . $this->domainUrl . PHP_EOL);
	    $this->dataSet->setPageName(get_class($this) .'_%s' , [ date('Ymd') ]);
        $this->dataSet->setColHeaders($this->colHeaders);
	    $this->newSession();
	    $this->switchProxy();
	    // $zips = $this->db->fetchAll("SELECT min(postal_code) as zip FROM `us_postal_code` WHERE country = 'US' group by CONCAT(ROUND(latitude,1), ROUND(longitude,0)) UNION SELECT min(postal_code) as zip FROM `us_postal_code` WHERE country = 'US' group by CONCAT(ROUND(latitude,0), ROUND(longitude,1)) order by zip");
		// $totalZips = count($zips);
		$this->loadDocument($this->baseUrl);
        return $this;
    }

    public function processItemDetail() {
        $arr = $this->dataSet->getEmptyRow();
		$arr['Universal_ID'] = '';
		$arr['Manufacturer'] = '';
		$arr['Product_Line'] = '';
		$arr['Product_Line_Standard'] = '';
		$arr['Product_Line_DeepDive'] = '';
		$arr['Dealer_Name'] =  '';
		$arr['Dealer_ID'] = '';
		$arr['Address_1'] = '';
		$arr['Address_2'] = '';
		$arr['City'] = '';
		$arr['State'] = '';
		$arr['Zip'] = '';
		$arr['PO_Box'] = '';
		$arr['Country'] = '';
		$arr['Phone'] = '';
		$arr['Fax'] = '';
		$arr['Email'] = '';
		$arr['Website'] = '';
		$arr['Latitude'] = '';
		$arr['Longitude'] = '';
		$arr['Sunday'] = '';
		$arr['Monday'] = '';
		$arr['Tuesday'] = '';
		$arr['Wednesday'] = '';
		$arr['Thursday'] = '';
		$arr['Friday'] = '';
		$arr['Saturday'] = '';

		if($this->cache->checkIfNew($arr['Dealer_ID'])){
			$this->addRow($arr);
			//print_r($arr);
		}
    }
}