#!/usr/bin/env python3
"""
MCPæ¨èå™¨æ¨¡å—å…¥å£ç‚¹
æ”¯æŒ python -m mcp_recommender è¿è¡Œæ–¹å¼
"""

import sys
import argparse
import asyncio
import os
from .server import recommender

# è®¾ç½®æ§åˆ¶å°ç¼–ç ä¸ºUTF-8ï¼Œé¿å…Windowsä¸‹çš„GBKç¼–ç é—®é¢˜
if sys.platform.startswith('win'):
    try:
        # è®¾ç½®ç¯å¢ƒå˜é‡
        os.environ['PYTHONIOENCODING'] = 'utf-8'
        # åªåœ¨æœ‰bufferå±æ€§æ—¶æ‰é‡æ–°åŒ…è£…
        if hasattr(sys.stdout, 'buffer'):
            import codecs
            sys.stdout = codecs.getwriter('utf-8')(sys.stdout.buffer, 'strict')
        if hasattr(sys.stderr, 'buffer'):
            import codecs
            sys.stderr = codecs.getwriter('utf-8')(sys.stderr.buffer, 'strict')
    except Exception:
        pass  # å¦‚æœè®¾ç½®å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ

def safe_print(text):
    """å®‰å…¨æ‰“å°å‡½æ•°ï¼Œè¿‡æ»¤å¯èƒ½å¯¼è‡´ç¼–ç é—®é¢˜çš„å­—ç¬¦"""
    try:
        print(text)
    except UnicodeEncodeError:
        # ç§»é™¤emojiå’Œç‰¹æ®ŠUnicodeå­—ç¬¦
        safe_text = ''.join(c for c in text if ord(c) < 65536 and (c.isprintable() or c in '\n\t '))
        try:
            print(safe_text)
        except:
            # æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šåªä¿ç•™ASCIIå­—ç¬¦
            ascii_text = ''.join(c for c in text if ord(c) < 128)
            print(ascii_text)

def clean_text(text):
    """æ¸…ç†æ–‡æœ¬ä¸­çš„emojiå­—ç¬¦"""
    if not text:
        return text
    # ç§»é™¤å¸¸è§çš„emojiå­—ç¬¦
    cleaned = text.replace('ï¸', '').replace('ğŸ ', '').replace('ğŸš€', '').replace('ğŸ“Š', '').replace('ğŸ”', '')
    return cleaned.strip()

def test_mode():
    """æµ‹è¯•æ¨¡å¼ - æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯å’Œç¤ºä¾‹æŸ¥è¯¢"""
    safe_print("MCPæ¨èå™¨æµ‹è¯•æ¨¡å¼")
    safe_print(f"å·²åŠ è½½ {len(recommender.mcps)} ä¸ªMCPæœåŠ¡å™¨")
    safe_print("æ”¯æŒçš„åŠŸèƒ½:")
    safe_print("  - recommend: æ ¹æ®å…³é”®è¯æ¨èMCPæœåŠ¡å™¨")
    safe_print("  - list_categories: åˆ—å‡ºæ‰€æœ‰åˆ†ç±»")
    safe_print("  - get_functional_keywords: è·å–åŠŸèƒ½å…³é”®è¯")
    
    # æ˜¾ç¤ºåˆ†ç±»ç»Ÿè®¡
    categories = {}
    for mcp in recommender.mcps:
        cat = mcp.get('category', 'Unknown')
        # æ¸…ç†åˆ†ç±»åç§°ä¸­çš„emojiå­—ç¬¦
        cat = clean_text(cat)
        categories[cat] = categories.get(cat, 0) + 1
    
    safe_print(f"\nåˆ†ç±»ç»Ÿè®¡ (å…±{len(categories)}ä¸ªåˆ†ç±»):")
    for cat, count in sorted(categories.items(), key=lambda x: x[1], reverse=True)[:10]:
        safe_print(f"  {cat}: {count}ä¸ª")
    
    # ç¤ºä¾‹æ¨è
    safe_print("\nç¤ºä¾‹æ¨è (å…³é”®è¯: 'database'):")
    scored_results = recommender.search_mcps("database", limit=3)
    for i, (mcp, score) in enumerate(scored_results, 1):
        name = clean_text(mcp['name'])
        desc = clean_text(mcp['short_description'][:60])
        safe_print(f"  {i}. {name} - {desc}...")
    
    safe_print("\næµ‹è¯•å®Œæˆï¼")

def server_mode():
    """æœåŠ¡å™¨æ¨¡å¼ - å¯åŠ¨MCPæœåŠ¡å™¨"""
    # MCPæœåŠ¡å™¨æ¨¡å¼ä¸èƒ½è¾“å‡ºä»»ä½•éJSONå†…å®¹åˆ°stdout
    # æ‰€æœ‰è°ƒè¯•ä¿¡æ¯éƒ½è¾“å‡ºåˆ°stderr
    try:
        from .server import create_server
        # å°†è°ƒè¯•ä¿¡æ¯è¾“å‡ºåˆ°stderrè€Œä¸æ˜¯stdout
        print("å¯åŠ¨MCPæ¨èå™¨æœåŠ¡å™¨...", file=sys.stderr)
        print(f"å·²åŠ è½½ {len(recommender.mcps)} ä¸ªMCPæœåŠ¡å™¨", file=sys.stderr)
        print("å¯åŠ¨MCPæœåŠ¡å™¨...", file=sys.stderr)
        
        server = create_server()
        asyncio.run(server.run())
    except KeyboardInterrupt:
        print("\næœåŠ¡å™¨å·²åœæ­¢", file=sys.stderr)
    except Exception as e:
        print(f"\nå¯åŠ¨å¤±è´¥: {e}", file=sys.stderr)
        sys.exit(1)

def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(description="MCPæ¨èå™¨")
    parser.add_argument("--test", action="store_true", help="è¿è¡Œæµ‹è¯•æ¨¡å¼")
    parser.add_argument("--server", action="store_true", help="å¯åŠ¨æœåŠ¡å™¨æ¨¡å¼")
    
    args = parser.parse_args()
    
    if args.test:
        test_mode()
    elif args.server:
        server_mode()
    else:
        # é»˜è®¤è¿è¡ŒæœåŠ¡å™¨æ¨¡å¼è€Œä¸æ˜¯æµ‹è¯•æ¨¡å¼
        server_mode()

if __name__ == "__main__":
    main()