{
  "template_name": "data_layer",
  "display_name": "Data Layer Variable",
  "description": "Accesses values from the data layer (window.dataLayer or window._mtm) for dynamic content and tracking. Essential for retrieving ecommerce data, user information, and custom values pushed to the data layer by your website or application.",
  "ai_usage_guide": {
    "when_to_use": [
      "Access ecommerce data (transaction details, product information, cart contents)",
      "Retrieve user information (user ID, customer tier, login status)",
      "Get dynamic page data (category, product ID, search terms)",
      "Access custom events and values pushed by your application",
      "Integrate with GTM data layer for seamless migration",
      "Create conditional logic based on data layer values"
    ],
    "common_use_cases": [
      "E-commerce tracking: orderTotal, transactionId, productCategory",
      "User identification: userId, customerType, membershipLevel",
      "Content categorization: pageCategory, contentType, articleTags",
      "Form tracking: formName, formStep, validationErrors",
      "Custom events: eventCategory, eventAction, eventValue",
      "A/B testing: experimentId, variationName, testGroup",
      "Marketing attribution: campaignSource, medium, content"
    ],
    "best_practices": [
      "Use consistent naming conventions across your data layer",
      "Test data layer variables in browser console before deployment",
      "Implement fallback values for optional data layer properties",
      "Use descriptive variable names that indicate the data source",
      "Consider data layer availability timing - some values may load asynchronously",
      "Document your data layer structure for team collaboration"
    ]
  },
  "mcp_usage": {
    "create_variable": {
      "function_name": "create_variable",
      "description": "Create a new data layer variable to access values from window.dataLayer or window._mtm",
      "required_parameters": {
        "app_id": {
          "type": "string",
          "description": "UUID of your Piwik PRO app"
        },
        "name": {
          "type": "string",
          "description": "Descriptive name for the data layer variable"
        },
        "variable_type": {
          "type": "string",
          "value": "data_layer",
          "description": "Must be 'data_layer' for data layer variables"
        },
        "data_layer_variable_name": {
          "type": "string",
          "description": "Name of the property to access in the data layer"
        }
      },
      "optional_parameters": {
        "is_active": {
          "type": "boolean",
          "default": true,
          "description": "Whether the variable is active"
        },
        "data_layer_version": {
          "type": "string",
          "default": "2",
          "description": "Data layer version (1 or 2)"
        },
        "default_value": {
          "type": "string",
          "description": "Fallback value when data layer property is undefined"
        },
        "decode_uri_component": {
          "type": "boolean",
          "default": false,
          "description": "Whether to decode URI components in the value"
        }
      }
    },
    "update_variable": {
      "function_name": "update_variable",
      "description": "Update an existing data layer variable - only editable fields will be processed",
      "required_parameters": {
        "app_id": {
          "type": "string",
          "description": "UUID of your Piwik PRO app"
        },
        "variable_id": {
          "type": "string",
          "description": "UUID of the variable to update"
        }
      },
      "optional_parameters": {
        "name": {
          "type": "string",
          "description": "Updated descriptive name for the variable"
        },
        "is_active": {
          "type": "boolean",
          "description": "Whether the variable is active"
        },
        "data_layer_variable_name": {
          "type": "string",
          "description": "Updated data layer property name"
        },
        "data_layer_version": {
          "type": "string",
          "description": "Updated data layer version (1 or 2)"
        },
        "default_value": {
          "type": "string",
          "description": "Updated fallback value"
        },
        "decode_uri_component": {
          "type": "boolean",
          "description": "Updated URI decoding setting"
        }
      }
    }
  },
  "required_attributes": {
    "name": {
      "type": "string",
      "mutability": "editable",
      "description": "Descriptive name for the data layer variable",
      "examples": [
        "Order Total",
        "User ID",
        "Product Category",
        "Page Type"
      ],
      "validation": {
        "required": true,
        "min_length": 1,
        "max_length": 255
      },
      "recommendation": "Use clear, descriptive names that indicate the data source and purpose"
    },
    "template": {
      "type": "string",
      "mutability": "create-only",
      "description": "Variable template type",
      "examples": [
        "data_layer"
      ],
      "validation": {
        "required": true,
        "allowed_values": [
          "data_layer"
        ]
      },
      "edit_note": "‚ö†Ô∏è Cannot be changed after creation - template determines variable behavior"
    },
    "data_layer_variable_name": {
      "type": "string",
      "mutability": "editable",
      "description": "Name of the property to access in the data layer",
      "examples": [
        "orderTotal",
        "userId",
        "pageCategory",
        "ecommerce.transaction_id"
      ],
      "validation": {
        "required": true,
        "pattern": "^[a-zA-Z_][a-zA-Z0-9_.]*(\\[[0-9]+\\])*$"
      },
      "recommendation": "Use dot notation for nested properties (e.g., 'ecommerce.transaction_id') and bracket notation for arrays (e.g., 'products[0].name')"
    }
  },
  "optional_attributes": {
    "is_active": {
      "type": "boolean",
      "mutability": "editable",
      "description": "Whether the variable is active and available for use",
      "examples": [
        true,
        false
      ],
      "default": true,
      "recommendation": "Keep active unless temporarily disabling for testing"
    },
    "data_layer_version": {
      "type": "string",
      "mutability": "editable",
      "description": "Data layer version compatibility",
      "examples": [
        "1",
        "2"
      ],
      "default": "2",
      "validation": {
        "allowed_values": [
          "1",
          "2"
        ]
      },
      "recommendation": "Use version 2 for new implementations, version 1 for legacy GTM compatibility"
    },
    "default_value": {
      "type": "string",
      "mutability": "editable",
      "description": "Fallback value when data layer property is undefined or null",
      "examples": [
        "0",
        "unknown",
        "not-set",
        ""
      ],
      "recommendation": "Provide meaningful fallbacks for better error handling and reporting"
    },
    "decode_uri_component": {
      "type": "boolean",
      "mutability": "editable",
      "description": "Whether to decode URI components in the retrieved value",
      "examples": [
        true,
        false
      ],
      "default": false,
      "recommendation": "Enable when data layer contains URL-encoded values that need decoding"
    }
  },
  "read_only_attributes": {
    "created_at": {
      "mutability": "read-only",
      "description": "Timestamp when the variable was created",
      "edit_note": "üö´ Automatically set by the API, cannot be modified"
    },
    "updated_at": {
      "mutability": "read-only",
      "description": "Timestamp when the variable was last updated",
      "edit_note": "üö´ Automatically updated by the API on changes"
    }
  },
  "field_mutability_guide": {
    "description": "Understanding field editability after variable creation",
    "mutability_types": {
      "editable": {
        "description": "‚úÖ Can be updated anytime after creation",
        "examples": [
          "name",
          "is_active",
          "data_layer_variable_name",
          "data_layer_version",
          "default_value",
          "decode_uri_component"
        ],
        "use_cases": [
          "Renaming variables",
          "Changing data source",
          "Updating fallback values",
          "Toggling active status"
        ]
      },
      "create-only": {
        "description": "‚ö†Ô∏è Set during creation, immutable after creation",
        "examples": [
          "template"
        ],
        "explanation": "Template determines the variable type and behavior - cannot be changed to maintain data integrity"
      },
      "read-only": {
        "description": "üö´ Auto-generated by API, never user-modifiable",
        "examples": [
          "created_at",
          "updated_at"
        ],
        "explanation": "System timestamps managed automatically by Piwik PRO"
      }
    }
  },
  "complete_examples": {
    "create_example": {
      "description": "Creating a new data layer variable for ecommerce order total",
      "mcp_call": {
        "function": "create_variable",
        "parameters": {
          "app_id": "abc12345-1234-5678-9012-123456789abc",
          "attributes": {
            "name": "Order Total",
            "variable_type": "data_layer",
            "data_layer_variable_name": "ecommerce.purchase.value",
            "data_layer_version": "2",
            "default_value": "0",
            "is_active": true
          }
        }
      }
    },
    "update_example": {
      "description": "Updating an existing data layer variable to change the data source",
      "mcp_call": {
        "function": "update_variable",
        "parameters": {
          "app_id": "abc12345-1234-5678-9012-123456789abc",
          "variable_id": "var-67890-1234-5678-9012-123456789def",
          "attributes": {
            "name": "Transaction Value",
            "data_layer_variable_name": "transactionTotal",
            "default_value": "0.00"
          }
        }
      }
    },
    "nested_property_example": {
      "description": "Accessing nested ecommerce data",
      "mcp_call": {
        "function": "create_variable",
        "parameters": {
          "app_id": "abc12345-1234-5678-9012-123456789abc",
          "attributes": {
            "name": "Transaction ID",
            "variable_type": "data_layer",
            "data_layer_variable_name": "ecommerce.purchase.transaction_id",
            "default_value": "unknown"
          }
        }
      }
    },
    "array_access_example": {
      "description": "Accessing array elements in data layer",
      "mcp_call": {
        "function": "create_variable",
        "parameters": {
          "app_id": "abc12345-1234-5678-9012-123456789abc",
          "attributes": {
            "name": "First Product Name",
            "variable_type": "data_layer",
            "data_layer_variable_name": "ecommerce.items[0].item_name",
            "default_value": "No Product"
          }
        }
      }
    }
  },
  "common_mistakes": [
    "Not providing fallback values for optional data layer properties",
    "Using incorrect property names or paths for nested data",
    "Assuming data layer is always available immediately on page load",
    "Not testing data layer variables in different scenarios (logged in/out, different pages)",
    "Using spaces or special characters in data_layer_variable_name",
    "Forgetting to handle undefined or null values in the data layer",
    "Not documenting the expected data layer structure for the team"
  ],
  "troubleshooting": {
    "variable_returns_undefined": {
      "problem": "Data layer variable returns undefined or empty values",
      "solutions": [
        "Check that the data layer property name exactly matches your website's implementation",
        "Verify the data layer is populated before the variable is accessed",
        "Test the data layer structure in browser console: window.dataLayer or window._mtm",
        "Ensure proper timing - some data may load asynchronously",
        "Check for typos in nested property paths"
      ]
    },
    "nested_properties_not_working": {
      "problem": "Cannot access nested data layer properties",
      "solutions": [
        "Use dot notation for nested objects: 'ecommerce.purchase.value'",
        "Use bracket notation for arrays: 'products[0].name'",
        "Verify the nested structure exists in your data layer",
        "Test the full path in browser console before using"
      ]
    },
    "gtm_migration_issues": {
      "problem": "Issues migrating from Google Tag Manager data layer",
      "solutions": [
        "Ensure your GTM data layer is defined before Piwik PRO container loads",
        "Use data_layer_version '1' for legacy GTM compatibility if needed",
        "Verify property names match between GTM and Piwik PRO implementations",
        "Test both dataLayer and _mtm data layer access methods"
      ]
    }
  },
  "related_mcp_tools": {
    "discovery": [
      "piwik_get_available_variable_templates() - List all available variable templates",
      "piwik_get_variable_template() - Get detailed template information"
    ],
    "management": [
      "piwik_create_variable() - Create new variables with this template",
      "piwik_update_variable() - Update existing variables (editable fields only)",
      "piwik_list_variables() - List all variables in your app",
      "piwik_get_variable() - Get detailed information about specific variables"
    ],
    "workflow": [
      "piwik_list_tags() - Find tags that might use this variable",
      "piwik_list_triggers() - Find triggers that might use this variable"
    ]
  }
}