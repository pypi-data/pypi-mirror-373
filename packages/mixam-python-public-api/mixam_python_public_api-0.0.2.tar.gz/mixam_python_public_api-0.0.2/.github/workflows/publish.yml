name: Generate & Publish

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        type: choice
        options: [patch, minor, major]
        default: patch

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Bump & tag
        id: tagger
        uses: anothrNick/github-tag-action@1.69.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: ${{ inputs.bump }}
          WITH_V: true
          RELEASE_BRANCHES: main
          PRERELEASE: false

      - name: Show new tag
        run: echo "New tag is ${{ steps.tagger.outputs.new_tag }}"
      - name: Generate models
        run: uv run python -m scripts.generate_models

      - name: Run tests
        run: uv run pytest -q

      - name: Build sdist + wheel
        run: uv build

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: "__token__"
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          uvx twine upload dist/* --skip-existing
