name: Validate installation via Pixi

on:
  # Trigger the workflow on push
  push:
    # Every branch
    branches:
      - '**'
    # But do not run this workflow on creating a new tag starting with
    # 'v', e.g. 'v1.0.3' (see publish-pypi.yml)
    tags-ignore:
      - 'v*'
  # Trigger the workflow on pull request
  pull_request:
    branches:
      - '**'
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Allow only one concurrent workflow, skipping runs queued between the run
# in-progress and latest queued. And cancel in-progress runs.
concurrency:
  group:
    ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Set the environment variables to be used in all jobs defined in this workflow
env:
  # CI_BRANCH - the branch name (used in mkdocs.yml)
  # GITHUB_TOKEN - to authenticate on GitHub (e.g. increase API rate limit)
  CI_BRANCH: ${{ github.head_ref || github.ref_name }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  validate-pixi:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Set up pixi
        uses: prefix-dev/setup-pixi@v0.9.0
        with:
          run-install: false
          cache: false
          post-cleanup: false

      - name: Initialize a new Pixi project for EasyDiffraction
        run: pixi init

      - name: Add Conda dependencies
        run: pixi add python==3.13 jupyterlab pixi-kernel libcblas

      - name: Add PyPI dependencies
        run: >
          pixi add --pypi 'easydiffraction[dev, visualization]' --git
          https://github.com/easyscience/diffraction-lib.git --branch ${{
          env.CI_BRANCH }}

      - name: Add a task to run EasyDiffraction from the command line
        run: pixi task add easydiffraction "python -m easydiffraction"

      - name: List the available EasyDiffraction tutorials
        run: pixi run easydiffraction list-tutorials

      - name: Fetch the EasyDiffraction tutorials
        run: pixi run easydiffraction fetch-tutorials

      - name: Test execution of one of the tutorial notebooks
        shell: bash
        run: >
          pixi run jupyter nbconvert --to notebook --execute
          tutorials/quick_single-fit_pd-neut-cwl_LBCO-HRPT.ipynb --inplace
          --ExecutePreprocessor.kernel_name=pixi-kernel-python3 --log-level=WARN
