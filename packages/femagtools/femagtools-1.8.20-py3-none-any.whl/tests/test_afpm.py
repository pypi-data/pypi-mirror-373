import femagtools.machine.afpm
import pathlib
import pytest
import numpy as np

@pytest.fixture
def bch():
    flux = [{"1": [{"voltage_dpsi": [-0.03209, 0.18265, 0.60242, 0.98741, 1.33474, 1.67401, 1.98203, 2.26988, 2.56507, 2.84096, 3.08776, 3.2895, 3.39963, 3.38025, 3.26313, 3.10407, 2.93507, 2.76033, 2.56391, 2.34599, 2.06373, 1.67041, 1.21208, 0.73233, 0.26069, -0.1785, -0.59529, -0.98242, -1.33788, -1.66913, -1.97542, -2.27278, -2.56427, -2.84029, -3.08908, -3.28815, -3.39709, -3.38292, -3.26505, -3.1031, -2.93572, -2.76086, -2.56485, -2.34516, -2.06286, -1.67001, -1.21145, -0.73258, -0.26043, -0.03424],
                    "flux_k": [-0.00024797, -0.00026318, -0.00027388, -0.00028017, -0.00028225, -0.00028017, -0.00027388, -0.00026318, -0.00024797, -0.00022816, -0.00020373, -0.00017495, -0.00014264, -0.00010804, -7.2328e-05, -3.622e-05, 3.5235e-10, 3.6221e-05, 7.2329e-05, 0.00010804, 0.00014264, 0.00017495, 0.00020373, 0.00022816, 0.00024797, 0.00026318, 0.00027388, 0.00028017, 0.00028225, 0.00028017, 0.00027388, 0.00026318, 0.00024797, 0.00022816, 0.00020373, 0.00017495, 0.00014264, 0.00010804, 7.2328e-05, 3.622e-05, -5.3859e-10, -3.6221e-05, -7.2329e-05, -0.00010804, -0.00014264, -0.00017495, -0.00020373, -0.00022816, -0.00024797, -0.00026318],
                   "current_k": [-61.3751, -44.4249, -26.7146, -8.5472, 9.7664, 27.9129, 45.5819, 62.4709, 78.291, 92.7716, 105.6647, 116.75, 125.8376, 132.7721, 137.4348, 139.746, 139.6661, 137.1965, 132.3794, 125.2972, 116.0712, 104.8592, 91.853, 77.2752, 61.3751, 44.425, 26.7147, 8.5473, -9.7663, -27.9129, -45.5818, -62.4708, -78.2909, -92.7715, -105.6646, -116.7499, -125.8375, -132.772, -137.4348, -139.746, -139.6661, -137.1965, -132.3794, -125.2973, -116.0713, -104.8593, -91.8531, -77.2753, -61.3753, -44.4252]}],
             "2": [{"voltage_dpsi": [-2.70873, -2.84289, -3.08872, -3.28966, -3.40077, -3.38253, -3.26581, -3.10425, -2.93479, -2.76044, -2.56444, -2.34638, -2.06388, -1.67025, -1.21138, -0.73288, -0.26186, 0.17947, 0.59726, 0.98129, 1.33448, 1.67007, 1.97798, 2.27298, 2.565, 2.84086, 3.08791, 3.28738, 3.40043, 3.382, 3.26177, 3.10385, 2.93498, 2.761, 2.56721, 2.34413, 2.06081, 1.67428, 1.21276, 0.73087, 0.26326, -0.17835, -0.59726, -0.98187, -1.33451, -1.67393, -1.98009, -2.26991, -2.56524, -2.70814],
                    "flux_k": [0.00024797, 0.00022816, 0.00020373, 0.00017495, 0.00014264, 0.00010804, 7.2328e-05, 3.622e-05, -5.4865e-10, -3.6221e-05, -7.2329e-05, -0.00010804, -0.00014264, -0.00017495, -0.00020373, -0.00022816, -0.00024797, -0.00026319, -0.00027388, -0.00028018, -0.00028225, -0.00028018, -0.00027388, -0.00026319, -0.00024797, -0.00022816, -0.00020373, -0.00017495, -0.00014264, -0.00010804, -7.2328e-05, -3.6219e-05, 1.2533e-09, 3.6222e-05, 7.233e-05, 0.00010804, 0.00014264, 0.00017495, 0.00020373, 0.00022816, 0.00024797, 0.00026319, 0.00027388, 0.00028018, 0.00028225, 0.00028018, 0.00027388, 0.00026319, 0.00024797, 0.00022816],
                    "current_k": [-78.291, -92.7716, -105.6647, -116.75, -125.8376, -132.7721, -137.4348, -139.746, -139.6661, -137.1965, -132.3793, -125.2972, -116.0712, -104.8591, -91.8529, -77.2751, -61.3751, -44.4249, -26.7146, -8.5472, 9.7665, 27.913, 45.5819, 62.471, 78.291, 92.7716, 105.6648, 116.75, 125.8376, 132.7721, 137.4348, 139.746, 139.6661, 137.1964, 132.3793, 125.2972, 116.0711, 104.8591, 91.8529, 77.2751, 61.375, 44.4248, 26.7145, 8.5471, -9.7666, -27.9131, -45.582, -62.471, -78.2911, -92.7717]}],
             "3": [{"voltage_dpsi": [2.84917, 2.75927, 2.55941, 2.34039, 2.06628, 1.67025, 1.21009, 0.73481, 0.261, -0.17937, -0.59637, -0.98128, -1.3359, -1.67147, -1.97782, -2.27163, -2.56453, -2.84095, -3.08811, -3.28914, -3.39818, -3.37911, -3.26389, -3.1048, -2.9344, -2.76119, -2.56567, -2.3429, -2.06276, -1.67452, -1.21232, -0.73148, -0.26207, 0.17808, 0.59503, 0.98204, 1.33622, 1.67039, 1.97855, 2.27258, 2.56388, 2.84039, 3.08896, 3.28894, 3.39743, 3.38225, 3.26528, 3.10222, 2.93438, 2.85068],
                    "flux_k": [-6.9463e-10, 3.622e-05, 7.2328e-05, 0.00010804, 0.00014264, 0.00017495, 0.00020373, 0.00022816, 0.00024797, 0.00026318, 0.00027388, 0.00028018, 0.00028225, 0.00028018, 0.00027388, 0.00026319, 0.00024797, 0.00022816, 0.00020373, 0.00017495, 0.00014264, 0.00010804, 7.2329e-05, 3.6221e-05, 4.7315e-10, -3.622e-05, -7.2328e-05, -0.00010804, -0.00014264, -0.00017495, -0.00020373, -0.00022816, -0.00024797, -0.00026318, -0.00027388, -0.00028018, -0.00028225, -0.00028018, -0.00027388, -0.00026319, -0.00024797, -0.00022816, -0.00020373, -0.00017495, -0.00014264, -0.00010804, -7.2329e-05, -3.6221e-05, -1.344e-09, 3.6219e-05],
                   "current_k": [139.6661, 137.1965, 132.3793, 125.2972, 116.0712, 104.8591, 91.8529, 77.2751, 61.3751, 44.4249, 26.7146, 8.5472, -9.7664, -27.913, -45.5819, -62.4709, -78.291, -92.7716, -105.6648, -116.75, -125.8376, -132.7721, -137.4348, -139.746, -139.6661, -137.1964, -132.3793, -125.2972, -116.0711, -104.8591, -91.8529, -77.2751, -61.375, -44.4248, -26.7145, -8.5471, 9.7665, 27.913, 45.582, 62.471, 78.2911, 92.7716, 105.6648, 116.7501, 125.8377, 132.7721, 137.4348, 139.746, 139.6661, 137.1964]}]},
            {"1": [{"voltage_dpsi": [-0.164, 0.31282, 1.22918, 2.04412, 2.76836, 3.46167, 4.11078, 4.77156, 5.46133, 6.11894, 6.72286, 7.17226, 7.41434, 7.37021, 7.08365, 6.73419, 6.37469, 6.02313, 5.65316, 5.21216, 4.63892, 3.82747, 2.83881, 1.75897, 0.67703, -0.30814, -1.22402, -2.03929, -2.77346, -3.45998, -4.10589, -4.77592, -5.46118, -6.11693, -6.71904, -7.1717, -7.41769, -7.36689, -7.08377, -6.73809, -6.37507, -6.02389, -5.6506, -5.21247, -4.64366, -3.82516, -2.83299, -1.75901, -0.67935, -0.17111],
                    "flux_k": [-0.00054346, -0.00057622, -0.00059881, -0.00061181, -0.00061601, -0.00061181, -0.00059881, -0.00057622, -0.00054346, -0.0005002, -0.00044635, -0.00038264, -0.00031122, -0.00023515, -0.00015714, -7.8606e-05, 2.8188e-10, 7.8607e-05, 0.00015714, 0.00023515, 0.00031122, 0.00038264, 0.00044635, 0.0005002, 0.00054346, 0.00057622, 0.00059881, 0.00061181, 0.00061601, 0.00061181, 0.00059881, 0.00057622, 0.00054346, 0.0005002, 0.00044635, 0.00038265, 0.00031122, 0.00023516, 0.00015714, 7.8609e-05, 2.4765e-09, -7.8604e-05, -0.00015714, -0.00023515, -0.00031122, -0.00038264, -0.00044635, -0.0005002, -0.00054346, -0.00057622]}],
             "2": [{"voltage_dpsi": [-5.79795, -6.11993, -6.7221, -7.17369, -7.41038, -7.36841, -7.0954, -6.74027, -6.37224, -6.02015, -5.6508, -5.21078, -4.64548, -3.83655, -2.8201, -1.74367, -0.68171, 0.3047, 1.21988, 2.0388, 2.77748, 3.45904, 4.09605, 4.77066, 5.46193, 6.11755, 6.72035, 7.17308, 7.41739, 7.37072, 7.08598, 6.73638, 6.37495, 6.02127, 5.65027, 5.21196, 4.64339, 3.82886, 2.8256, 1.75069, 0.6829, -0.30317, -1.22397, -2.03802, -2.77241, -3.46157, -4.10196, -4.77059, -5.46082, -5.79421],
                    "flux_k": [0.00054346, 0.0005002, 0.00044635, 0.00038265, 0.00031122, 0.00023515, 0.00015714, 7.8606e-05, -1.1275e-09, -7.8608e-05, -0.00015714, -0.00023516, -0.00031122, -0.00038265, -0.00044636, -0.0005002, -0.00054346, -0.00057622, -0.00059882, -0.00061181, -0.00061602, -0.00061181, -0.00059881, -0.00057622, -0.00054346, -0.0005002, -0.00044636, -0.00038265, -0.00031122, -0.00023516, -0.00015715, -7.8609e-05, -2.2953e-09, 7.8605e-05, 0.00015714, 0.00023515, 0.00031122, 0.00038265, 0.00044635, 0.0005002, 0.00054346, 0.00057622, 0.00059882, 0.00061181, 0.00061602, 0.00061182, 0.00059882, 0.00057623, 0.00054346, 0.0005002]}],
             "3": [{"voltage_dpsi": [6.19601, 6.01926, 5.64672, 5.20807, 4.64101, 3.82704, 2.83086, 1.75627, 0.67645, -0.31084, -1.22597, -2.03996, -2.76816, -3.45404, -4.10878, -4.77759, -5.45876, -6.11606, -6.71946, -7.1725, -7.41691, -7.36647, -7.08919, -6.74187, -6.37346, -6.02129, -5.65, -5.21234, -4.64353, -3.8312, -2.82547, -1.74764, -0.67936, 0.30752, 1.22233, 2.0382, 2.77387, 3.45808, 4.10343, 4.77476, 5.458, 6.11536, 6.72081, 7.17204, 7.41658, 7.36668, 7.08927, 6.74189, 6.37457, 6.199],
                    "flux_k": [-2.396e-09, 7.8604e-05, 0.00015714, 0.00023515, 0.00031122, 0.00038264, 0.00044635, 0.0005002, 0.00054346, 0.00057622, 0.00059881, 0.00061181, 0.00061601, 0.00061181, 0.00059881, 0.00057622, 0.00054346, 0.0005002, 0.00044636, 0.00038265, 0.00031122, 0.00023516, 0.00015715, 7.8611e-05, 3.9866e-09, -7.8603e-05, -0.00015714, -0.00023515, -0.00031122, -0.00038264, -0.00044635, -0.0005002, -0.00054346, -0.00057622, -0.00059881, -0.00061181, -0.00061601, -0.00061181, -0.00059881, -0.00057622, -0.00054347, -0.00050021, -0.00044636, -0.00038265, -0.00031123, -0.00023516, -0.00015715, -7.8616e-05, -4.5503e-09, 7.8602e-05]}]},
            {"1": [{"voltage_dpsi": [-0.13021, 0.13398, 0.63544, 1.07588, 1.43528, 1.76639, 2.12693, 2.50364, 2.89065, 3.27719, 3.63451, 3.89846, 4.01618, 3.97256, 3.81911, 3.6284, 3.43585, 3.256, 3.07992, 2.86525, 2.57751, 2.16822, 1.61886, 1.01051, 0.41958, -0.13092, -0.63389, -1.07351, -1.438, -1.76628, -2.1236, -2.50407, -2.89058, -3.27649, -3.6347, -3.90002, -4.01488, -3.97198, -3.81908, -3.62717, -3.43662, -3.2567, -3.07975, -2.86806, -2.57996, -2.16204, -1.61665, -1.01521, -0.41851, -0.13103],
                    "flux_k": [-0.0002955, -0.000313, -0.0003248, -0.00033141, -0.0003335, -0.00033141, -0.0003248, -0.000313, -0.0002955, -0.00027203, -0.00024254, -0.00020755, -0.00016843, -0.000127, -8.4739e-05, -4.2345e-05, 1.0973e-09, 4.2347e-05, 8.4742e-05, 0.000127, 0.00016843, 0.00020755, 0.00024254, 0.00027203, 0.0002955, 0.000313, 0.0003248, 0.00033141, 0.0003335, 0.00033141, 0.0003248, 0.000313, 0.0002955, 0.00027203, 0.00024254, 0.00020755, 0.00016843, 0.000127, 8.474e-05, 4.2345e-05, -1.1174e-09, -4.2347e-05, -8.4742e-05, -0.000127, -0.00016843, -0.00020755, -0.00024254, -0.00027203, -0.0002955, -0.000313]}],
             "2": [{"voltage_dpsi": [-3.08691, -3.27739, -3.63554, -3.90035, -4.01726, -3.97426, -3.81858, -3.62641, -3.43566, -3.25674, -3.08029, -2.86443, -2.5814, -2.1668, -1.61474, -1.01335, -0.42013, 0.13246, 0.63408, 1.07328, 1.44146, 1.76559, 2.11834, 2.50359, 2.89062, 3.27621, 3.63475, 3.89964, 4.01944, 3.9731, 3.81565, 3.62633, 3.43581, 3.25685, 3.08075, 2.86964, 2.58012, 2.16347, 1.61455, 1.01158, 0.42203, -0.13062, -0.63452, -1.07269, -1.43881, -1.76896, -2.12106, -2.50105, -2.89114, -3.08745],
                    "flux_k": [0.0002955, 0.00027203, 0.00024254, 0.00020755, 0.00016843, 0.000127, 8.4741e-05, 4.2346e-05, -7.953e-10, -4.2347e-05, -8.4742e-05, -0.000127, -0.00016843, -0.00020755, -0.00024254, -0.00027203, -0.0002955, -0.000313, -0.00032481, -0.00033141, -0.0003335, -0.00033141, -0.00032481, -0.000313, -0.0002955, -0.00027203, -0.00024254, -0.00020755, -0.00016843, -0.000127, -8.4741e-05, -4.2346e-05, 4.3288e-10, 4.2347e-05, 8.4742e-05, 0.000127, 0.00016843, 0.00020755, 0.00024254, 0.00027203, 0.0002955, 0.000313, 0.00032481, 0.00033141, 0.0003335, 0.00033141, 0.00032481, 0.000313, 0.0002955, 0.00027203]}],
             "3": [{"voltage_dpsi": [3.34229, 3.25579, 3.0797, 2.86326, 2.58155, 2.16852, 1.61177, 1.01002, 0.41964, -0.1328, -0.63375, -1.07268, -1.43428, -1.76624, -2.12453, -2.50245, -2.89037, -3.27617, -3.63446, -3.89975, -4.01921, -3.97327, -3.81721, -3.62683, -3.43556, -3.25756, -3.08041, -2.86489, -2.5812, -2.16737, -1.61191, -1.00953, -0.41986, 0.13195, 0.63353, 1.06914, 1.43416, 1.769, 2.12468, 2.50287, 2.88933, 3.27515, 3.63472, 3.90184, 4.01901, 3.97065, 3.81767, 3.62879, 3.43505, 3.34368],
                    "flux_k": [-1.4799e-09, 4.2345e-05, 8.4739e-05, 0.000127, 0.00016843, 0.00020755, 0.00024254, 0.00027203, 0.0002955, 0.000313, 0.0003248, 0.00033141, 0.0003335, 0.00033141, 0.0003248, 0.000313, 0.0002955, 0.00027203, 0.00024254, 0.00020755, 0.00016843, 0.000127, 8.4742e-05, 4.2348e-05, 1.6107e-09, -4.2345e-05, -8.4739e-05, -0.000127, -0.00016843, -0.00020755, -0.00024254, -0.00027203, -0.0002955, -0.000313, -0.0003248, -0.00033141, -0.0003335, -0.00033141, -0.0003248, -0.000313, -0.0002955, -0.00027203, -0.00024254, -0.00020755, -0.00016843, -0.00012701, -8.4742e-05, -4.2348e-05, -2.0235e-09, 4.2344e-05]}]}]

    linearForce = [{"displ": [0.0, 1.17, 2.34, 3.51, 4.68, 5.85, 7.019, 8.189, 9.359, 10.529, 11.699, 12.869, 14.039, 15.209, 16.379, 17.549, 18.719, 19.889, 21.058, 22.228, 23.398, 24.568, 25.738, 26.908, 28.078, 29.248, 30.418, 31.588, 32.758, 33.928, 35.097, 36.267, 37.437, 38.607, 39.777, 40.947, 42.117, 43.287, 44.457, 45.627, 46.797, 47.967, 49.136, 50.306, 51.476, 52.646, 53.816, 54.986, 56.156, 57.326],
                    "force_x": [6.699, 6.09, 5.918, 6.376, 7.321, 8.036, 8.02, 7.45, 6.693, 6.086, 5.917, 6.379, 7.325, 8.037, 8.02, 7.449, 6.693, 6.087, 5.917, 6.379, 7.325, 8.036, 8.019, 7.449, 6.692, 6.086, 5.917, 6.379, 7.322, 8.038, 8.021, 7.449, 6.692, 6.087, 5.917, 6.381, 7.323, 8.035, 8.023, 7.449, 6.693, 6.088, 5.917, 6.38, 7.325, 8.036, 8.022, 7.449, 6.692, 6.086]},
                   {"displ": [0.0, 1.258, 2.517, 3.775, 5.033, 6.291, 7.55, 8.808, 10.066, 11.324, 12.583, 13.841, 15.099, 16.358, 17.616, 18.874, 20.132, 21.391, 22.649, 23.907, 25.165, 26.424, 27.682, 28.94, 30.199, 31.457, 32.715, 33.973, 35.232, 36.49, 37.748, 39.006, 40.265, 41.523, 42.781, 44.04, 45.298, 46.556, 47.814, 49.073, 50.331, 51.589, 52.847, 54.106, 55.364, 56.622, 57.881, 59.139, 60.397, 61.655],
                    "force_x": [13.49, 12.14, 11.85, 13.01, 15.0, 16.51, 16.48, 15.21, 13.49, 12.14, 11.85, 13.01, 15.0, 16.52, 16.49, 15.2, 13.48, 12.14, 11.85, 13.01, 15.0, 16.52, 16.48, 15.21, 13.49, 12.14, 11.85, 13.01, 15.0, 16.52, 16.49, 15.2, 13.49, 12.14, 11.85, 13.01, 15.0, 16.52, 16.48, 15.2, 13.48, 12.14, 11.85, 13.01, 15.0, 16.52, 16.48, 15.21, 13.49, 12.14]},
                   {"displ": [0.0, 1.347, 2.693, 4.04, 5.387, 6.733, 8.08, 9.426, 10.773, 12.12, 13.466, 14.813, 16.16, 17.506, 18.853, 20.199, 21.546, 22.893, 24.239, 25.586, 26.933, 28.279, 29.626, 30.973, 32.319, 33.666, 35.012, 36.359, 37.706, 39.052, 40.399, 41.746, 43.092, 44.439, 45.785, 47.132, 48.479, 49.825, 51.172, 52.519, 53.865, 55.212, 56.558, 57.905, 59.252, 60.598, 61.945, 63.292, 64.638, 65.985],
                    "force_x": [6.782, 6.05, 5.939, 6.636, 7.686, 8.425, 8.424, 7.726, 6.779, 6.049, 5.939, 6.636, 7.686, 8.425, 8.422, 7.727, 6.779, 6.05, 5.938, 6.636, 7.687, 8.424, 8.423, 7.727, 6.778, 6.05, 5.939, 6.636, 7.687, 8.427, 8.423, 7.725, 6.778, 6.049, 5.938, 6.636, 7.69, 8.423, 8.423, 7.726, 6.779, 6.05, 5.939, 6.636, 7.69, 8.425, 8.42, 7.727, 6.779, 6.049]}]

    losses = [
        [{"beta": 0.0, "magnetJ": 2.132, "winding": 4.698,
          "stator": {"stfe": {"freq": [1667.0], "hyst": [0,0], "eddy": [1.479,0]}},
          "rotor": {"----": {"freq": [1667.0], "hyst": [0.0,0], "eddy": [0,0]}}}],
        [{"magnetJ": 9.805, "winding": 9.396,
          "stator": {"stfe": {"freq": [1667.0], "hyst": [0.0,0], "eddy": [3.094,0]}},
          "rotor": {"----": {"freq": [1667.0], "hyst": [0.0,0], "eddy": [0,0]}}}],
        [{"magnetJ": 3.027, "winding": 4.698,
          "stator": {"stfe": {"freq": [1667.0], "hyst": [0.0,0], "eddy": [1.691,0]}},
          "rotor": {"----": {"freq": [1667.0], "hyst": [0.0,0], "eddy": [0,0]}}}]
    ]
    lossPar = { 'hf': (1,1), 'ef': (1,1)}
    return [
        {"flux": flux[0], "linearForce": [linearForce[0]], "losses": losses[0], "lossPar": lossPar},
        {"flux": flux[1], "linearForce": [linearForce[1]], "losses": losses[1], "lossPar": lossPar},
        {"flux": flux[2], "linearForce": [linearForce[2]], "losses": losses[2], "lossPar": lossPar}]

def test_process(bch):
    num_slots = 24
    poles = 16
    inner_diam = 143e-3
    outer_diam = 164.6e-3
    num_slices = 3
    lfe = femagtools.machine.afpm.get_arm_lengths(
        outer_diam, inner_diam, num_slices)
    pole_width = femagtools.machine.afpm.get_pole_widths(
        outer_diam, inner_diam, poles, num_slices)

    machine = {'afmtype': "S1R1",
               'poles': poles,
               'outer_diam': outer_diam,
               'inner_diam': inner_diam,
               'stator': {'num_slots': num_slots,
                          'afm_stator': {
                              "slot_height": 0.023,
                              "slot_width": 0.008}
                          },
               'windings':{
                   "num_phases": 3,
                   "num_layers": 2,
                   "num_wires": 7,
                   "cufilfact": 0.45,
                   "culength": 1.4,
                   "num_par_wdgs": 1}}

    r = femagtools.machine.afpm.process(lfe, pole_width, machine, bch)
    assert pytest.approx(r['r1'], abs=1e-3) == 0.03159
    assert pytest.approx(np.mean(r['torque']), abs=0.1) == 17.5
    assert pytest.approx(
        sum([r['plfe'][k] for k in r['plfe']]), abs=0.01) == 6.264
    assert pytest.approx(np.mean(r['plmag']), abs=0.01) == 14.96
    assert pytest.approx(np.mean(r['plcu']), abs=0.1) == 925.6
