{% load static %}
<div id="smart-video-container" class="smart-video-player" style="position: relative; max-width: 960px; margin: 0 auto;">
  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –≤–∏–¥–µ–æ–ø–ª–µ–µ—Ä -->
  <video id="smart-video" controls playsinline
         style="width: 100%; background: #000;"
         poster="{{ poster_url }}">
    <source src="{{ video_url }}" type="video/mp4">
    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
  </video>

  <!-- –û–≤–µ—Ä–ª–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
  <div id="loading-overlay" style="
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    z-index: 10;
  ">
    <div class="loading-content">
      <div class="spinner" style="
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 30px; height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      "></div>
      <div id="loading-text">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–∏–¥–µ–æ...</div>
      <div id="loading-progress" style="margin-top: 10px; font-size: 14px; opacity: 0.8;"></div>
    </div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–æ–º -->
  <div id="quality-controls" style="
    position: absolute;
    top: 10px; right: 10px;
    background: rgba(0,0,0,0.7);
    border-radius: 5px;
    padding: 8px;
    color: white;
    font-size: 12px;
    z-index: 5;
  ">
    <div style="margin-bottom: 5px;">
      <label>–ö–∞—á–µ—Å—Ç–≤–æ:</label>
      <select id="quality-selector" style="margin-left: 5px; background: rgba(255,255,255,0.9);">
        <option value="auto">–ê–≤—Ç–æ</option>
      </select>
    </div>
    <div>
      <label>–§–æ—Ä–º–∞—Ç:</label>
      <select id="format-selector" style="margin-left: 5px; background: rgba(255,255,255,0.9);">
        {% if dash_url %}<option value="dash">DASH</option>{% endif %}
        {% if hls_url %}<option value="hls">HLS</option>{% endif %}
        {% if video_url %}<option value="mp4">MP4</option>{% endif %}
      </select>
    </div>
  </div>

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
  <div id="video-stats" style="
    position: absolute;
    bottom: 60px; left: 10px;
    background: rgba(0,0,0,0.7);
    border-radius: 5px;
    padding: 8px;
    color: white;
    font-size: 11px;
    z-index: 5;
    min-width: 200px;
    display: none;
  ">
    <div><strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong></div>
    <div>–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: <span id="stat-resolution">-</span></div>
    <div>–ë–∏—Ç—Ä–µ–π—Ç: <span id="stat-bitrate">-</span></div>
    <div>–ë—É—Ñ–µ—Ä: <span id="stat-buffer">-</span></div>
    <div>–ü–æ—Ç–µ—Ä—è–Ω–æ –∫–∞–¥—Ä–æ–≤: <span id="stat-dropped">0</span></div>
    <div>–°–µ—Ç—å: <span id="stat-network">-</span></div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
  <button id="stats-toggle" style="
    position: absolute;
    bottom: 10px; left: 10px;
    background: rgba(0,0,0,0.7);
    border: none;
    color: white;
    padding: 5px 8px;
    border-radius: 3px;
    font-size: 11px;
    cursor: pointer;
    z-index: 5;
  ">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>

  <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
  <div id="notifications" style="
    position: absolute;
    top: 50px; right: 10px;
    z-index: 15;
    max-width: 300px;
  "></div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.notification {
  background: rgba(52, 152, 219, 0.9);
  color: white;
  padding: 10px;
  border-radius: 5px;
  margin-bottom: 5px;
  animation: slideIn 0.3s ease;
}

.notification.error {
  background: rgba(231, 76, 60, 0.9);
}

.notification.success {
  background: rgba(46, 204, 113, 0.9);
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.smart-video-player:fullscreen #quality-controls,
.smart-video-player:fullscreen #stats-toggle {
  z-index: 2147483647;
}
</style>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>

<script>
class SmartVideoPlayer {
  constructor(options) {
    this.options = {
      hlsUrl: "{{ hls_url }}",
      dashUrl: "{{ dash_url }}",
      videoUrl: "{{ video_url }}",
      pollInterval: "{{ poll_interval|default:5000 }}",
      analyticsEndpoint: "{{ analytics_endpoint }}",
      ...options
    };

    this.video = document.getElementById('smart-video');
    this.player = null;
    this.currentFormat = null;
    this.stats = {};
    this.analytics = {
      startTime: Date.now(),
      totalWatchTime: 0,
      qualityChanges: 0,
      bufferEvents: 0,
      errors: []
    };

    this.init();
  }

  init() {
    this.setupEventListeners();
    this.startPollingForContent();
    this.detectOptimalFormat();
  }

  setupEventListeners() {
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–æ–º
    document.getElementById('quality-selector').addEventListener('change', (e) => {
      this.changeQuality(e.target.value);
    });

    document.getElementById('format-selector').addEventListener('change', (e) => {
      this.changeFormat(e.target.value);
    });

    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    document.getElementById('stats-toggle').addEventListener('click', () => {
      this.toggleStats();
    });

    // –°–æ–±—ã—Ç–∏—è –≤–∏–¥–µ–æ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    this.video.addEventListener('play', () => this.trackEvent('play'));
    this.video.addEventListener('pause', () => this.trackEvent('pause'));
    this.video.addEventListener('ended', () => this.trackEvent('ended'));
    this.video.addEventListener('error', (e) => this.trackError(e));
    this.video.addEventListener('waiting', () => this.trackEvent('buffer_start'));
    this.video.addEventListener('playing', () => this.trackEvent('buffer_end'));

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    setInterval(() => this.updateStats(), 1000);

    // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    if ('connection' in navigator) {
      navigator.connection.addEventListener('change', () => {
        this.adaptToConnection();
      });
    }
  }

  async startPollingForContent() {
    const showLoadingScreen = () => {
      document.getElementById('loading-overlay').style.display = 'flex';
    };

    const hideLoadingScreen = () => {
      document.getElementById('loading-overlay').style.display = 'none';
    };

    // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    if (this.options.hlsUrl || this.options.dashUrl || this.options.videoUrl) {
      hideLoadingScreen();
      return;
    }

    showLoadingScreen();

    // –û–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    const pollForReady = async () => {
      try {
        const response = await fetch(`/api/video-status/${this.options.videoId}/`);
        const data = await response.json();

        document.getElementById('loading-progress').textContent =
          `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${data.qualities_ready || 0} –∫–∞—á–µ—Å—Ç–≤`;

        if (data.status === 'ready' && data.hls_url) {
          this.options.hlsUrl = data.hls_url;
          this.options.dashUrl = data.dash_url;
          hideLoadingScreen();
          this.initPlayer();
          return;
        }

        if (data.status === 'preview_ready' && data.hls_url) {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –∫–∞—á–µ—Å—Ç–≤–æ
          this.options.hlsUrl = data.hls_url;
          hideLoadingScreen();
          this.initPlayer();
          this.showNotification('–ü—Ä–µ–≤—å—é –≥–æ—Ç–æ–≤–æ. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è...', 'success');

          // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω—ã—Ö –∫–∞—á–µ—Å—Ç–≤
          setTimeout(pollForReady, this.options.pollInterval);
          return;
        }

        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–ø—Ä–æ—Å
        setTimeout(pollForReady, this.options.pollInterval);

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞:', error);
        this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ', 'error');
        hideLoadingScreen();
      }
    };

    pollForReady();
  }

  detectOptimalFormat() {
    const connection = navigator.connection;
    let preferredFormat = 'hls'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é HLS

    if (connection) {
      // DASH –ª—É—á—à–µ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
      if (connection.effectiveType === '4g' && connection.downlink > 5) {
        preferredFormat = 'dash';
      }
      // HLS –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
      else if (connection.effectiveType === '3g' || connection.downlink < 2) {
        preferredFormat = 'hls';
      }
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –±—Ä–∞—É–∑–µ—Ä–æ–º
    if (preferredFormat === 'dash' && !this.supportsDash()) {
      preferredFormat = 'hls';
    }
    if (preferredFormat === 'hls' && !this.supportsHls()) {
      preferredFormat = 'mp4';
    }

    document.getElementById('format-selector').value = preferredFormat;
    this.changeFormat(preferredFormat);
  }

  initPlayer() {
    const format = document.getElementById('format-selector').value;
    this.changeFormat(format);
  }

  changeFormat(format) {
    this.cleanup();
    this.currentFormat = format;

    switch(format) {
      case 'hls':
        this.initHLS();
        break;
      case 'dash':
        this.initDASH();
        break;
      case 'mp4':
        this.initMP4();
        break;
    }

    this.analytics.qualityChanges++;
  }

  initHLS() {
    if (!this.options.hlsUrl) return;

    if (Hls.isSupported()) {
      this.player = new Hls({
        startLevel: -1, // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞
        capLevelToPlayerSize: true,
        maxBufferLength: 60
      });

      this.player.loadSource(this.options.hlsUrl);
      this.player.attachMedia(this.video);

      this.player.on(Hls.Events.MANIFEST_PARSED, () => {
        this.populateQualityOptions();
      });

      this.player.on(Hls.Events.LEVEL_SWITCHED, (event, data) => {
        this.updateCurrentQuality(data.level);
      });

      this.player.on(Hls.Events.ERROR, (event, data) => {
        this.handlePlayerError('HLS', data);
      });

    } else if (this.video.canPlayType('application/vnd.apple.mpegurl')) {
      // Safari –Ω–∞—Ç–∏–≤–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
      this.video.src = this.options.hlsUrl;
    }
  }

  initDASH() {
    if (!this.options.dashUrl || !this.supportsDash()) return;

    this.player = dashjs.MediaPlayer().create();
    this.player.initialize(this.video, this.options.dashUrl, true);

    this.player.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, () => {
      this.populateQualityOptions();
    });

    this.player.on(dashjs.MediaPlayer.events.QUALITY_CHANGE_RENDERED, (e) => {
      if (e.mediaType === 'video') {
        this.updateCurrentQuality(e.newQuality);
      }
    });
  }

  initMP4() {
    if (!this.options.videoUrl) return;
    this.video.src = this.options.videoUrl;

    // –î–ª—è MP4 –Ω–µ—Ç –≤—ã–±–æ—Ä–∞ –∫–∞—á–µ—Å—Ç–≤–∞
    const selector = document.getElementById('quality-selector');
    selector.innerHTML = '<option value="original">–û—Ä–∏–≥–∏–Ω–∞–ª</option>';
  }

  populateQualityOptions() {
    const selector = document.getElementById('quality-selector');
    selector.innerHTML = '<option value="auto">–ê–≤—Ç–æ</option>';

    let qualities = [];

    if (this.currentFormat === 'hls' && this.player && this.player.levels) {
      qualities = this.player.levels.map((level, i) => ({
        index: i,
        height: level.height || '?',
        bitrate: Math.round(level.bitrate/1000) || '?'
      }));
    } else if (this.currentFormat === 'dash' && this.player) {
      const bitrateList = this.player.getBitrateInfoListFor('video');
      qualities = bitrateList.map(bitrate => ({
        index: bitrate.qualityIndex,
        height: bitrate.height,
        bitrate: Math.round(bitrate.bitrate/1000)
      }));
    }

    qualities.forEach(quality => {
      const option = document.createElement('option');
      option.value = quality.index;
      option.text = `${quality.height}p (${quality.bitrate}k)`;
      selector.appendChild(option);
    });
  }

  changeQuality(qualityIndex) {
    if (qualityIndex === 'auto') {
      if (this.currentFormat === 'hls' && this.player) {
        this.player.currentLevel = -1;
      } else if (this.currentFormat === 'dash' && this.player) {
        this.player.setAutoSwitchQualityFor('video', true);
      }
    } else {
      const index = parseInt(qualityIndex);
      if (this.currentFormat === 'hls' && this.player) {
        this.player.currentLevel = index;
      } else if (this.currentFormat === 'dash' && this.player) {
        this.player.setAutoSwitchQualityFor('video', false);
        this.player.setQualityFor('video', index);
      }
    }

    this.analytics.qualityChanges++;
  }

  adaptToConnection() {
    const connection = navigator.connection;
    if (!connection) return;

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏
    let targetQuality = 'auto';

    if (connection.effectiveType === '2g' || connection.downlink < 0.5) {
      // –°–∞–º–æ–µ –Ω–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
      targetQuality = '0';
    } else if (connection.effectiveType === '3g' || connection.downlink < 2) {
      // –°—Ä–µ–¥–Ω–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ
      targetQuality = '1';
    }

    if (targetQuality !== 'auto') {
      this.changeQuality(targetQuality);
      this.showNotification(`–ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–µ–Ω–æ –∏–∑-–∑–∞ –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è`, 'info');
    }
  }

  updateStats() {
    const video = this.video;

    // –ë–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    this.stats = {
      resolution: video.videoWidth && video.videoHeight ?
        `${video.videoWidth}x${video.videoHeight}` : '-',

      buffer: video.buffered.length > 0 ?
        `${(video.buffered.end(video.buffered.length-1) - video.currentTime).toFixed(1)}s` : '0s',

      network: navigator.connection ?
        `${navigator.connection.effectiveType} (${navigator.connection.downlink}Mbps)` : '-'
    };

    // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –¥–ª—è –ø–ª–µ–µ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    if (this.currentFormat === 'hls' && this.player && this.player.stats) {
      const stats = this.player.stats;
      this.stats.bitrate = `${Math.round(stats.bandwidth/1000)}k`;
      this.stats.dropped = stats.droppedFrames || 0;
    } else if (this.currentFormat === 'dash' && this.player) {
      const dashMetrics = this.player.getDashMetrics();
      if (dashMetrics) {
        this.stats.bitrate = `${Math.round(this.player.getAverageThroughput('video')/1000)}k`;
      }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    this.updateStatsDisplay();
  }

  updateStatsDisplay() {
    document.getElementById('stat-resolution').textContent = this.stats.resolution || '-';
    document.getElementById('stat-bitrate').textContent = this.stats.bitrate || '-';
    document.getElementById('stat-buffer').textContent = this.stats.buffer || '-';
    document.getElementById('stat-dropped').textContent = this.stats.dropped || '0';
    document.getElementById('stat-network').textContent = this.stats.network || '-';
  }

  toggleStats() {
    const panel = document.getElementById('video-stats');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  }

  showNotification(message, type = 'info') {
    const container = document.getElementById('notifications');
    const notification = document.createElement('div');

    notification.className = `notification ${type}`;
    notification.textContent = message;

    container.appendChild(notification);

    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 5000);
  }

  trackEvent(eventType) {
    const event = {
      type: eventType,
      timestamp: Date.now(),
      currentTime: this.video.currentTime,
      quality: this.getCurrentQuality(),
      format: this.currentFormat
    };

    this.analytics[eventType] = (this.analytics[eventType] || 0) + 1;

    if (eventType === 'buffer_start') {
      this.analytics.bufferEvents++;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    this.sendAnalytics(event);
  }

  trackError(error) {
    const errorData = {
      type: 'error',
      message: error.message || 'Unknown error',
      timestamp: Date.now(),
      format: this.currentFormat
    };

    this.analytics.errors.push(errorData);
    this.sendAnalytics(errorData);
    this.showNotification('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ', 'error');
  }

  sendAnalytics(data) {
    if (!this.options.analyticsEndpoint) return;

    // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º UI, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
    setTimeout(() => {
      fetch(this.options.analyticsEndpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          video_id: this.options.videoId,
          session_id: this.options.sessionId,
          ...data
        })
      }).catch(() => {}); // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    }, 0);
  }

  getCurrentQuality() {
    const selector = document.getElementById('quality-selector');
    return selector.value;
  }

  supportsHls() {
    return Hls.isSupported() || this.video.canPlayType('application/vnd.apple.mpegurl');
  }

  supportsDash() {
    return typeof dashjs !== 'undefined' && dashjs.supportsMediaSource();
  }

  handlePlayerError(playerType, error) {
    console.error(`${playerType} Error:`, error);
    this.trackError(error);

    // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
    if (error.fatal) {
      this.showNotification(`–û—à–∏–±–∫–∞ ${playerType}. –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞...`, 'error');
      this.tryFallbackFormat();
    }
  }

  tryFallbackFormat() {
    const currentFormat = this.currentFormat;

    if (currentFormat === 'dash' && this.options.hlsUrl) {
      this.changeFormat('hls');
    } else if (currentFormat === 'hls' && this.options.videoUrl) {
      this.changeFormat('mp4');
    } else if (currentFormat === 'mp4' && this.options.dashUrl) {
      this.changeFormat('dash');
    }
  }

  cleanup() {
    if (this.player && typeof this.player.destroy === 'function') {
      this.player.destroy();
    }
    this.player = null;
    this.video.src = '';
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–ª–µ–µ—Ä
document.addEventListener('DOMContentLoaded', () => {
  window.smartPlayer = new SmartVideoPlayer({
    videoId: "{{ video_id }}",
    sessionId: "{{ session_id|default:'anonymous' }}"
  });
});
</script>
