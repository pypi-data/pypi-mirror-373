Metadata-Version: 2.1
Name: maas-backoff-scheduler
Version: 1.1.9
Summary: åŸºäºRedisçš„ä»»åŠ¡é€€é¿é‡è¯•æ¡†æ¶ï¼Œæ”¯æŒå¤šç§é€€é¿ç­–ç•¥
Home-page: https://github.com/xiaofucoding/maas-backoff-scheduler.git/
Author: xinzf
Author-email: 515361725@qq.com
License: MIT
Project-URL: Source, https://github.com/yourusername/task-backoff-scheduler
Project-URL: Documentation, https://github.com/yourusername/task-backoff-scheduler#readme
Project-URL: Bug Reports, https://github.com/yourusername/task-backoff-scheduler/issues
Keywords: task retry backoff redis queue
Platform: UNKNOWN
Classifier: Development Status :: 4 - Beta
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.7
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Requires-Python: >=3.7
Description-Content-Type: text/markdown
Requires-Dist: redis (>=4.0.0)
Requires-Dist: PyYAML (>=6.0)
Requires-Dist: dataclasses (>=0.6) ; python_version < "3.7"
Provides-Extra: dev
Requires-Dist: pytest (>=6.0.0) ; extra == 'dev'
Requires-Dist: pytest-cov (>=2.0.0) ; extra == 'dev'
Requires-Dist: black (>=21.0.0) ; extra == 'dev'
Requires-Dist: flake8 (>=3.8.0) ; extra == 'dev'
Requires-Dist: mypy (>=0.800) ; extra == 'dev'

# MaaS ä»»åŠ¡é€€é¿é‡è¯•æ¡†æ¶

[![Python](https://img.shields.io/badge/Python-3-blue.svg)](https://www.python.org/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

ä¸€ä¸ªåŸºäºRedisçš„åˆ†å¸ƒå¼ä»»åŠ¡é€€é¿é‡è¯•ã€è°ƒåº¦æ¡†æ¶ï¼Œæ”¯æŒå¤šç§é€€é¿ç­–ç•¥å’Œå¹¶å‘æ‰§è¡Œã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- ğŸ”„ **å¤šç§é€€é¿ç­–ç•¥**: å›ºå®šé—´éš”ã€æŒ‡æ•°é€€é¿ã€çº¿æ€§é€€é¿
- ğŸš€ **é«˜å¹¶å‘æ‰§è¡Œ**: æ”¯æŒçº¿ç¨‹æ± /è¿›ç¨‹æ± å¹¶å‘å¤„ç†
- ğŸ“Š **ä»»åŠ¡ä¼˜å…ˆçº§**: æ”¯æŒä»»åŠ¡ä¼˜å…ˆçº§ç®¡ç†
- â±ï¸ **è¶…æ—¶æ§åˆ¶**: ä»»åŠ¡æ‰§è¡Œè¶…æ—¶å’Œå¤±è´¥å¤„ç†
- ğŸ“ˆ **çŠ¶æ€ç›‘æ§**: å®Œæ•´çš„ä»»åŠ¡çŠ¶æ€ç®¡ç†å’Œç›‘æ§
- ğŸ¯ **çµæ´»è°ƒåº¦**: å¯é…ç½®çš„å®šæ—¶è°ƒåº¦é—´éš”
- ğŸ”’ **åˆ†å¸ƒå¼é”**: åŸºäºRedisçš„åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—

## ğŸ“¦ å®‰è£…

```bash
pip install maas-backoff-scheduler
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ä½¿ç”¨ç¤ºä¾‹

```python
from backoff.scheduler.backoff_scheduler import (
    TaskBackoffScheduler,
    TaskBackoffConfig,
    TaskEntity,
    TaskConfig,
    StorageConfig,
    ThreadPoolConfig,
    SchedulerConfig,
    ResultEntity,
)

# 1. åˆ›å»ºé…ç½®
config = TaskBackoffConfig()

# Rediså­˜å‚¨é…ç½®
config.storage = StorageConfig(
    type="redis", 
    host="localhost", 
    port=6379, 
    database=0, 
    password=""
)

# ä»»åŠ¡é…ç½®
config.task = TaskConfig(
    biz_prefix="my_service",
    batch_size=10,
    max_retry_count=3,
    backoff_strategy="exponential",
    backoff_interval=30,
    backoff_multiplier=2.0,
    min_gpu_memory_gb=0.5,
    min_gpu_utilization=10
)

# çº¿ç¨‹æ± é…ç½®
config.threadpool = ThreadPoolConfig(
    concurrency=5, 
    exec_timeout=300, 
    proc_mode="process"
)

# è°ƒåº¦å™¨é…ç½®
config.scheduler = SchedulerConfig(interval=10)

# 2. åˆ›å»ºè°ƒåº¦å™¨
scheduler = TaskBackoffScheduler(config)

# 3. å®šä¹‰ä»»åŠ¡å¤„ç†å™¨
def task_handler(task: TaskEntity):
    # æ‚¨çš„ä¸šåŠ¡é€»è¾‘
    print(f"å¤„ç†ä»»åŠ¡: {task.task_id}")
    return ResultEntity.ok(
        result={"status": "success", "data": "å¤„ç†å®Œæˆ"},
        task_id=task.task_id,
    )

def exception_handler(task: TaskEntity):
    # å¼‚å¸¸å¤„ç†é€»è¾‘
    return ResultEntity.fail(
        code=-1,
        message="ä»»åŠ¡æ‰§è¡Œå¤±è´¥",
        task_id=task.task_id,
    )

# 4. æ³¨å†Œå¤„ç†å™¨
scheduler.set_custom_task_handler(task_handler)

scheduler.set_custom_task_exception_handler(exception_handler)

# 5. å¯åŠ¨è°ƒåº¦å™¨
scheduler.start()
```

## ğŸ“š API å‚è€ƒ

### å¤„ç†å™¨ç®¡ç†

é€šè¿‡æ³¨å†Œè‡ªå®šä¹‰å¤„ç†å™¨æ¥å¤„ç†ä¸šåŠ¡é€»è¾‘å’Œå¼‚å¸¸æƒ…å†µï¼š

```python
# æ³¨å†Œä»»åŠ¡å¤„ç†å™¨ï¼ˆå¿…é¡»ï¼‰
scheduler.set_custom_task_handler(task_handler)

# æ³¨å†Œå¼‚å¸¸å¤„ç†å™¨ï¼ˆå¯é€‰ï¼‰
scheduler.set_custom_task_exception_handler(exception_handler)
```

#### å¤„ç†å™¨å‡½æ•°ç­¾å

```python

from backoff.scheduler.backoff_scheduler import (
    TaskEntity,
    ResultEntity,
)
def task_handler(task: TaskEntity) -> ResultEntity:
    # æ‚¨çš„ä¸šåŠ¡é€»è¾‘
    pass

def exception_handler(task: TaskEntity) -> ResultEntity:
    # å¼‚å¸¸å¤„ç†é€»è¾‘
    pass
```

#### è¿”å›å€¼ç¤ºä¾‹

**æˆåŠŸå¤„ç†:**

```python

from backoff.scheduler.backoff_scheduler import (
    TaskEntity,
    ResultEntity,
)

return ResultEntity.ok(
    result={"status": "success", "data": "å¤„ç†ç»“æœ"},
    task_id=task.task_id,
)
```

**å¤±è´¥å¤„ç†:**
```python
return ResultEntity.fail(
    code=-1,
    message="ä»»åŠ¡æ‰§è¡Œå¤±è´¥",
    result={"error": "å…·ä½“é”™è¯¯ä¿¡æ¯"},
    task_id=task.task_id,
)
```

#### å¤„ç†å™¨è¯´æ˜

- **ä»»åŠ¡å¤„ç†å™¨** (`set_custom_task_handler`): å¿…é¡»è®¾ç½®ï¼Œå¤„ç†æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘
- **å¼‚å¸¸å¤„ç†å™¨** (`set_custom_task_exception_handler`): å¯é€‰è®¾ç½®ï¼Œå¤„ç†ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å¼‚å¸¸æƒ…å†µ

### ä»»åŠ¡ç®¡ç†

```python
# åˆ›å»ºä»»åŠ¡
task_id = scheduler.create_task(
    task_params={"key": "value"},
    task_id="unique_task_id"
)

# æŸ¥è¯¢ä»»åŠ¡
task = scheduler.get_task(task_id)

# æ’¤é”€ä»»åŠ¡ï¼ˆä»…é™pendingçŠ¶æ€ï¼‰
success = scheduler.cancel_task(task_id)

# è·å–é˜Ÿåˆ—ç»Ÿè®¡
stats = scheduler.get_queue_stats()
```

### ä»»åŠ¡çŠ¶æ€ç®¡ç†

```python
# æ ‡è®°ä»»åŠ¡å®Œæˆ
scheduler.mark_task_completed(task_id, "æ‰§è¡Œç»“æœ")

# æ ‡è®°ä»»åŠ¡å¤±è´¥
scheduler.mark_task_failed(task_id, "å¤±è´¥åŸå› ")

# æ ‡è®°ä»»åŠ¡å¤„ç†ä¸­
scheduler.mark_task_processing(task_id)

# æ›´æ–°ä»»åŠ¡è¿›åº¦
scheduler.update_task_progress(task_id, 75)  # 75%
```

### è°ƒåº¦å™¨æ§åˆ¶

```python
# å¯åŠ¨è°ƒåº¦å™¨
scheduler.start()

# å…³é—­è°ƒåº¦å™¨
scheduler.shutdown()
```

## âš™ï¸ é…ç½®è¯¦è§£

### StorageConfig (å­˜å‚¨é…ç½®)

| å‚æ•°     | ç±»å‹   | å¿…å¡« | é»˜è®¤å€¼    | è¯´æ˜           |
|----------|--------|------|-----------|----------------|
| type     | string | æ˜¯   | redis     | å­˜å‚¨ç±»å‹ï¼Œç›®å‰ä»…æ”¯æŒRedis      |
| host     | string | æ˜¯   | -         | Redisä¸»æœºåœ°å€  |
| port     | int    | æ˜¯   | 6379      | Redisç«¯å£      |
| database | int    | å¦   | 0         | Redisæ•°æ®åº“    |
| password | string | å¦   | ""        | Rediså¯†ç       |

### TaskConfig (ä»»åŠ¡é…ç½®)

| å‚æ•°                | ç±»å‹   | å¿…å¡« | é»˜è®¤å€¼        | è¯´æ˜                    |
|---------------------|--------|------|---------------|-------------------------|
| biz_prefix          | string | æ˜¯   | -             | ä¸šåŠ¡å‰ç¼€                |
| max_retry_count     | int    | å¦   | 3             | æœ€å¤§é‡è¯•æ¬¡æ•°            |
| backoff_strategy    | string | å¦   | exponential   | é€€é¿ç­–ç•¥                |
| backoff_interval    | int    | å¦   | 30            | åˆå§‹é€€é¿é—´éš”(ç§’)        |
| backoff_multiplier  | float  | å¦   | 2.0           | é€€é¿å€æ•°                |
| batch_size          | int    | å¦   | 100           | æ‰¹æ¬¡å¤§å°                |
| min_gpu_memory_gb   | float  | å¦   | 0             | æœ€å°GPUå†…å­˜(GB)         |
| min_gpu_utilization | int    | å¦   | 0             | æœ€å°GPUåˆ©ç”¨ç‡(%)        |

**é€€é¿ç­–ç•¥è¯´æ˜:**
- `fixed`: å›ºå®šé—´éš”é‡è¯•
- `exponential`: æŒ‡æ•°é€€é¿ (é»˜è®¤)
- `linear`: çº¿æ€§é€€é¿

### ThreadPoolConfig (çº¿ç¨‹æ± é…ç½®)

| å‚æ•°          | ç±»å‹   | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜                    |
|---------------|--------|------|--------|-------------------------|
| concurrency   | int    | å¦   | 10     | å¹¶å‘çº¿ç¨‹/è¿›ç¨‹æ•°         |
| proc_mode     | string | å¦   | thread | æ‰§è¡Œæ¨¡å¼                |
| exec_timeout  | int    | å¦   | 300    | ä»»åŠ¡è¶…æ—¶æ—¶é—´(ç§’)        |

**æ‰§è¡Œæ¨¡å¼è¯´æ˜:**
- `thread`: çº¿ç¨‹æ± æ¨¡å¼ (é€‚åˆIOå¯†é›†å‹ä»»åŠ¡)
- `process`: è¿›ç¨‹æ± æ¨¡å¼ (é€‚åˆCPUå¯†é›†å‹ä»»åŠ¡ï¼Œé»˜è®¤)

### SchedulerConfig (è°ƒåº¦å™¨é…ç½®)

| å‚æ•°     | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜           |
|----------|------|------|--------|----------------|
| interval | int  | å¦   | 10     | è½®è¯¢é—´éš”(ç§’)   |

## ğŸ”§ é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰é€€é¿ç­–ç•¥

```python
# æŒ‡æ•°é€€é¿ç¤ºä¾‹
config.task.backoff_strategy = "exponential"
config.task.backoff_interval = 30  # åˆå§‹30ç§’
config.task.backoff_multiplier = 2.0  # æ¯æ¬¡ç¿»å€

# é‡è¯•é—´éš”: 30s â†’ 60s â†’ 120s â†’ 240s
```

### GPUèµ„æºç®¡ç†

```python
# é…ç½®GPUèµ„æºè¦æ±‚
config.task.min_gpu_memory_gb = 4.0  # éœ€è¦4GBæ˜¾å­˜
config.task.min_gpu_utilization = 20  # GPUåˆ©ç”¨ç‡ä½äº20%æ‰æ‰§è¡Œ
```

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### è·å–é˜Ÿåˆ—çŠ¶æ€

```python
stats = scheduler.get_queue_stats()
print(f"å¾…å¤„ç†ä»»åŠ¡: {stats.pending_count}")
print(f"å¤„ç†ä¸­ä»»åŠ¡: {stats.processing_count}")
print(f"å·²å®Œæˆä»»åŠ¡: {stats.completed_count}")
print(f"å¤±è´¥ä»»åŠ¡: {stats.failed_count}")
```

### ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢

```python
task = scheduler.get_task(task_id)
print(f"ä»»åŠ¡ID: {task.task_id}")
print(f"çŠ¶æ€: {task.status}")
print(f"é‡è¯•æ¬¡æ•°: {task.retry_count}")
print(f"ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´: {task.next_execute_time}")
```



