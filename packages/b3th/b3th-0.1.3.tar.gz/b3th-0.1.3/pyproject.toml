############################
# Build system
############################
[build-system]
requires = ["poetry-core>=1.6.0"]
build-backend = "poetry.core.masonry.api"

############################
# Project metadata
############################
[tool.poetry]
name = "b3th"
version = "0.1.3"
description = "CLI that auto-generates commit messages and GitHub PR descriptions"
authors = ["Bethvour <bethvourc@gmail.com>"]
license = "MIT"
readme = "README.md"
homepage = "https://github.com/bethvourc/b3th"
repository = "https://github.com/bethvourc/b3th"
keywords = ["git", "cli", "commit", "pull-request", "ai", "groq"]

[tool.poetry.urls]
"Bug Tracker" = "https://github.com/bethvourc/b3th/issues"
"Source"      = "https://github.com/bethvourc/b3th"

############################
# Runtime dependencies
############################
[tool.poetry.dependencies]
python = ">=3.9,<4.0"
typer  = "^0.12"
click  = ">=8.1.4,<9"
requests = "^2.32"
python-dotenv = "^1.0"

############################
# Development / tooling dependencies
############################
[tool.poetry.group.dev.dependencies]
pytest      = "^8.2"
pytest-cov  = "^5.0"
coverage    = "^7.5"
black       = "^24.4"
ruff        = "^0.4"
pre-commit  = "^3.7"

############################
# CLI entry point
############################
[tool.poetry.scripts]
b3th = "b3th.cli:app"

############################
# Black formatting
############################
[tool.black]
line-length = 88
target-version = ["py39", "py310", "py311", "py312"]
include = '\.pyi?$'
exclude = '''
/(
    \.git
  | \.venv
  | venv
  | build
  | dist
  | __pypackages__
  | \.pytest_cache
)/
'''

############################
# Ruff linting (new schema)
############################
[tool.ruff]
line-length = 88
target-version = "py39"
# Only exclude build artifacts/venvs; everything else (b3th/, tests/) is checked.
exclude = ["build", "dist", ".venv", "venv"]

[tool.ruff.lint]
# Keep these rulesets; let Black handle line length.
select = ["E", "F", "B", "I", "UP", "S", "A", "C4"]
ignore = ["E501"]

[tool.ruff.lint.per-file-ignores]
# Allow subprocess/partial exec patterns in these modules.
"b3th/gh_api.py"         = ["S603", "S607"]
"b3th/git_utils.py"      = ["S603", "S607"]
"b3th/pr_description.py" = ["S603", "S607"]
# cli ergonomics: Typer-style Argument defaults & layered exception style
"b3th/cli.py"            = ["B008", "B904", "E402"]
# tests: allow asserts everywhere; and subprocess flags in git_utils tests
"tests/**/*.py"          = ["S101"]
"tests/test_git_utils.py"= ["S603", "S607"]

############################
# Pytest: enforce coverage on every run
############################
[tool.pytest.ini_options]
# Run tests with coverage by default and fail under 85%.
addopts = [
  "--cov=b3th",
  "--cov-report=term-missing",
  "--cov-fail-under=85"
]
testpaths = ["tests"]

############################
# Coverage.py configuration
############################
[tool.coverage.run]
branch = true
source = ["b3th"]
omit = [
  "b3th/llm.py",
]

[tool.coverage.report]
# NOTE: threshold is controlled by pytest addopts (--cov-fail-under)
show_missing = true
skip_covered = true
precision = 1
exclude_lines = [
  "pragma: no cover",
  "if TYPE_CHECKING:",
  "if __name__ == .__main__.:",
  "raise NotImplementedError",
  "except ImportError",
]
