[build-system]
requires = [
    "py-build-cmake~=0.6.0a1",
    "conan~=2.19.1",
    "pybind11-stubgen==2.5.5",
    "numpy>=1.19,<3",
    "scipy>=1.6,<2; implementation_name=='cpython'",
    "mypy>=1.15.0,<1.18",
]
build-backend = "py_build_cmake.build"

[project]
name = "qpalm"
readme = "QPALM/interfaces/python/README.rst"
requires-python = ">=3.9"
license = "LGPL-3.0-or-later"
license-files = ["LICENSE"]
authors = [{ "name" = "Ben Hermans" }]
maintainers = [{ "name" = "Pieter Pas", "email" = "pieter.p.dev@outlook.com" }]
keywords = [
    "optimization",
    "augmented-lagrangian",
    "proximal",
    "qp",
    "quadratic-programming",
    "nonconvex",
    "ladel",
]
classifiers = [
    "Development Status :: 5 - Production/Stable",
    "Topic :: Scientific/Engineering",
    "Topic :: Scientific/Engineering :: Mathematics",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "Programming Language :: Python :: 3.14",
    "Programming Language :: C",
    "Programming Language :: C++",
    "Operating System :: POSIX :: Linux",
    "Operating System :: Microsoft :: Windows",
    "Operating System :: MacOS",
    "Typing :: Typed",
]
dependencies = ["numpy>=1.19,<3", "scipy>=1.6,<2"]
dynamic = ["version", "description"]

[project.optional-dependencies]
debug = ["qpalm-debug==1.2.6"]
test = ["pytest>=7.2.0,<9"]

[project.urls]
Source = "https://github.com/kul-optec/QPALM"
Documentation = "https://kul-optec.github.io/QPALM"
Tracker = "https://github.com/kul-optec/QPALM/issues"

[tool.py-build-cmake.module]
directory = "QPALM/interfaces/python"

[tool.py-build-cmake.sdist]
include = ["CMakeLists.txt", "LADEL", "QPALM", "README.md", "conanfile.py"]

[tool.py-build-cmake.conan.cmake]
minimum_version = "4.1"
source_path = "."
args = ["-Wdev"]
build_type = "Release"
install_components = ["python_modules", "python_stubs"]
[tool.py-build-cmake.conan]
args = [
    "--build=missing",
    "-o&:with_python=True",
    "-c*:tools.build:skip_test=True",
    "-s",
    "compiler.cppstd=23",
]
[tool.py-build-cmake.linux.conan.cmake]
generator = "Ninja Multi-Config"
[tool.py-build-cmake.mac.conan.cmake]
generator = "Ninja Multi-Config"
[tool.py-build-cmake.windows.conan]
args = ['-c*:tools.build:compiler_executables*={"fortran": "FC-NOTFOUND"}']

[tool.py-build-cmake.linux.conan.10.cmake]
build_type = "Release"
[tool.py-build-cmake.linux.conan.20.cmake]
build_type = "Debug"
env = { QPALM_PYTHON_DEBUG = "1" }

[tool.py-build-cmake.mac.conan.10.cmake]
build_type = "Release"
[tool.py-build-cmake.mac.conan.20.cmake]
build_type = "Debug"
env = { QPALM_PYTHON_DEBUG = "1" }

[tool.py-build-cmake.stubgen]
args = ["-v", "--no-import"]
files = ["qpalm/__init__.py"]
packages = []

[tool.py-build-cmake.editable]
mode = "symlink"

# cibuildwheel
[tool.cibuildwheel]
archs = ["auto64"]
skip = "pp311-*"                                               # https://github.com/pypy/pypy/issues/5328
build-frontend = "build"
environment = { PY_BUILD_CMAKE_VERBOSE = "1" }
test-command = "pytest {package}/QPALM/interfaces/python/test"
test-extras = ["test"]
[tool.cibuildwheel.config-settings]
--local = "scripts/ci/py-build-cmake.toml"

[tool.cibuildwheel.macos]
environment = { PY_BUILD_CMAKE_VERBOSE = "1", MACOSX_DEPLOYMENT_TARGET = "10.15" }

[tool.cibuildwheel.pyodide]
archs = ["wasm32"]

[tool.pytest.ini_options]
minversion = "6.0"
testpaths = ["QPALM/interfaces/python/test"]

[tool.mypy]
plugins = ["numpy.typing.mypy_plugin"]

[tool.pyright]
# Pyright stops looking after the first match, which is usually in the 
# site-packages folder. When doing an editable install, it should look in both
# site-packages and the source folder. To get the search order correct, 
# explicitly point it to the source folder first (it will still look for the C++ 
# extension module stubs in site-packages).
extraPaths = ["QPALM/interfaces/python"]
