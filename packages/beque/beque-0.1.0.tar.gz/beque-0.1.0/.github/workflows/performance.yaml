name: Performance Tests

on:
  workflow_dispatch:
  workflow_call:

jobs:
  performance:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-suite: 
          - "large_scale_fifo_ordering_10k"
          - "concurrent_large_scale_fifo" 
          - "high_throughput_performance"
          - "memory_efficiency_large_queue"

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --group dev

      - name: Run performance test - ${{ matrix.test-suite }}
        run: |
          uv run pytest tests/test_performance.py::TestBequePerformance::test_${{ matrix.test-suite }} -v -s \
            --tb=short
        env:
          FORCE_COLOR: 1
        timeout-minutes: 10

      - name: Upload performance logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: performance-logs-${{ matrix.test-suite }}
          path: pytest.log

  stress-tests:
    runs-on: ubuntu-latest
    # Only run stress tests on manual dispatch
    if: github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --group dev

      - name: Run stress tests
        run: |
          uv run pytest tests/test_performance.py::TestBequeStressScenarios -v -s \
            --tb=short
        env:
          FORCE_COLOR: 1
        timeout-minutes: 15

      - name: Upload stress test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stress-test-logs
          path: pytest.log